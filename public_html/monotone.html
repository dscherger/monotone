<html lang="en">
<head>
<link type="text/css" rel="stylesheet" href="texinfo.css" />
<title>monotone documentation</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="monotone documentation">
<meta name="generator" content="makeinfo 4.7">
<link title="Top" rel="top" href="#Top">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc { font-variant:small-caps }
  span.roman { font-family: serif; font-weight: normal; } 
--></style>
</head>
<body>
<h1 class="settitle">monotone documentation</h1>
<a name="Top"></a>

<h2 class="unnumbered">Top</h2>

<p>Monotone Documentation

   <p>Monotone is a distributed version control tool. It can help automate
many tedious and error-prone tasks in group software development.
     <ul>
<li>Store multiple versions of files you are working on efficiently. 
<li>Transmit changes to files between you and your colleagues. 
<li>Merge changes you make with those your colleagues make. 
<li>Make notes about your opinion of the quality of versions of files. 
<li>Make decisions about using or ignoring versions, depending on the notes
you receive from others. 
</ul>

   <p>Please be aware that monotone is a slightly unorthodox version control
tool, and many of its concepts are slightly similar &mdash; but
significantly different &mdash; from concepts with similar names in other
version control tools.

   <p>Complete table of contents

   <div class="contents">
<h2>Table of Contents</h2>
<ul>
<li><a name="toc_Top" href="#Top">Top</a>
<li><a name="toc_Concepts" href="#Concepts">1 Concepts</a>
<ul>
<li><a href="#Versions-of-files">1.1 Versions of files</a>
<li><a href="#Versions-of-trees">1.2 Versions of trees</a>
<li><a href="#Historical-records">1.3 Historical records</a>
<li><a href="#Certificates">1.4 Certificates</a>
<li><a href="#Storage-and-workflow">1.5 Storage and workflow</a>
<li><a href="#Forks-and-merges">1.6 Forks and merges</a>
<li><a href="#Branches">1.7 Branches</a>
<ul>
<li><a href="#Branches">1.7.1 Branch Names</a>
</li></ul>
</li></ul>
<li><a name="toc_Tutorial" href="#Tutorial">2 Tutorial</a>
<ul>
<li><a href="#Tutorial">2.1 Issues</a>
<ul>
<li><a href="#Tutorial">2.1.1 Standard Options</a>
<li><a href="#Tutorial">2.1.2 Revision Selectors</a>
</li></ul>
<li><a href="#Tutorial">2.2 The Fictional Project</a>
<li><a href="#Creating-a-Database">2.3 Creating a Database</a>
<li><a href="#Generating-Keys">2.4 Generating Keys</a>
<li><a href="#Starting-a-New-Project">2.5 Starting a New Project</a>
<li><a href="#Adding-Files">2.6 Adding Files</a>
<li><a href="#Committing-Work">2.7 Committing Work</a>
<li><a href="#Network-Service">2.8 Network Service</a>
<li><a href="#Making-Changes">2.9 Making Changes</a>
<li><a href="#Dealing-with-a-Fork">2.10 Dealing with a Fork</a>
<li><a href="#Branching-and-Merging">2.11 Branching and Merging</a>
</li></ul>
<li><a name="toc_Advanced-Uses" href="#Advanced-Uses">3 Advanced Uses</a>
<ul>
<li><a href="#Selectors">3.1 Selectors</a>
<li><a href="#Restrictions">3.2 Restrictions</a>
<li><a href="#Scripting">3.3 Scripting</a>
<li><a href="#Inodeprints">3.4 Inodeprints</a>
<li><a href="#Quality-Assurance">3.5 Quality Assurance</a>
<li><a href="#Vars">3.6 Vars</a>
<li><a href="#Reserved-Files">3.7 Reserved Files</a>
<li><a href="#Reserved-Certs">3.8 Reserved Certs</a>
<li><a href="#Naming-Conventions">3.9 Naming Conventions</a>
<li><a href="#File-Attributes">3.10 File Attributes</a>
<li><a href="#Merging">3.11 Merging</a>
<li><a href="#Migrating-and-Dumping">3.12 Migrating and Dumping</a>
<li><a href="#Importing-from-CVS">3.13 Importing from CVS</a>
</li></ul>
<li><a name="toc_CVS-Phrasebook" href="#CVS-Phrasebook">4 CVS Phrasebook</a>
<li><a name="toc_Command-Reference" href="#Command-Reference">5 Command Reference</a>
<ul>
<li><a href="#Tree">5.1 Tree</a>
<li><a href="#Working-Copy">5.2 Working Copy</a>
<li><a href="#Network">5.3 Network</a>
<li><a href="#Informative">5.4 Informative</a>
<li><a href="#Key-and-Cert">5.5 Key and Cert</a>
<li><a href="#Certificate">5.6 Certificate</a>
<li><a href="#Packet-I_002fO">5.7 Packet I/O</a>
<li><a href="#Database">5.8 Database</a>
<li><a href="#Automation">5.9 Automation</a>
<li><a href="#RCS">5.10 RCS</a>
</li></ul>
<li><a name="toc_Hook-Reference" href="#Hook-Reference">6 Hook Reference</a>
<ul>
<li><a href="#Hooks">6.1 Hooks</a>
<li><a href="#Additional-Lua-Functions">6.2 Additional Lua Functions</a>
</li></ul>
<li><a name="toc_Special-Topics" href="#Special-Topics">7 Special Topics</a>
<ul>
<li><a href="#Internationalization">7.1 Internationalization</a>
<li><a href="#Hash-Integrity">7.2 Hash Integrity</a>
<li><a href="#Rebuilding-ancestry">7.3 Rebuilding ancestry</a>
</li></ul>
<li><a name="toc_Man-Page" href="#Man-Page">8 Man Page</a>
<ul>
<li><a href="#NAME">8.1 NAME</a>
<li><a href="#SYNOPSIS">8.2 SYNOPSIS</a>
<ul>
<li><a href="#Note">8.2.1 Note</a>
<li><a href="#Commands">8.2.2 Commands</a>
</li></ul>
<li><a href="#DESCRIPTION">8.3 DESCRIPTION</a>
<li><a href="#OPTIONS">8.4 OPTIONS</a>
<li><a href="#ENVIRONMENT">8.5 ENVIRONMENT</a>
<li><a href="#FILES">8.6 FILES</a>
<li><a href="#NOTES">8.7 NOTES</a>
<li><a href="#SEE-ALSO">8.8 SEE ALSO</a>
<li><a href="#BUGS">8.9 BUGS</a>
<li><a href="#AUTHOR">8.10 AUTHOR</a>
</li></ul>
<li><a name="toc_Default-hooks" href="#Default-hooks">Appendix A Default hooks</a>
<li><a name="toc_Index" href="#Index">Index</a>
</li></ul>
</div>

<p><a name="Concepts"></a>

<h2 class="chapter">1 Concepts</h2>

<p>This chapter should familiarize you with the concepts, terminology,
and behavior described in the remainder of the user manual. Please
take a moment to read it, as later sections will assume familiarity
with these terms.

<p><a name="Versions-of-files"></a>

<h3 class="section">1.1 Versions of files</h3>

<p>Suppose you wish to modify a file <span class="file">file.txt</span> on your
computer. You begin with one <i>version</i> of the file, load it into
an editor, make some changes, and save the file again. Doing so
produces a new <i>version</i> of the file. We will say that the older
version of the file was a <dfn>parent</dfn>, and the new version is a
<dfn>child</dfn>, and that you have performed an <dfn>edit</dfn> between the
parent and the child. We may draw the relationship between parent and
child using a graph, where the arrow in the graph indicates the
direction of the edit, from parent to child.

   <div class="block-image"><img src="figures/parent-child.png" alt="figures/parent-child.png"></div>

   <p>We may want to identify the parent and the child precisely, for sake
of reference. To do so, we will compute a <i>cryptographic hash
function</i>, called <span class="sc">sha1</span>, of each version. The details of this
function are beyond the scope of this document; in summary, the <span class="sc">sha1</span>
function takes a version of a file and produces a short string of 20
bytes, which we will use to uniquely identify the version<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a>.  Now our
graph does not refer to some &ldquo;abstract&rdquo; parent and child, but rather
to the exact edit we performed between a specific parent and a
specific child.

   <div class="block-image"><img src="figures/parent-child-names-hashes.png" alt="figures/parent-child-names-hashes.png"></div>

   <p>When dealing with versions of files, we will dispense with writing out
&ldquo;file names&rdquo;, and identify versions <i>purely</i> by their <span class="sc">sha1</span>
value, which we will also refer to as their <dfn>file ID</dfn>. Using IDs
alone will often help us accommodate the fact that people often wish
to call files by different names. So now our graph of parent and child
is just a relationship between two versions, only identified by ID.

   <div class="block-image"><img src="figures/parent-child-hashes.png" alt="figures/parent-child-hashes.png"></div>

   <p>Version control systems, such as monotone, are principally concerned
with the storage and management of <i>multiple</i> versions of some files. 
One way to store multiple versions of a file is, literally, to save a
separate <i>complete</i> copy of the file, every time you make a
change. When necessary, monotone will save complete copies of your
files, compressed with the <span class="command">zlib</span> compression format.

   <div class="block-image"><img src="figures/three-versions.png" alt="figures/three-versions.png"></div>

   <p>Often we find that successive versions of a file are very similar to
one another, so storing multiple complete copies is a waste of
space. In these cases, rather than store <i>complete</i> copies of each
version of a file, we store a compact description of only the
<i>changes</i> which are made between versions. Such a description of
changes is called a <dfn>delta</dfn>.

   <p>Storing deltas between files is, practically speaking, as good as
storing complete versions of files. It lets you undo changes from a
new version, by applying the delta backwards, and lets your friends
change their old version of the file into the new version, by applying
the delta forwards. Deltas are usually smaller than full files, so
when possible monotone stores deltas, using a modified <span class="command">xdelta</span>
format. The details of this format are beyond the scope of this
document.

   <div class="block-image"><img src="figures/difference-between-versions.png" alt="figures/difference-between-versions.png"></div>

<p><a name="Versions-of-trees"></a>

<h3 class="section">1.2 Versions of trees</h3>

<p>After you have made many different files, you may wish to capture a
&ldquo;snapshot&rdquo; of the versions of all the files in a particular collection. 
Since files are typically collected into <i>trees</i> in a file system,
we say that you want to capture a <i>version of your tree</i>. Doing
so will permit you to undo changes to multiple files at once, or send
your friend a <i>set</i> of changes to many files at once.

   <p>To make a snapshot of a tree, we begin by writing a special file
called a <dfn>manifest</dfn>. In fact, monotone will write this file for
us, but we could write it ourselves too. It is just a plain text
file. Each line of a manifest file contains two columns. In the first
column we write the ID of a file in your tree, and in the second
column we write the path to the file, from the root of our tree to the
filename.

   <div class="block-image"><img src="figures/manifest.png" alt="figures/manifest.png"></div>

   <p>Now we note that a manifest is itself a file. Therefore a manifest can
serve as input to the <span class="sc">sha1</span> function, and thus every manifest has
an ID of its own. By calculating the <span class="sc">sha1</span> value of a manifest, we
capture the <i>state of our tree</i> in a single <dfn>manifest ID</dfn>. In
other words, the ID of the manifest essentially captures all the IDs
and file names of every file in our tree, combined. So we may treat
manifests and their IDs as <i>snapshots</i> of a tree of files, though
lacking the actual contents of the files themselves.

   <div class="block-image"><img src="figures/file-id-manifest-id.png" alt="figures/file-id-manifest-id.png"></div>

   <p>As with versions of files, we may decide to store manifests in their
entirety, or else we may store only a compact description of changes
which occur between different versions of manifests. As with files,
when possible monotone stores compact descriptions of changes between
manifests; when necessary it stores complete versions of manifests.

<p><a name="Historical-records"></a>

<h3 class="section">1.3 Historical records</h3>

<p>Suppose you sit down to edit some files. Before you start working, you
may record a manifest of the files, for reference sake. When you
finish working, you may record another manifest. These &ldquo;before and
after&rdquo; snapshots of the tree of files you worked on can serve as
historical records of the set of changes, or <dfn>changeset</dfn>, that you
made. In order to capture a &ldquo;complete&rdquo; view of history &ndash; both the
changes made and the state of your file tree on either side of those
changes &ndash; monotone builds a special composite file called a
<dfn>revision</dfn> each time you make changes. Like manifests, revisions
are ordinary text files which can be passed through the <span class="sc">sha1</span>
function and thus assigned a <dfn>revision ID</dfn>.

   <div class="block-image"><img src="figures/revision.png" alt="figures/revision.png"></div>

   <p>The content of a revision makes reference to file IDs, in describing
a changeset, and manifest IDs, in describing tree states &ldquo;before and
after&rdquo; the changeset. Crucially, revisions also make reference to
<i>other revision IDs</i>. This fact &ndash; that revisions include the IDs of
other revisions &ndash; causes the set of revisions to join together into a
historical <i>chain of events</i>, somewhat like a &ldquo;linked list&rdquo;.  Each
revision in the chain has a unique ID, which includes <i>by reference</i>
all the revisions preceeding it. Even if you undo a changeset, and
return to a previously-visited manifest ID during the course of your
edits, each revision will incorporate the ID of its predecessor, thus
forming a new unique ID for each point in history.

   <div class="block-image"><img src="figures/revision-chaining.png" alt="figures/revision-chaining.png"></div>

<p><a name="Certificates"></a>

<h3 class="section">1.4 Certificates</h3>

<p>Often, you will wish to make a <i>statement</i> about a revision, such as
stating the reason that you made some changes, or stating the time at
which you made the changes, or stating that the revision passes a test
suite. Statements such as these can be thought of, generally, as a
bundle of information with three parts:

     <ul>
<li>an <i>ID</i>, indicating which revision you are making a statement about
<li>a <i>name</i> indicating the type of statement you are making, such as
&ldquo;changelog&rdquo;, &ldquo;date&rdquo; or &ldquo;testresult&rdquo;
<li>a <i>value</i> indicating the remaining detail of the statement, such as
&ldquo;fixed a bug&rdquo;, &ldquo;March 9th&rdquo; or &ldquo;1&rdquo;
</ul>

   <p>For example, if you want to say that a particular revision was
composed on April 4, 2003, you might make a statement like this:

   <div class="block-image"><img src="figures/statement.png" alt="figures/statement.png"></div>

   <p>In an ideal world, these are all the parts of a statement we would
need in order to go about our work. In the real world, however, there
are sometimes malicious people who would make false or misleading
statements; so we need a way to verify that a particular person made a
particular statement about a revision. We therefore will add two more
pieces of information to our bundle:

     <ul>
<li>a <i>key</i> which identifies the person making a statement
<li>a <i>signature</i> &mdash; just a large number with particular properties &mdash;
certifying the fact that the person made the statement
</ul>

   <p>When these 2 items accompany a statement, we call the total bundle of
5 items a <dfn>certificate</dfn>, or <i>cert</i>. A cert makes a statement in
a secure fashion. The security of the signature in a cert is derived
from the <span class="sc">rsa</span> cryptography system, the details of which are beyond
the scope of this document.

   <div class="block-image"><img src="figures/cert.png" alt="figures/cert.png"></div>

   <p>Monotone uses certs extensively. Any &ldquo;extra&rdquo; information which needs
to be stored, transmitted or retrieved &mdash; above and beyond files,
manifests, and revisions &mdash; is kept in the form of certs. This
includes change logs, time and date records, branch membership,
authorship, test results, and more. When monotone makes a decision
about storing, transmitting, or extracting files, manifests, or
revisions, the decision is often based on certs it has seen, and the
trustworthiness you assign to those certs.

   <p>The <span class="sc">rsa</span> cryptography system &mdash; and therefore monotone itself &mdash;
requires that you exchange special &ldquo;public&rdquo; numbers with your
friends, before they will trust certificates signed by you. These
numbers are called <dfn>public keys</dfn>. Giving someone your public key
does not give them the power to <i>impersonate</i> you, only to verify
signatures made by you. Exchanging public keys should be done over a
trusted medium, in person, or via a trusted third party. Advanced
secure key exchange techniques are beyond the scope of this document.

<p><a name="Storage-and-workflow"></a>

<h3 class="section">1.5 Storage and workflow</h3>

<p>Monotone moves information in and out of three different types of
storage:

     <ul>
<li>a <i>working copy</i> in the local file system
<li>a <i>local database</i> in the local file system
<li>a <i>remote database</i> elsewhere on the internet
</ul>

   <p>All information passes <em>through</em> your local database, en route to
some other destination. For example, when changes are made in a
working copy, you may save those changes to your database, and later
you may synchronize your database with someone else's. Monotone will
not move information directly between a working copy and a remote
database, or between working copies. Your local database is always
the &ldquo;switching point&rdquo; for communication.

   <div class="block-image"><img src="figures/general-workflow.png" alt="figures/general-workflow.png"></div>

   <p>A <dfn>working copy</dfn> is a tree of files in your file system, arranged
according to the list of file paths and IDs in a particular
manifest. A special directory called <span class="file">MT</span> exists in the root of
any working copy. Monotone keeps some special files in the <span class="file">MT</span>
directory, in order to track changes you make to your working copy.

   <p>Aside from the special <span class="file">MT</span> directory, a working copy is just a
normal tree of files. You can directly edit the files in a working
copy using a plain text editor or other program; monotone will
automatically notice when you make any changes. If you wish to add
files, remove files, or move files within your working copy, you must
tell monotone explicitly what you are doing, as these actions cannot
be deduced.

   <p>If you do not yet have a working copy, you can <dfn>check out</dfn> a
working copy from a database, or construct one from scratch and
<dfn>add</dfn> it into a database. As you work, you will occasionally
<dfn>commit</dfn> changes you have made in a working copy to a database,
and <dfn>update</dfn> a working copy to receive changes that have arrived
in a database. Committing and updating take place purely between a
database and a working copy; the network is not involved.

   <div class="block-image"><img src="figures/local-workflow.png" alt="figures/local-workflow.png"></div>

   <p>A <dfn>database</dfn> is a single, regular file. You can copy or back it up
using standard methods. Typically you keep a database in your home
directory. Databases are portable between different machine types. You
can have multiple databases and divide your work between them, or keep
everything in a single database if you prefer. You can dump portions of
your database out as text, and read them back into other databases, or
send them to your friends.  Underneath, databases are accessed using a
standard, robust data manager, which makes using even very large
databases efficient.  In dire emergencies, you can directly examine and
manipulate a database using a simple SQL interface.

   <p>A database contains many files, manifests, revisions, and
certificates, some of which are not immediately of interest, some of
which may be unwanted or even false. It is a collection of information
received from network servers, working copies, and other
databases. You can inspect and modify your databases without affecting
your working copies, and vice-versa.

   <p>Monotone knows how to exchange information in your database with other
remote databases, using an interactive protocol called <dfn>netsync</dfn>. 
It supports three modes of exchange: pushing, pulling, and
synchronizing. A <dfn>pull</dfn> operation copies data from a remote
database to your local database. A <dfn>push</dfn> operation copies data
from your local database to a remote database. A <dfn>sync</dfn> operation
copies data both directions. In each case, only the data missing from
the destination is copied. The netsync protocol calculates the data to
send &ldquo;on the fly&rdquo; by exchanging partial hash values of each
database.

   <div class="block-image"><img src="figures/network-workflow.png" alt="figures/network-workflow.png"></div>

   <p>In general, work flow with monotone involves 3 distinct stages:

     <ul>
<li>When you <i>commit</i> changes from your working copy to your database,
your database stores the changes but does not communicate with the
network. Your commits happen immediately, without consulting any other
party, and do not require network connectivity.

     <li>When you are ready to <i>exchange</i> work with someone else, you can
push, pull, or sync with other databases on the network. When you talk
to other servers on the network, your database may change, but your
working copy will not. In fact, you do not need a working copy at all
when exchanging work.

     <li>When you <i>update</i> your working copy, some (but not all) of the
changes which your database received from the network are applied to
your working copy. The network is not consulted during updates. 
</ul>

   <p>The last stage of workflow is worth clarifying: monotone does
<em>not</em> blindly apply all changes it receives from a remote
database to your working copy.  Doing so would be very dangerous,
because remote databases are not always trustworthy systems. Rather,
monotone evaluates the certificates it has received along with the
changes, and decides which particular changes are safe and desirable
to apply to your working copy.

   <p>You can always adjust the criteria monotone uses to judge the
trustworthiness and desirability of changes in your database. But keep
in mind that it always uses <em>some</em> criteria; receiving changes
from a remote server is a <em>different</em> activity than applying
changes to a working copy. Sometimes you may receive changes which
monotone judges to be untrusted or bad; such changes may stay in your
database but will <em>not</em> be applied to your working copy.

   <p>Remote databases, in other words, are just untrusted &ldquo;buckets&rdquo; of
data, which you can trade with promiscuously. There is no trust
implied in communication.

<p><a name="Forks-and-merges"></a>

<h3 class="section">1.6 Forks and merges</h3>

<p>So far we have been talking about revisions as though each logically
follows exactly one revision before it, in a simple sequence of
revisions.

   <div class="block-image"><img src="figures/linear-history.png" alt="figures/linear-history.png"></div>

   <p>This is a rosy picture, but sometimes it does not work out this
way. Sometimes when you make new revisions, other people are
<i>simultaneously</i> making new revisions as well, and their revisions
might be derived from the same parent as yours, or contain different
changesets. Without loss of generality, we will assume simultaneous
edits only happen two-at-a-time; in fact many more edits may happen at
once but our reasoning will be the same.

   <p>We call this situation of simultaneous edits a <dfn>fork</dfn>, and will
refer to the two children of a fork as the <i>left child</i> and <i>right
child</i>. In a large collection of revisions with many people editing
files, especially on many different computers spread all around the
world, forks are a common occurrence.

   <div class="block-image"><img src="figures/fork.png" alt="figures/fork.png"></div>

   <p>If we analyze the changes in each child revision, we will often find
that the changeset between the parent and the left child are unrelated
to the changeset between the parent and the right child. When this
happens, we can usually <dfn>merge</dfn> the fork, producing a common
grandchild revision which contains both changesets.

   <div class="block-image"><img src="figures/merge.png" alt="figures/merge.png"></div>

<p><a name="Branches"></a>

<h3 class="section">1.7 Branches</h3>

<p>Sometimes, people intentionally produce forks which are <em>not
supposed to be merged</em>; perhaps they have agreed to work independently
for a time, or wish to change their files in ways which are not
logically compatible with each other. When someone produces a fork
which is supposed to last for a while (or perhaps permanently) we say
that the fork has produced a new <dfn>branch</dfn>. Branches tell monotone
which revisions you would like to merge, and which you would like to
keep separate.

   <p>You can see all the available branches using <code>monotone list branches</code>.

   <p>Branches are indicated with certs.  The cert name <code>branch</code> is
reserved for use by monotone, for the purpose of identifying the
revisions which are members of a branch. A <code>branch</code> cert has a
symbolic &ldquo;branch name&rdquo; as its value. When we refer to &ldquo;a branch&rdquo;,
we mean all revisions with a common branch name in their <code>branch</code>
certs.

   <p>For example, suppose you are working on a program called &ldquo;wobbler&rdquo;. 
You might develop many revisions of wobbler and then decide to split
your revisions into a &ldquo;stable branch&rdquo; and an &ldquo;unstable branch&rdquo;, to
help organize your work. In this case, you might call the new branches
&ldquo;wobbler-stable&rdquo; and &ldquo;wobbler-unstable&rdquo;. From then on, all
revisions in the stable branch would get a cert with name <code>branch</code>
and value <code>wobbler-stable</code>; all revisions in the unstable branch
would get a cert with name <code>branch</code> and value
<code>wobbler-unstable</code>. When a <code>wobbler-stable</code> revision forks,
the children of the fork will be merged. When a
<code>wobbler-unstable</code> revision forks, the children of the fork will
be merged. However, the <code>wobbler-stable</code> and
<code>wobbler-unstable</code> branches will not be merged together, despite
having a common ancestor.

   <div class="block-image"><img src="figures/two-branches.png" alt="figures/two-branches.png"></div>

   <p>For each branch, the set of revisions with <em>no children</em> is
called the <dfn>heads</dfn> of the branch. Monotone can automatically
locate, and attempt to merge, the heads of a branch. If it fails to
automatically merge the heads, it may ask you for assistance or else
fail cleanly, leaving the branch alone.

   <p>For example, if a fork's left child has a child of its own (a &ldquo;left
grandchild&rdquo;), monotone will merge the fork's right child with the
left grandchild, since those revisions are the heads of the branch. It
will not merge the left child with the right child, because the left
child is not a member of the heads.

   <div class="block-image"><img src="figures/branch-heads.png" alt="figures/branch-heads.png"></div>

   <p>When there is only one revision in the heads of a branch, we say that
<i>the heads are merged</i>, or more generally that <i>the branch is
merged</i>, since the heads is the logical set of candidates for any
merging activity. If there are two or more revisions in the heads of a
branch, and you ask to merge the branch, monotone will merge them
two-at-a-time until there is only one.

<h4 class="subsection">1.7.1 Branch Names</h4>

<p>The branch names used in the above section are fine for an example, but
they would be bad to use in a real project.  The reason is, monotone
branch names must be <em>globally</em> unique, over all branches in the
world.  Otherwise, bad things can happen.  Fortunately, we have a handy
source of globally unique names &mdash; the DNS system.

   <p>When naming a branch, always prepend the reversed name of a host that
you control or are otherwise authorized to use.  For example, monotone
development happens on the branch <code>net.venge.monotone</code>, because
<code>venge.net</code> belongs to monotone's primary author.  The idea is that
this way, you can coordinate with other people using a host to make sure
there are no conflicts &mdash; in the example, monotone's primary author can
be certain that no-one else using <code>venge.net</code> will start up a
different program named <code>monotone</code>.  If you work for Yoyodyne,
Inc. (owners of yoyodyne.com), then all your branch names should look
like <code>com.yoyodyne.</code><em>something</em>.

   <p>What the <em>something</em> part looks like is up to you, but
usually the first part is the project name (the <code>monotone</code> in
<code>net.venge.monotone</code>), and then possibly more stuff after that to
describe a particular branch.  For example, monotone's win32 support
was initially developed on the branch <code>net.venge.monotone.win32</code>.

   <p>(For more information, see <a href="#Naming-Conventions">Naming Conventions</a>.)

<p><a name="Tutorial"></a>

<h2 class="chapter">2 Tutorial</h2>

<p>This chapter illustrates the basic uses of monotone by means of an
example, fictional software project.

<h3 class="section">2.1 Issues</h3>

<p>Before we walk through the tutorial, there are two minor issues to
address: standard options and revision selectors.

<h4 class="subsection">2.1.1 Standard Options</h4>

<p>Before operating monotone, two important command-line options should
be explained.

     <ul>
<li>Most commands operate on a <i>database</i>, which is selected with
the <span class="option">--db</span> option. 
<li>Many commands operate on a subset of the database, called a
<i>branch</i>, which is selected with the <span class="option">--branch</span> option. 
</ul>

   <p>Monotone will cache the settings for these options in your working
copy, so ordinarily once you have checked out a project, you will not
need to specify them again.  We will therefore only mention these
arguments in the first example.

<h4 class="subsection">2.1.2 Revision Selectors</h4>

<p>Many commands require you to supply 40-character <span class="sc">sha1</span> values as
arguments, which identify revisions. These &ldquo;revision IDs&rdquo; are
tedious to type, so monotone permits you to supply &ldquo;revision
selectors&rdquo; rather than complete revision IDs. Selectors are a more
&ldquo;human friendly&rdquo; way of specifying revisions by combining certificate
values into unique identifiers. This &ldquo;selector&rdquo; mechanism can be
used anywhere a revision ID would normally be used. For details on
selector syntax, see <a href="#Selectors">Selectors</a>.

   <p>We are now ready to explore our fictional project.

<h3 class="section">2.2 The Fictional Project</h3>

<p>Our fictional project involves 3 programmers cooperating to write
firmware for a robot, the JuiceBot 7, which dispenses fruit juice. The
programmers are named Jim, Abe and Beth.

     <ul>
<li>Jim lives in Japan, and owns JuiceBot Inc. You will know when we're talking
about Jim, because everything he does involves the letter &ldquo;j&rdquo;. 
<li>Abe lives in Australia and writes code related to apple juice. You will
know when we're talking about Abe, because everything he does involves
the letter &ldquo;a&rdquo;. 
<li>Beth lives in Brazil and writes code related to banana juice. You will
know when we're talking about Beth, because everything she does involves
the letter &ldquo;b&rdquo;. 
</ul>

   <p>In our example the programmers work privately on laptops, and are
usually <em>disconnected</em> from the network. They share no storage
system. Thus when each programmer enters a command, it affects only
his or her own computer, unless otherwise stated.

   <p>In the following, our fictional project team will work through several
version control tasks. Some tasks must be done by each member of our
example team; other tasks involve only one member.

<p><a name="Creating-a-Database"></a>

<h3 class="section">2.3 Creating a Database</h3>

<p>The first step Jim, Abe and Beth each need to perform is to create a
new database. This is done with the <code>monotone db init</code> command,
providing a <span class="option">--db</span> option to specify the location of the new
database. Each programmer creates their own database, which will
reside in their home directory and store all the revisions, files and
manifests they work on. Monotone requires this step as an explicit
command, to prevent spurious creation of databases when an invalid
<span class="option">--db</span> option is given.

   <p>In real life, most people prefer to keep one database for each project
they work on.  If we followed that convention here in the tutorial,
though, then all the databases would be called <code>juicebot.db</code>, and
that would make things more confusing to read.  So instead, we'll have
them each name their database after themselves.

   <p>Thus Jim issues the command:

<pre class="smallexample">     $ monotone db init --db=~/jim.db
</pre>
   <p>Abe issues the command:

<pre class="smallexample">     $ monotone db init --db=~/abe.db
</pre>
   <p>And Beth issues the command:

<pre class="smallexample">     $ monotone db init --db=~/beth.db
</pre>
   <p><a name="Generating-Keys"></a>

<h3 class="section">2.4 Generating Keys</h3>

<p>Now Jim, Abe and Beth must each generate an <span class="sc">rsa</span> key pair for
themselves. This step requires choosing a key identifier. Typical key
identifiers are similar to email addresses, possibly modified with
some prefix or suffix to distinguish multiple keys held by the same
owner. Our example programmers will use their email addresses at the
fictional &ldquo;juicebot.co.jp&rdquo; domain name. When we ask for a key to be
generated, monotone will ask us for a passphrase. This phrase is used
to encrypt the key when storing it on disk, as a security measure.

   <p>Jim does the following:

<pre class="smallexample">     $ monotone --db=~/jim.db genkey jim@juicebot.co.jp
     monotone: generating key-pair 'jim@juicebot.co.jp'
     enter passphrase for key ID [jim@juicebot.co.jp] : <i>&lt;Jim enters his passphrase&gt;</i>
     confirm passphrase for key ID [jim@juicebot.co.jp]: <i>&lt;Jim confirms his passphrase&gt;</i>
     monotone: storing key-pair 'jim@juicebot.co.jp' in database
</pre>
   <p>Abe does something similar:

<pre class="smallexample">     $ monotone --db=~/abe.db genkey abe@juicebot.co.jp
     monotone: generating key-pair 'abe@juicebot.co.jp'
     enter passphrase for key ID [abe@juicebot.co.jp] : <i>&lt;Abe enters his passphrase&gt;</i>
     confirm passphrase for key ID [abe@juicebot.co.jp]: <i>&lt;Abe confirms his passphrase&gt;</i>
     monotone: storing key-pair 'abe@juicebot.co.jp' in database
</pre>
   <p>as does Beth:

<pre class="smallexample">     $ monotone --db=~/beth.db genkey beth@juicebot.co.jp
     monotone: generating key-pair 'beth@juicebot.co.jp'
     enter passphrase for key ID [beth@juicebot.co.jp] : <i>&lt;Beth enters her passphrase&gt;</i>
     confirm passphrase for key ID [beth@juicebot.co.jp]: <i>&lt;Beth confirms her passphrase&gt;</i>
     monotone: storing key-pair 'beth@juicebot.co.jp' in database
</pre>
   <p>Each programmer has now generated a key pair and placed it in their
local database. Each can list the keys in their database, to ensure
the correct key was generated. For example, Jim might see this:

<pre class="smallexample">     $ monotone --db=~/jim.db list keys
     
     [public keys]
     9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c jim@juicebot.co.jp
     
     
     [private keys]
     771ace046c27770a99e5fddfa99c9247260b5401 jim@juicebot.co.jp
</pre>
   <p>The hexadecimal string printed out before each key name is a
<em>fingerprint</em> of the key, and can be used to verify that the key
you have stored under a given name is the one you intended to
store. Monotone will never permit one database to store two keys with
the same name or the same fingerprint.

   <p>This output shows one private and one public key stored under the name
<code>jim@juicebot.co.jp</code>, so it indicates that Jim's key-pair has been
successfully generated and stored. On subsequent commands, Jim will need
to re-enter his passphrase in order to perform security-sensitive
tasks. Jim isn't very worried about security (and, more importantly, it
simplifies the tutorial text to skip the passphrase prompts) so he
decides to store his passphrase in his <code>monotonerc</code> file.  He does
this by writing a <em>hook function</em> which returns the passphrase:

<pre class="smallexample">     $ mkdir ~/.monotone
     $ cat &gt;&gt;~/.monotone/monotonerc
     function get_passphrase(keypair_id)
       return "jimsekret"
     end
     ^D
</pre>
   <p>Now whenever monotone needs his passphrase, it will call this function
instead of prompting him to type it.  Note that we are appending the new
hook to the (possibly existing) file.  We do this to avoid losing other
changes by mistake; therefore, be sure to check that no other
<code>get_passphrase</code> function appears in the configuration file.

   <p>Abe and Beth do the same, with their secret passphrases.

<p><a name="Starting-a-New-Project"></a>

<h3 class="section">2.5 Starting a New Project</h3>

<p>Before he can begin work on the project, Jim needs to create a
<i>working copy</i> &mdash; a directory whose contents monotone will keep track
of.  Often, one works on projects that someone else has started, and
creates working copies with the <code>checkout</code> command, which you'll
learn about later.  Jim is starting a new project, though, so he does
something a little bit different.  He uses the <code>monotone setup</code>
command to create a new working copy.

   <p>This command creates the named directory (if it doesn't already exist),
and creates the <span class="file">MT</span> directory within it.  The <span class="file">MT</span> directory
is how monotone recognizes that a directory is a working copy, and
monotone stores some bookkeeping files within it.  For instance, command
line values for the <span class="option">--db</span>, <span class="option">--branch</span> or <span class="option">--key</span>
options to the <code>setup</code> command will be cached in a file called
<span class="file">MT/options</span>, so you don't have to keep passing them to monotone
all the time.

   <p>He chooses <code>jp.co.juicebot.jb7</code> as a branch name. (See
<a href="#Naming-Conventions">Naming Conventions</a> for more information about appropriate branch
names.)  Jim then creates his working copy:

<pre class="smallexample">     /home/jim$ monotone --db=jim.db --branch=jp.co.juicebot.jb7 setup juice
     /home/jim$ cd juice
     /home/jim/juice$
</pre>
   <p>Notice that Jim has changed his current directory to his newly created
working copy. For the rest of this example we will assume that everyone
issues all further monotone commands from their working copy
directories.

<p><a name="Adding-Files"></a>

<h3 class="section">2.6 Adding Files</h3>

<p>Next Jim decides to add some files to the project. He writes up
a file containing the prototypes for the JuiceBot 7:

<pre class="smallexample">     $ mkdir include
     $ cat &gt;include/jb.h
     /* Standard JuiceBot hw interface */
     
     #define FLOW_JUICE 0x1
     #define POLL_JUICE 0x2
     int spoutctl(int port, int cmd, void *x);
     
     /* JuiceBot 7 API */
     
     #define APPLE_SPOUT 0x7e
     #define BANANA_SPOUT 0x7f
     void dispense_apple_juice ();
     void dispense_banana_juice ();
     ^D
</pre>
   <p>Then adds a couple skeleton source files which he wants Abe and Beth
to fill in:

<pre class="smallexample">     $ mkdir src
     $ cat &gt;src/apple.c
     #include "jb.h"
     
     void
     dispense_apple_juice()
     {
       /* Fill this in please, Abe. */
     }
     ^D
     $ cat &gt;src/banana.c
     #include "jb.h"
     
     void
     dispense_banana_juice()
     {
       /* Fill this in please, Beth. */
     }
     ^D
</pre>
   <p>Now Jim tells monotone to add these files to its record of his working
copy. He specifies one filename and one directory; monotone
recursively scans the directory and adds all its files.

<pre class="smallexample">     $ monotone add include/jb.h src
     monotone: adding include/jb.h to working copy add set
     monotone: adding src/apple.c to working copy add set
     monotone: adding src/banana.c to working copy add set
</pre>
   <p>This command produces a record of Jim's intentions in a special file
called <span class="file">MT/work</span>, stored in the working copy. The file is plain
text:

<pre class="smallexample">     $ cat MT/work
     add_file "include/jb.h"
     
     add_file "src/apple.c"
     
     add_file "src/banana.c"
</pre>
   <p>Jim then gets up from his machine to get a coffee. When he returns
he has forgotten what he was doing. He asks monotone:

<pre class="smallexample">     $ monotone status
     
     new_manifest [2098eddbe833046174de28172a813150a6cbda7b]
     
     old_revision []
     old_manifest []
     
     add_file "include/jb.h"
     
     add_file "src/apple.c"
     
     add_file "src/banana.c"
     
     patch "include/jb.h"
      from []
        to [3b12b2d0b31439bd50976633db1895cff8b19da0]
     
     patch "src/apple.c"
      from []
        to [2650ffc660dd00a08b659b883b65a060cac7e560]
     
     patch "src/banana.c"
      from []
        to [e8f147e5b4d5667f3228b7bba1c5c1e639f5db9f]
</pre>
   <p>The output of this command tells Jim that his edits, so far,
constitute only the addition of some files. In the output we can see
one pecularity of monotone's changeset format. The pecularity is that
when monotone records a &ldquo;new file&rdquo;, it actually records two separate
events: the addition of an empty file to the working copy, and a patch
of that file from empty to its intended contents.

   <p>Jim wants to see the actual details of the files he added, however, so
he runs a command which prints out the status <em>and</em> a GNU
&ldquo;unified diff&rdquo; of the patches involved in the changeset:

<pre class="smallexample">     $ monotone diff
     #
     # add_file "include/jb.h"
     #
     # add_file "src/apple.c"
     #
     # add_file "src/banana.c"
     #
     # patch "include/jb.h"
     #  from []
     #    to [3b12b2d0b31439bd50976633db1895cff8b19da0]
     #
     # patch "src/apple.c"
     #  from []
     #    to [2650ffc660dd00a08b659b883b65a060cac7e560]
     #
     # patch "src/banana.c"
     #  from []
     #    to [e8f147e5b4d5667f3228b7bba1c5c1e639f5db9f]
     #
     ============================================================================
     --- include/jb.h
     +++ include/jb.h 3b12b2d0b31439bd50976633db1895cff8b19da0
     @ -0,0 +1,13 @
     +/* Standard JuiceBot hw interface */
     +
     +#define FLOW_JUICE 0x1
     +#define POLL_JUICE 0x2
     +#define SET_INTR 0x3
     +int spoutctl(int port, int cmd, void *x);
     +
     +/* JuiceBot 7 API */
     +
     +#define APPLE_SPOUT 0x7e
     +#define BANANA_SPOUT 0x7f
     +void dispense_apple_juice ();
     +void dispense_banana_juice ();
     ============================================================================
     --- src/apple.c
     +++ src/apple.c 2650ffc660dd00a08b659b883b65a060cac7e560
     @ -0,0 +1,7 @
     +#include "jb.h"
     +
     +void
     +dispense_apple_juice()
     +{
     +  /* Fill this in please, Abe. */
     +}
     ============================================================================
     --- src/banana.c
     +++ src/banana.c e8f147e5b4d5667f3228b7bba1c5c1e639f5db9f
     @ -0,0 +1,7 @
     +#include "jb.h"
     +
     +void
     +dispense_banana_juice()
     +{
     +  /* Fill this in please, Beth. */
     +}
</pre>
   <p><a name="Committing-Work"></a>

<h3 class="section">2.7 Committing Work</h3>

<p>Satisfied with the work he's done, Jim wants to save his changes.  He
then commits his working copy, which causes monotone to process the
<span class="file">MT/work</span> file and record the file contents, manifest, and
revision into the database.  Since he provided a branch name when he
ran <span class="command">setup</span>, monotone will use this as the default branch name
when he commits.

<pre class="smallexample">     $ monotone commit --message="initial checkin of project"
     monotone: beginning commit on branch 'jp.co.juicebot.jb7'
     monotone: committed revision 2e24d49a48adf9acf3a1b6391a080008cbef9c21
</pre>
   <p>When monotone committed Jim's revision, erased the <span class="file">MT/work</span> file,
and wrote a new file called <span class="file">MT/revision</span>, which contains the
working copy's new base revision ID. Jim can use this revision ID in the
future, as an argument to the <span class="command">checkout</span> command, if he wishes
to return to this revision:

<pre class="smallexample">     $ cat MT/revision
     2e24d49a48adf9acf3a1b6391a080008cbef9c21
</pre>
   <p>Monotone also generated a number of certificates, attached to
the new revision. These certs store metadata about the commit. Jim can
ask monotone for a list of certs on this revision.

<pre class="smallexample">     $ monotone ls certs 2e24d49a48adf9acf3a1b6391a080008cbef9c21
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : branch
     Value : jp.co.juicebot.jb7
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : date
     Value : 2004-10-26T02:53:08
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : author
     Value : jim@juicebot.co.jp
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : changelog
     Value : initial checkin of project
</pre>
   <p>The output of this command has a block for each cert found. Each block
has 4 significant pieces of information. The first indicates the
signer of the cert, in this case <code>jim@juicebot.co.jp</code>. The
second indicates whether this cert is &ldquo;ok&rdquo;, meaning whether the
<span class="sc">rsa</span> signature provided is correct for the cert data. The third is
the cert name, and the fourth is the cert value. This list shows us
that monotone has confirmed that, according to
<code>jim@juicebot.co.jp</code>, the revision
<code>2e24d49a48adf9acf3a1b6391a080008cbef9c21</code> is a member of the
branch <code>jp.co.juicebot.jb7</code>, written by
<code>jim@juicebot.co.jp</code>, with the given date and changelog.

   <p>It is important to keep in mind that revisions are not &ldquo;in&rdquo; or
&ldquo;out&rdquo; of a branch in any global sense, nor are any of these cert
values <i>true</i> or <i>false</i> in any global sense. Each cert indicates
that <i>some person</i> &ndash; in this case Jim &ndash; would like to associate a
revision with some value; it is up to you to decide if you want to
accept that association.

   <p>Jim can now check the status of his branch using the &ldquo;heads&rdquo;
command, which lists all the head revisions in the branch:

<pre class="smallexample">     $ monotone heads
     branch 'jp.co.juicebot.jb7' is currently merged:
     2e24d49a48adf9acf3a1b6391a080008cbef9c21 jim@juicebot.co.jp 2004-10-26T02:53:08
</pre>
   <p>The output of this command tells us that there is only one current
&ldquo;head&rdquo; revision in the branch <code>jp.co.juicebot.jb7</code>, and it is
the revision Jim just committed. A head revision is one without any
descendents. Since Jim has not committed any changes to this revision
yet, it has no descendents.

<p><a name="Network-Service"></a>

<h3 class="section">2.8 Network Service</h3>

<p>Jim now decides he will make his base revision available to his
employees. To do this he gives Abe and Beth permission to access his
database.  There are two parts to this: first, he has to get a copy of
each of their public keys; then, he has to tell monotone that the
holders of those keys are permitted to access his database.

   <p>First, Abe exports his public key:

<pre class="smallexample">     $ monotone --db=~/abe.db pubkey abe@juicebot.co.jp &gt;~/abe.pubkey
</pre>
   <p>His public key is just a plain block of ASCII text:

<pre class="smallexample">     $ cat ~/abe.pubkey
     [pubkey abe@juicebot.co.jp]
     MIGdMA0GCSqGSIb3DQEBAQUAA4GLADCBhwKBgQCbaVff9SF78FiB/1nUdmjbU/TtPyQqe/fW
     CDg7hSg1yY/hWgClXE9FI0bHtjPMIx1kBOig09AkCT7tBXM9z6iGWxTBhSR7D/qsJQGPorOD
     DO7xovIHthMbZZ9FnvyB/BCyiibdWgGT0Gtq94OKdvCRNuT59e5v9L4pBkvajb+IzQIBEQ==
     [end]
</pre>
   <p>Beth also exports her public key:

<pre class="smallexample">     $ monotone --db=~/beth.db pubkey beth@juicebot.co.jp &gt;~/beth.pubkey
</pre>
   <p>Then Abe and Beth both send their keys to Jim.  The keys are not secret,
but the team members must be relatively certain that they are
communicating with the person they intend to trust, when exchanging
keys, and not some malicious person pretending to be a team
member. Key exchange may involve sending keys over an encrypted
medium, or meeting in person to exchange physical copies, or any
number of techniques. All that matters, ultimately, is that Jim receives
both Abe's and Beth's key.

   <p>So eventually, after key exchange, Jim has the public key files in his
home directory. He tells monotone to read the associated key packets
into his database:

<pre class="smallexample">     $ cat ~/abe.pubkey ~/beth.pubkey | monotone --db=~/jim.db read
     monotone: read 2 packets
</pre>
   <p>Now Jim's monotone is able to identify Beth and Abe, and he is ready to
give them permission to access his database.  He does this by adding a
small amount of extra information to his <span class="file">monotonerc</span> file:

<pre class="smallexample">     $ cat &gt;&gt;~/.monotone/monotonerc
     function get_netsync_read_permitted (branch, identity)
       if (identity == "abe@juicebot.co.jp") then return true end
       if (identity == "beth@juicebot.co.jp") then return true end
       return false
     end
     
     function get_netsync_write_permitted (identity)
       if (identity == "abe@juicebot.co.jp") then return true end
       if (identity == "beth@juicebot.co.jp") then return true end
       return false
     end
     ^D
</pre>
   <p>He then makes sure that his TCP port 5253 is open to incoming
connections, adjusting his firewall settings as necessary, and runs
the monotone <span class="command">serve</span> command:

<pre class="smallexample">     $ monotone --db=jim.db serve jim-laptop.juicebot.co.jp "jp.co.juicebot.jb7*"
</pre>
   <p>This command sets up a single listener loop on the host
<code>jim-laptop.juicebot.co.jp</code>, serving all branches matching
<code>jp.co.juicebot.jb7*</code>. This will naturally include the
<code>jp.co.juicebot.jb7</code> branch, and any sub-branches.  The quotes
around <code>"jp.co.juicebot.jb7*"</code> are there to protect the <code>*</code>
from expansion by the shell; they have no meaning to monotone.

   <p>Now Abe decides he wishes to fetch Jim's code. To do this he issues
the monotone <code>sync</code> command:

<pre class="smallexample">     $ monotone --db=abe.db sync jim-laptop.juicebot.co.jp "jp.co.juicebot.jb7*"
     monotone: setting default server to jim-laptop.juicebot.co.jp
     monotone: setting default branch include pattern to 'jp.co.juicebot.jb7*'
     monotone: setting default branch exclude pattern to ''
     monotone: connecting to jim-laptop.juicebot.co.jp
     monotone: first time connecting to server jim-laptop.juicebot.co.jp:5253
     monotone: I'll assume it's really them, but you might want to double-check
     monotone: their key's fingerprint: 9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c
     monotone: warning: saving public key for jim@juicebot.co.jp to database
     monotone: finding items to synchronize:
     monotone: bytes in | bytes out | revs in | revs out | revs written
     monotone:     2587 |      1025 |       1 |        0 |            1
     monotone: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p>Abe now has, in his database, a copy of everything Jim put in the
branch. Therefore Abe can disconnect from the expensive network
connection he's on and work locally for a while. When Abe wants to
send work back to Jim, or get new work Jim has added, all he needs to
do is run the <span class="command">sync</span> command again and work will flow both
ways, bringing each party up to date with the work of the other.

   <p>At this point Jim is operating as a sort of &ldquo;central server&rdquo; for the
company. If Jim wants to, he can leave his server running forever, or
even put his server on a dedicated computer with better network
connectivity.  But if Jim is ever unable to play this role of &ldquo;central
server&rdquo;, perhaps due to a network failure, either Beth or Abe can run
the <span class="command">serve</span> command and provide access for the other to
<span class="command">sync</span> with.  In fact, each employee can run a server if they
like, concurrently, to help minimize the risk of service disruption from
hardware failures.  Changes will flow between servers automatically as
clients access them and trade with one another.

   <p>In practice, most people like to use at least one central server that is
always running; this way, everyone always knows where to go to get the
latest changes, and people can push their changes out without first
calling their friends and making sure that they have their servers
running.  To make this style of working more convenient, monotone
remembers the first server you use, and makes that the default for
future operations.

<p><a name="Making-Changes"></a>

<h3 class="section">2.9 Making Changes</h3>

<p>Abe decides to do some work on his part of the code. He has a copy of
Jim's database contents, but cannot edit any of that data yet.  He
begins his editing by checking out the head of the
<code>jp.co.juicebot.jb7</code> branch into a working copy, so he can edit
it:

<pre class="smallexample">     $ monotone --db=abe.db --branch=jp.co.juicebot.jb7 checkout .
</pre>
   <p>Monotone unpacks the set of files in the head revision's manifest
directly into Abe's current directory.  (If he had specified something
other than <span class="file">.</span> at the end, monotone would have created that
directory and unpacked the files into it.)  Abe then opens up one of the
files, <span class="file">src/apple.c</span>, and edits it:

<pre class="smallexample">     $ vi src/apple.c
     <i>&lt;Abe writes some apple-juice dispensing code&gt;</i>
</pre>
   <p>The file <span class="file">src/apple.c</span> has now been <em>changed</em>. Abe gets
up to answer a phone call, and when he returns to his work he has
forgotten what he changed. He can ask monotone for details:

<pre class="smallexample">     $ monotone diff
     #
     # patch "src/apple.c"
     #  from [2650ffc660dd00a08b659b883b65a060cac7e560]
     #    to [e2c418703c863eabe70f9bde988765406f885fd0]
     #
     ============================================================================
     --- src/apple.c 2650ffc660dd00a08b659b883b65a060cac7e560
     +++ src/apple.c e2c418703c863eabe70f9bde988765406f885fd0
     @ -1,7 +1,10 @
      #include "jb.h"
     
      void
      dispense_apple_juice()
      {
     -  /* Fill this in please, Abe. */
     +  spoutctl(APPLE_SPOUT, FLOW_JUICE, 1);
     +  while (spoutctl(APPLE_SPOUT, POLL_JUICE, 1) == 0)
     +    usleep (1000);
     +  spoutctl(APPLE_SPOUT, FLOW_JUICE, 0);
      }
</pre>
   <p>Satisfied with his day's work, Abe decides to commit.

<pre class="smallexample">     $ monotone commit
     monotone: beginning commit on branch 'jp.co.juicebot.jb7'
</pre>
   <p>Abe neglected to provide a <span class="option">--message</span> option specifying the
change log on the command line and the file <span class="file">MT/log</span> is empty
because he did not document his changes there.  Monotone therefore
invokes an external &ldquo;log message editor&rdquo; &mdash; typically an editor
like <span class="command">vi</span> &mdash; with an explanation of the changes being
committed and the opportunity to enter a log message.

<pre class="smallexample">     polling implementation of src/apple.c
     MT:
     MT: ----------------------------------------------------------------------
     MT: Enter Log.  Lines beginning with `MT:' are removed automatically
     MT:
     MT: new_manifest [b33cb337dccf21d6673f462d677a6010b60699d1]
     MT:
     MT: old_revision [2e24d49a48adf9acf3a1b6391a080008cbef9c21]
     MT: old_manifest [2098eddbe833046174de28172a813150a6cbda7b]
     MT:
     MT: patch "src/apple.c"
     MT: from [2650ffc660dd00a08b659b883b65a060cac7e560]
     MT:   to [e2c418703c863eabe70f9bde988765406f885fd0]
     MT:
     MT: ----------------------------------------------------------------------
     MT:
</pre>
   <p>Abe enters a single line above the explanatory message, saying
&ldquo;polling implementation of src/apple.c&rdquo;. He then saves the file and
quits the editor. Monotone deletes all the lines beginning with
&ldquo;MT:&rdquo; and leaves only Abe's short message. Returning to the shell,
Abe's commit completes:

<pre class="smallexample">     monotone: committed revision 70decb4b31a8227a629c0e364495286c5c75f979
</pre>
   <p>Abe then sends his new revision back to Jim:

<pre class="smallexample">     $ monotone sync
     monotone: connecting to jim-laptop.juicebot.co.jp
     monotone: finding items to synchronize:
     monotone:   certs |    keys | revisions
     monotone:       8 |       2 |         2
     monotone: bytes in | bytes out | revs in | revs out | revs written
     monotone:      615 |      2822 |       0 |        1 |            0
     monotone: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p>Beth does a similar sequence. First she syncs her database with
Jim's:

<pre class="smallexample">     $ monotone --db=beth.db sync jim-laptop.juicebot.co.jp "jp.co.juicebot.jb7*"
     monotone: setting default server to jim-laptop.juicebot.co.jp
     monotone: setting default branch include pattern to 'jp.co.juicebot.jb7*'
     monotone: setting default branch exclude pattern to ''
     monotone: connecting to jim-laptop.juicebot.co.jp
     monotone: first time connecting to server jim-laptop.juicebot.co.jp:5253
     monotone: I'll assume it's really them, but you might want to double-check
     monotone: their key's fingerprint: 9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c
     monotone: warning: saving public key for jim@juicebot.co.jp to database
     monotone: finding items to synchronize:
     monotone: bytes in | bytes out | revs in | revs out | revs written
     monotone:     4601 |      1239 |       2 |        0 |            1
     monotone: verifying new revisions (this may take a while)
     monotone: bytes in | bytes out | revs in | revs out | revs written
     monotone:     4601 |      1285 |       2 |        0 |            2
     monotone: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p>She checks out a copy of the tree from her database:

<pre class="smallexample">     $ monotone --db=beth.db --branch=jp.co.juicebot.jb7 checkout .
</pre>
   <p>She edits the file <span class="file">src/banana.c</span>:

<pre class="smallexample">     $ vi src/banana.c
     <i>&lt;Beth writes some banana-juice dispensing code&gt;</i>
</pre>
   <p>and logs her changes in <span class="file">MT/log</span> right away so she does not
forget what she has done like Abe.

<pre class="smallexample">     $ vi MT/log
     * src/banana.c: Added polling implementation
</pre>
   <p>Later, she commits her work.  Monotone again invokes an external editor
for her to edit her log message, but this time it fills in the messages
she's written so far, and she simply checks them over one last time
before finishing her commit:

<pre class="smallexample">     $ monotone commit
     monotone: beginning commit on branch 'jp.co.juicebot.jb7'
     monotone: committed revision 80ef9c9d251d39074d37e72abf4897e0bbae1cfb
</pre>
   <p>And she syncs with Jim again:

<pre class="smallexample">     $ monotone sync
     monotone: connecting to jim-laptop.juicebot.co.jp
     monotone: finding items to synchronize:
     monotone:   certs |    keys | revisions
     monotone:      12 |       3 |         3
     monotone: bytes in | bytes out | revs in | revs out | revs written
     monotone:      709 |      2879 |       0 |        1 |            0
     monotone: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p><a name="Dealing-with-a-Fork"></a>

<h3 class="section">2.10 Dealing with a Fork</h3>

<p>Careful readers will note that, in the previous section, the JuiceBot
company's work was perfectly serialized:

     <ol type=1 start=1>
<li>Jim did some work
<li>Abe synced with Jim
<li>Abe did some work
<li>Abe synced with Jim
<li>Beth synced with Jim
<li>Beth did some work
<li>Beth synced with Jim
        </ol>

   <p>The result of this ordering is that Jim's work entirely preceeded
Abe's work, which entirely preceeded Beth's work. Moreover, each
worker was fully informed of the &ldquo;up-stream&rdquo; worker's actions, and
produced purely derivative, &ldquo;down-stream&rdquo; work:

     <ol type=1 start=1>
<li>Jim made revision 2e24d... 
<li>Abe changed revision 2e24d... into revision 70dec... 
<li>Beth derived revision 70dec... into revision 80ef9...
        </ol>

   <p>This is a simple, but sadly unrealistic, ordering of events. In real
companies or work groups, people often work in parallel,
<em>diverging</em> from commonly known revisions and <em>merging</em>
their work together, sometime after each unit of work is complete.

   <p>Monotone supports this diverge/merge style of operation naturally; any
time two revisions diverge from a common parent revision, we say that
the revision graph has a <dfn>fork</dfn> in it. Forks can happen at any
time, and require no coordination between workers. In fact any
interleaving of the previous events would work equally well; with one
exception: if forks were produced, someone would eventually have to
run the <span class="command">merge</span> command, and possibly resolve any conflicts
in the fork.

   <p>To illustrate this, we return to our workers Beth and Abe. Suppose Jim
sends out an email saying that the current polling juice dispensers
use too much CPU time, and must be rewritten to use the JuiceBot's
interrupt system. Beth wakes up first and begins working immediately,
basing her work off the revision 80ef9... which is currently in her
working copy:

<pre class="smallexample">     $ vi src/banana.c
     <i>&lt;Beth changes her banana-juice dispenser to use interrupts&gt;</i>
</pre>
   <p>Beth finishes and examines her changes:

<pre class="smallexample">     $ monotone diff
     #
     # patch "src/banana.c"
     #  from [7381d6b3adfddaf16dc0fdb05e0f2d1873e3132a]
     #    to [5e6622cf5c8805bcbd50921ce7db86dad40f2ec6]
     #
     ============================================================================
     --- src/banana.c 7381d6b3adfddaf16dc0fdb05e0f2d1873e3132a
     +++ src/banana.c 5e6622cf5c8805bcbd50921ce7db86dad40f2ec6
     @ -1,10 +1,15 @
      #include "jb.h"
     
     +static void
     +shut_off_banana()
     +{
     +  spoutctl(BANANA_SPOUT, SET_INTR, 0);
     +  spoutctl(BANANA_SPOUT, FLOW_JUICE, 0);
     +}
     +
      void
     -dispense_banana_juice()
     +dispense_banana_juice()
      {
     +  spoutctl(BANANA_SPOUT, SET_INTR, &amp;shut_off_banana);
        spoutctl(BANANA_SPOUT, FLOW_JUICE, 1);
     -  while (spoutctl(BANANA_SPOUT, POLL_JUICE, 1) == 0)
     -    usleep (1000);
     -  spoutctl(BANANA_SPOUT, FLOW_JUICE, 0);
      }
</pre>
   <p>She commits her work:

<pre class="smallexample">     $ monotone commit --message="interrupt implementation of src/banana.c"
     monotone: beginning commit on branch 'jp.co.juicebot.jb7'
     monotone: committed revision 8b41b5399a564494993063287a737d26ede3dee4
</pre>
   <p>And she syncs with Jim:

<pre class="smallexample">     $ monotone sync
</pre>
   <p>Unfortunately, before Beth managed to sync with Jim, Abe had woken up
and implemented a similar interrupt-based apple juice dispenser, but
his working copy is 70dec..., which is still &ldquo;upstream&rdquo; of
Beth's.

<pre class="smallexample">     $ vi apple.c
     <i>&lt;Abe changes his apple-juice dispenser to use interrupts&gt;</i>
</pre>
   <p>Thus when Abe commits, he unknowingly creates a fork:

<pre class="smallexample">     $ monotone commit --message="interrupt implementation of src/apple.c"
</pre>
   <p>Abe does not see the fork yet; Abe has not actually seen <em>any</em> of
Beth's work yet, because he has not synchronized with Jim. Since
he has new work to contribute, however, he now syncs:

<pre class="smallexample">     $ monotone sync
</pre>
   <p>Now Jim and Abe will be aware of the fork. Jim sees it when he sits
down at his desk and asks monotone for the current set of heads of
the branch:

<pre class="smallexample">     $ monotone heads
     monotone: branch 'jp.co.juicebot.jb7' is currently unmerged:
     39969614e5a14316c7ffefc588771f491c709152 abe@juicebot.co.jp 2004-10-26T02:53:16
     8b41b5399a564494993063287a737d26ede3dee4 beth@juicebot.co.jp 2004-10-26T02:53:15
</pre>
   <p>Clearly there are two heads to the branch: it contains an un-merged
fork. Beth will not yet know about the fork, but in this case it
doesn't matter: anyone can merge the fork, and since there are no
conflicts Jim does so himself:

<pre class="smallexample">     $ monotone merge
     monotone: starting with revision 1 / 2
     monotone: merging with revision 2 / 2
     monotone: [source] 39969614e5a14316c7ffefc588771f491c709152
     monotone: [source] 8b41b5399a564494993063287a737d26ede3dee4
     monotone: common ancestor 70decb4b31a8227a629c0e364495286c5c75f979 abe@juicebot.co.jp  2004-10-26T:02:50:01 found
     monotone: trying 3-way merge
     monotone: [merged] da499b9d9465a0e003a4c6b2909102ef98bf4e6d
     monotone: your working copies have not been updated
</pre>
   <p>The output of this command shows Jim that two heads were found,
combined via a 3-way merge with their ancestor, and saved to a new
revision. This happened automatically, because the changes between the
common ancestor and heads did not conflict. If there had been a
conflict, monotone would have invoked an external merging tool to help
resolve it.

   <p>After merging, the branch has a single head again, and Jim updates
his working copy.

<pre class="smallexample">     $ monotone update
     monotone: selected update target da499b9d9465a0e003a4c6b2909102ef98bf4e6d
     monotone: updating src/apple.c to f088e24beb43ab1468d7243e36ce214a559bdc96
     monotone: updating src/banana.c to 5e6622cf5c8805bcbd50921ce7db86dad40f2ec6
     monotone: updated to base revision da499b9d9465a0e003a4c6b2909102ef98bf4e6d
</pre>
   <p>The update command selected an update target &mdash; in this case the newly merged
head &mdash; and performed an in-memory merge between Jim's working copy
and the chosen target. The result was then written to Jim's working copy. If
Jim's working copy had any uncommitted changes in it, they would have been
merged with the update in exactly the same manner as the merge of multiple
committed heads.

   <p>Monotone makes very little distinction between a &ldquo;pre-commit&rdquo; merge
(an update) and a &ldquo;post-commit&rdquo; merge. Both sorts of merge use the
exact same algorithm. The major difference concerns the recoverability
of the pre-merge state: if you commit your work first, and merge after
committing, then even if the merge somehow fails (due to difficulty in a
manual merge step, for instance), your committed state is still safe. 
If you update, on the other hand, you are requesting that monotone
directly modify your working copy, and while monotone will try hard not
to break anything, this process is inherently more open to error.  It is
therefore recommended that you commit your work <em>first</em>, before
merging.

   <p>If you have previously used another version control system, this may at
first seem surprising; there are some systems where you are
<em>required</em> to update, and risk the above problems, before you can
commit.  Monotone, however, was designed with this problem in mind, and
thus <em>always</em> allows you to commit before merging.  A good rule of
thumb is to only use <span class="command">update</span> in working copies with no local
modifications, or when you actually want to work against a different
base revision (perhaps because finishing your change turns out to
require some fixes made in another revision, or because you discover
that you have accidentally started working against a revision that
contains unrelated bugs, and need to back out to a working revision for
testing).

<p><a name="Branching-and-Merging"></a>

<h3 class="section">2.11 Branching and Merging</h3>

<p>So by now you're familiar with making changes, sharing them with other
people, and integrating your changes with their changes.  Sometimes,
though, you may want to make some changes, and <em>not</em> integrate them
with other people's &mdash; or at least not right away.  One way to do this
would be to simply never run <span class="command">monotone merge</span>; but it would
quickly become confusing to try and keep track of which changes were in
which revisions.  This is where <em>branches</em> are useful.

   <p>Continuing our example, suppose that Jim is so impressed by Beth's work
on banana juice support that he assigns her to work on the JuiceBot 7's
surprise new feature: muffins.  In the mean time, Abe will continue
working on the JuiceBot's basic juice-related functions.

   <p>The changes required to support muffins are somewhat complicated, and
Beth is worried that her work might destabilize the program, and
interfere with Abe's work.  In fact, she isn't even sure her first
attempt will turn out to be the right approach; she might work on it for
a while and then decide it was a bad idea, and should be discarded.  For
all these reasons, she decides that she will work on a branch, and then
once she is satisfied with the new code, she will merge back onto the
mainline.

   <p>She decides that since main development is in branch
<code>jp.co.juicebot.jb7</code>, she will use branch
<code>jp.co.juicebot.jb7.muffins</code>.  So, she makes the first few edits to
the new muffins code, and commits it on a new branch by simply passing
<span class="option">--branch</span> to commit:

<pre class="smallexample">     $ monotone commit --branch=jp.co.juicebot.jb7.muffins --message='autobake framework'
     monotone: beginning commit on branch 'jp.co.juicebot.jb7.muffins'
     monotone: committed revision d33caefd61823ecbb605c39ffb84705dec449857
</pre>
   <p>That's all there is to it &mdash; there is now a
<code>jp.co.juicebot.jb7.muffins</code> branch, with her initial checkin on
it.  She can make further checkins from the same working copy, and they
will automatically go to the muffins branch; if anyone else wants to
help her work on muffins, they can check out that branch as usual.

   <p>Of course, while Beth is working on the new muffins code, Abe is still
making fixes to the main line.  Occasionally, Beth wants to integrate
his latest work into the muffins branch, so that her version doesn't
fall too far behind.  She does this by using the <span class="command">propagate</span>
command:

<pre class="smallexample">     $ monotone propagate jp.co.juicebot.jb7 jp.co.juicebot.jb7.muffins
     monotone: propagating jp.co.juicebot.jb7 -&gt; jp.co.juicebot.jb7.muffins
     monotone: [source] da003f115752ac6e4750b89aaca9dbba178ac80c
     monotone: [target] d0e5c93bb61e5fd25a0dadf41426f209b73f40af
     monotone: common ancestor 853b8c7ac5689181d4b958504adfb5d07fd959ab jim@juicebot.co.jp 2004-10-26T:12:44:23 found
     monotone: trying 3-way merge
     monotone: [merged] 89585b3c5e51a5a75f5d1a05dda859c5b7dde52f
</pre>
   <p>The <span class="command">propagate</span> merges all of the new changes on one branch onto
another.

   <p>When the muffins code is eventually stable and ready to be integrated
into the main line of development, she simply propagates the other way:

<pre class="smallexample">     $ monotone propagate jp.co.juicebot.jb7.muffins jp.co.juicebot.jb7
     monotone: propagating jp.co.juicebot.jb7.muffins -&gt; jp.co.juicebot.jb7
     monotone: [source] 4e48e2c9a3d2ca8a708cb0cc545700544efb5021
     monotone: [target] bd29b2bfd07644ab370f50e0d68f26dcfd3bb4af
     monotone: common ancestor 652b1035343281a0d2a5de79919f9a31a30c9028 jim@juicebot.co.jp 2004-10-26T:15:25:05 found
     monotone: [merged] 03f7495b51cc70b76872ed019d19dee1b73e89b6
</pre>
   <p>Monotone always records the full history of all merges, and is designed
to handle an arbitrarily complicated graph of changes.  You can make a
branch, then branch off from that branch, propagate changes between
arbitrary branches, and so on; monotone will track all of it, and do
something sensible for each merge.  Of course, it is still probably a
good idea to come up with some organization of branches and a plan for
which should be merged to which other ones.  Monotone may keep track of
graphs of arbitrary complexity; but, you will have more trouble. 
Whatever arrangement of branches you come up with, though, monotone
should be able to handle it.

<p><a name="Advanced-Uses"></a>

<h2 class="chapter">3 Advanced Uses</h2>

<p>This chapter covers slightly less common aspects of using
monotone. Some users of monotone will find these helpful, though
possibly not all. We assume that you have read through the taxonomy
and tutorial, and possibly spent some time playing with the program to
familiarize yourself with its operation.

<p><a name="Selectors"></a>

<h3 class="section">3.1 Selectors</h3>

<p>Revisions can be specified on the monotone command line, precisely, by
entering the entire 40-character hexadecimal <span class="sc">sha1</span> code. This can
be cumbersome, so monotone also allows a more general syntax called
&ldquo;selectors&rdquo; which is less precise but more &ldquo;human friendly&rdquo;. Any
command which expects a precise revision ID can also accept a selector
in its place; in fact a revision ID is just a special type of selector
which is very precise.

<h3 class="heading">Simple examples</h3>

<p>Some selector examples are helpful in clarifying the idea:

     <dl>
<dt><code>a432</code><dd>Revision IDs beginning with the string <code>a432</code>
<br><dt><code>graydon@pobox.com/2004-04</code><dd>Revisions written by <code>graydon@pobox.com</code> in April 2004. 
<br><dt><code>"jrh@example.org/2 weeks ago"</code><dd>Revisions written by <code>jrh@example.org</code> 2 weeks ago. 
<br><dt><code>graydon/net.venge.monotone.win32/yesterday</code><dd>Revisions in the <code>net.venge.monotone.win32</code> branch, written by
<code>graydon</code>, yesterday. 
</dl>

   <p>A moment's examination reveals that these specifications are &ldquo;fuzzy&rdquo;
and indeed may return multiple values, or may be ambiguous. When
ambiguity arises, monotone will inform you that more detail is
required, and list various possibilities. The precise specification
of selectors follows.

<h3 class="heading">Selectors in detail</h3>

<p>A selector is a combination of a selector type, which is a single
xoASCII character, followed by a <code>:</code> character and a selector
string. All selectors strings except for selector type <code>c</code>
are just values. The value is matched against identifiers or certs,
depending on its type, in an attempt to match a single revision. 
Selectors are matched as prefixes. The current set of selection
types are:

     <dl>
<dt>Generic cert selector<dd>Uses selector type <code>c</code>.  The selector string has the syntax
<var>name</var> or <var>name</var><code>=</code><var>value</var>.  The former syntax will
select any revision that has a cert with that name, regardless of
value; the latter will match any revision that has a cert with that
name and value.  Values to match for can have shell wildcards. 
<br><dt>Author selection<dd>Uses selector type <code>a</code>. For example, <code>a:graydon</code> matches
<code>author</code> certs where the cert value contains <code>graydon</code>. 
<br><dt>Branch selection<dd>Uses selector type <code>b</code>. For example, <code>b:net.venge.monotone</code> matches
<code>branch</code> certs where the cert value is <code>net.venge.monotone</code>. 
Values to match for can have shell wildcards. 
<br><dt>Date selection<dd>Uses selector type <code>d</code>. For example, <code>d:2004-04</code> matches
<code>date</code> certs where the cert value begins with
<code>2004-04</code>. This selector also accepts expanded date syntax (see below). 
<br><dt>"Earlier or equal than" selection<dd>Uses selector type <code>e</code>. For example, <code>e:2004-04-25</code> matches
<code>date</code> certs where the cert value is less or equal than
<code>2004-04-25T00:00:00</code>. If the time component is unspecified,
monotone will assume 00:00:00. This selector also accepts expanded date
syntax (see below)
<br><dt>"Later than" selection<dd>Uses selector type <code>l</code>. For example, <code>l:2004-04-25</code> matches
<code>date</code> certs where the cert value is strictly less than
<code>2004-04-25T00:00:00</code>. If the time component is unspecified,
monotone will assume 00:00:00. This selector also accepts expanded date
syntax (see below)
<br><dt>Identifier selection<dd>Uses selector type <code>i</code>. For example, <code>i:0f3a</code> matches
revision IDs which begin with <code>0f3a</code>. 
<br><dt>Tag selection<dd>Uses selector type <code>t</code>. For example, <code>t:monotone-0.11</code> matches
<code>tag</code> certs where the cert value begins with <code>monotone-0.11</code>. 
Values to match for can have shell wildcards. 
</dl>

   <p>Further selector types may be added in the future.

<h3 class="heading">Composite selectors</h3>

<p>Selectors may be combined with the <code>/</code> character. The combination
acts as database intersection (or logical <code>and</code>). For example,
the selector <code>a:graydon/d:2004-04</code> can be used to select a
revision which has an <code>author</code> cert beginning with <code>graydon</code>
<em>as well as</em> a <code>date</code> cert beginning with <code>2004-04</code>.

<h3 class="heading">Selector expansion</h3>

<p>Before selectors are passed to the database, they are expanded using a
lua hook: <code>expand_selector</code>. The default definition of this hook
attempts to guess a number of common forms for selection, allowing you
to omit selector types in many cases. For example, the hook guesses
that the typeless selector <code>jrh@example.org</code> is an author
selector, due to its syntactic form, so modifies it to read
<code>a:jrh@example.org</code>. This hook will generally assign a selector
type to values which &ldquo;look like&rdquo; partial hex strings, email
addresses, branch names, or date specifications. For the complete
source code of the hook, see <a href="#Hook-Reference">Hook Reference</a>.

<h3 class="heading">Expanding dates</h3>

<p>All date-related selectors (<code>d</code>, <code>e</code>, <code>l</code>) support an
english-like syntax similar to CVS.  This syntax is expanded to the
numeric format by a lua hook: <code>expand_date</code>. 
The allowed date formats are:
     <dl>
<dt>now<dd>Expands to the current date and time. 
<br><dt>today<dd>Expands to today's date. <code>e</code> and <code>l</code> selectors assume time 00:00:00
<br><dt>yesterday<dd>Expands to yesterday's date. <code>e</code> and <code>l</code> selectors assume
time 00:00:00
<br><dt>&lt;number&gt; {minute|hour} &lt;ago&gt;<dd>Expands to today date and time, minus the specified <code>number</code> of
minutes|hours. 
<br><dt>&lt;number&gt; {day|week|month|year} &lt;ago&gt;<dd>Expands to today date, minus the specified <code>number</code> of
days|weeks|months|years. <code>e</code> and <code>l</code> selectors assume time
00:00:00
<br><dt>&lt;year&gt;-&lt;month&gt;[-day[Thour:minute:second]]<dd>Expands to the supplied year/month. The day and time component are
optional. If missing, <code>e</code> and <code>l</code> selectors assume the first
day of month and time 00:00:00. 
The time component, if supplied, must be complete to the second. 
</dl>

   <p>For the complete source code of the hook, see <a href="#Hook-Reference">Hook Reference</a>.

<h3 class="heading">Typeless selection</h3>

<p>If, after expansion, a selector still has no type, it is matched as a
special &ldquo;unknown&rdquo; selector type, which will match either a tag, an
author, or a branch. This costs slightly more database access, but
often permits simple selection using an author's login name and a
date. For example, the selector
<code>graydon/net.venge.monotone.win32/yesterday</code> would pass through
the selector <code>graydon</code> as an unknown selector; so long as there
are no branches or tags beginning with the string <code>graydon</code> this
is just as effective as specifying <code>a:graydon</code>.

<p><a name="Restrictions"></a>

<h3 class="section">3.2 Restrictions</h3>

<p>Several monotone commands accept optional <var>pathname...</var> arguments in
order to establish a &ldquo;restriction&rdquo;.  Restrictions are used to limit
the files and directories these commands examine for changes when
comparing the working copy to the revision it is based on. Restricting a
command to a specified set of files or directories simply ignores
changes to files or directories not included by the restriction.

   <p>The following commands all support restrictions using optional
<var>pathname...</var> arguments:

     <ul>
<li><span class="command">status</span>
<li><span class="command">diff</span>
<li><span class="command">revert</span>
<li><span class="command">commit</span>
<li><span class="command">list known</span>
<li><span class="command">list unknown</span>
<li><span class="command">list ignored</span>
<li><span class="command">list missing</span>
</ul>

   <p>Including either the old or new name of a renamed file or directory will
cause both names to be included in a restriction. If in doubt, the
<span class="command">status</span> command can be used to &ldquo;test&rdquo; a set of pathnames to
ensure that the expected files are included or excluded by a
restriction.

   <p>Commands which support restrictions also support the
<span class="option">--depth=</span><var>n</var>  option, where <var>n</var> specifies the maximum
number of directories to descend. For example, <var>n</var>=0 disables
recursion, <var>n</var>=1 means descend at most one directory, and so on.

   <p>The <span class="command">update</span> command does not allow for updates to a
restricted set of files, which may be slightly different than other
version control systems. Partial updates don't really make sense in
monotone, as they would leave the working copy based on a revision that
doesn't exist in the database, starting an entirely new line of
development.

<h3 class="heading">Subdirectory restrictions</h3>

<p>The restrictions facility also allows commands to operate from within a
subdirectory of the working copy.  By default, the <i>entire working
copy</i> is always examined for changes. However, specifying an explicit
"."  pathname to a command will restrict it to the current subdirectory. 
Note that this is quite different from other version control systems and
may seem somewhat surprising.

   <p>The expectation is that requiring a single "." to restrict to the
current subdirectory should be simple to use. While the alternative,
defaulting to restricting to the current subdirectory, would require a
somewhat complicated ../../.. sequence to remove the restriction and
operate on the whole tree.

   <p>This default was chosen because monotone versions whole project trees
and generally expects to commit all changes in the working copy as a
single atomic unit. Other version control systems often version
individual files or directories and may not support atomic commits at
all.

   <p>When working from within a subdirectory of the working copy all
paths specified to monotone commands must be relative to the current
subdirectory.

<h3 class="heading">Finding a working copy</h3>

<p>Monotone only stores a single <span class="file">MT</span> directory at the root of a
working copy. Because of this, a search is done to find the <span class="file">MT</span>
directory in case a command is executed from within a subdirectory of a
working copy. Before a command is executed, the search for a working
copy directory is done by traversing parent directories until an
<span class="file">MT</span> directory is found or the filesystem root is reached. Upon
finding an <span class="file">MT</span> directory, the <span class="file">MT/options</span> file is read for
default options. The <span class="option">--root</span> option may be used to stop the
search early, before reaching the root of the physical filesystem.

   <p>Many monotone commands don't require a working copy and will simply
proceed with no default options if no <span class="file">MT</span> directory is found. 
However, some monotone commands do require a working copy and will fail
if no <span class="file">MT</span> directory can be found.

   <p>The <span class="command">checkout</span> and <span class="command">setup</span> commands create a <i>new
working copy</i> and initialize a new <span class="file">MT/options</span> file based on their
current option settings.

<p><a name="Scripting"></a>

<h3 class="section">3.3 Scripting</h3>

<p>People often want to write programs that call monotone &mdash; for example,
to create a graphical interface to monotone's functionality, or to
automate some task.  For most programs, if you want to do this sort of
thing, you just call the command line interface, and do some sort of
parsing of the output.  Monotone's output, however, is designed for
humans: it's localized, it tries to prompt the user with helpful
information depending on their request, if it detects that something
unusual is happening it may give different output in an attempt to make
this clear to the user, and so on.  As a result, it is not particularly
suitable for programs to parse.

   <p>Rather than trying to design output to work for both humans and
computers, and serving neither audience well, we elected to create a
separate interface to make programmatically extracting information from
monotone easier.  The command line interface has a command
<code>automate</code>; this command has subcommands that print various sorts
of information on standard output, in simple, consistent, and easily
parseable form.

   <p>For details of this interface, see <a href="#Automation">Automation</a>.

<p><a name="Inodeprints"></a>

<h3 class="section">3.4 Inodeprints</h3>

<p>Fairly often, in order to accomplish its job, monotone has to look at
your working copy and figure out what has been changed in it since your
last commit.  Commands that do this include <span class="command">status</span>,
<span class="command">diff</span>, <span class="command">update</span>, <span class="command">commit</span>, and others.  There
are two different techniques it can use to do this.  The default, which
is sufficient for most projects, is to simply read every file in the
working copy, compute their <span class="sc">sha1</span> hash, and compare them to the
hashes monotone has stored.  This is very safe and reliable, and turns
out to be fast enough for most projects.  However, on very large
projects, ones whose source trees are many megabytes in size, it can
become unacceptably slow.

   <p>The other technique, known as <em>inodeprints</em>, is designed for this
situation.  When running in inodeprints mode, monotone does not read the
whole working copy; rather, it keeps a cache of interesting information
about each file (its size, its last modification time, and so on), and
skips reading any file for which these values have not changed.  This is
inherently somewhat less safe, and, as mentioned above, unnecessary for
most projects, so it is disabled by default.

   <p>If you do determine that it is necessary to use inodeprints with your
project, it is simple to enable them.  Simply run <span class="command">monotone
refresh_inodeprints</span>; this will enable inodeprints mode and generate an
initial cache.  If you ever wish to turn them off again, simply delete
the file <span class="file">MT/inodeprints</span>.  You can at any time delete or truncate
the <span class="file">MT/inodeprints</span> file; monotone uses it only as a cache and
will continue to operate correctly.

   <p>Normally, instead of enabling this up on a per-working-copy basis, you
will want to simply define the <code>use_inodeprints</code> hook to return
<code>true</code>; this will automatically enable inodeprints mode in any new
working copies you create.  See <a href="#Hook-Reference">Hook Reference</a> for details.

<p><a name="Quality-Assurance"></a>

<h3 class="section">3.5 Quality Assurance</h3>

<p>Monotone was constructed to serve both as a version control tool and
as a quality assurance tool. The quality assurance features permit
users to ignore, or &ldquo;filter out&rdquo;, versions which do not meet their
criteria for quality. This section describes the way monotone
represents and reasons about quality information.

   <p>Monotone often views the collection of revisions as a directed graph,
in which revisions are the nodes and changes between revisions are the
edges. We call this the <dfn>revision graph</dfn>. The revision graph has a
number of important subgraphs, many of which overlap. For example,
each branch is a subgraph of the revision graph, containing only the
nodes carrying a particular <code>branch</code> cert.

   <p>Many of monotone's operations involve searching the revision graph for
the ancestors or descendents of a particular revision, or extracting
the &ldquo;heads&rdquo; of a subgraph, which is the subgraph's set of nodes with
no descendents. For example, when you run the <code>update</code> command,
monotone searches the subgraph consisting of descendents of the base
revision of the current working copy, trying to locate a unique head to
update the base revision to.

   <p>Monotone's quality assurance mechanisms are mostly based on
restricting the subgraph each command operates on. There are two
methods used to restrict the subgraph:

     <ul>
<li>By restricting the set of trusted <code>branch</code> certificates, you
can require that specific code reviewers have approved of each edge in
the subgraph you focus on. 
<li>By restricting the set of trusted <code>testresult</code> certificates, you
can require that the <em>endpoints</em> of an update operation have a
certificate asserting that the revision in question passed a certain
test, or testsuite. 
</ul>

   <p>The evaluation of trust is done on a cert-by-cert basis by calling a
set of lua hooks: <code>get_revision_cert_trust</code>,
<code>get_manifest_cert_trust</code> and <code>get_file_cert_trust</code>. These
hooks are only called when a cert has at least one good signature from
a known key, and are passed <em>all</em> the keys which have signed the
cert, as well as the cert's ID, name and value. The hook can then
evaluate the set of signers, as a group, and decide whether to grant
or deny trust to the assertion made by the cert.

   <p>The evaluation of testresults is controlled by the
<code>accept_testresult_change</code> hook. This hook is called when
selecting update candidates, and is passed a pair of tables describing
the <code>testresult</code> certs present on the source and proposed
destination of an update. Only if the change in test results are
deemed &ldquo;acceptable&rdquo; does monotone actually select an update target
to merge into your working copy.

   <p>For details on these hooks, see the <a href="#Hook-Reference">Hook Reference</a>.

<p><a name="Vars"></a>

<h3 class="section">3.6 Vars</h3>

<p>Every monotone database has a set of <em>vars</em> associated with it. 
Vars are simple configuration variables that monotone refers to in some
circumstances; they are used for configuration that monotone needs to be
able to modify itself, and that should be per-database (rather than
per-user or per-working copy, both of which are supported by
<span class="file">monotonerc</span> scripts).  Vars are local to a database, and never
transferred by netsync.

   <p>A var is a <em>name</em> = <em>value</em> pairing inside a <em>domain</em>. 
Domains define what the vars inside it are used for; for instance, one
domain might contain database-global settings, and particular vars
inside it would define things like that database's default netsync
server.  Another domain might contain key fingerprints for servers that
monotone has interacted with in the past, to detect man-in-the-middle
attacks; the vars inside this domain would map server names to their
fingerprints.

   <p>You can set vars with the <span class="command">set</span> command, delete them with the
<span class="command">unset</span> command, and see them with the <span class="command">ls vars</span>
command.  See the documentation for these specific commands for more
details.

<h3 class="heading">Existing vars</h3>

<p>There are several pre-defined domains that monotone knows about:

     <dl>
<dt><code>database</code><dd>Contains database-global configuration information.  Defined names are:
          <dl>
<dt><code>default-server</code><dd>The default server for netsync operations to use.  Automatically set
by first use of netsync. 
<br><dt><code>default-include-pattern</code><dd>The default branch glob pattern for netsync operations to use. 
Automatically set by first use of netsync. 
</dl>

     <br><dt><code>known-servers</code><dd>Contains key hashes for servers that we have netsynced with in the
past.  Analogous to <span class="command">ssh</span>'s <span class="file">known_hosts</span> file, this is
needed to detect man-in-the-middle attacks.  Automatically set the first
time you netsync with any given server.  If that server's key later
changes, monotone will notice, and refuse to connect until you have run
<span class="command">monotone unset known-servers </span><var>server-name</var>.

   </dl>

<p><a name="Reserved-Files"></a>

<h3 class="section">3.7 Reserved Files</h3>

<p>A monotone working copy consists of control files and non-control
files. Each type of file can be versioned or non-versioned. These
classifications lead to four groups of files:

     <ul>
<li>versioned control files
<li>non-versioned control files
<li>versioned non-control files
<li>non-versioned non-control files
</ul>

   <p>Control files contain special content formatted for use by
monotone. Versioned files are recorded in a monotone database and have
their state tracked as they are modified.

   <p>If a control file is versioned, it is considered <em>part of</em> the
state of the working copy, and will be recorded as a manifest
entry. If a control file is not versioned, it is used to <em>manage</em>
the state of the working copy, but it not considered an intrinsic part
of it.

   <p>Most files you manage with monotone will be versioned non-control
files. For example, if you keep source code or documents in a monotone
database, they are versioned non-control files. Non-versioned,
non-control files in your working copy are generally temporary or junk
files, such as backups made by editors or object files made by
compilers. Such files are ignored by monotone.

<h3 class="heading">Identifying control files</h3>

<p>Control files are identified by their names. Non-control files can
have any name <em>except</em> the names reserved for control files. The
names of control files follow a regular pattern:

     <dl>
<dt>Versioned control files<dd>Any file name beginning with <span class="file">.mt-</span>
<br><dt>Non-versioned control files<dd>Any file in the directory <span class="file">MT/</span>
</dl>

<h3 class="heading">Existing control files</h3>

<p>The following control files are currently used. More control files may be added
in the future, but they will follow the patterns given above.

     <dl>
<dt><span class="file">.mt-attrs</span><dd>Contains versioned attributes of files, associated with the files'
pathnames. 
<br><dt><span class="file">.mt-ignore</span><dd>Contains a list of regular expression patterns, one per line. If it exists,
any file with a name matching one of these patterns is ignored. 
<br><dt><span class="file">MT/wanted-testresults</span><dd>Contains a list of testresult key names, one per line. If it exists, update
will only select revisions that do not have regressions according to the given
testresult keys. 
<br><dt><span class="file">MT/revision</span><dd>Contains the identity of the &ldquo;base&rdquo; revision of the working copy. 
Each working copy has a base revision. When the working copy is
committed, the base revision is considered to be the ancestor of the
committed revision. 
<br><dt><span class="file">MT/options</span><dd>Contains &ldquo;sticky&rdquo; command-line options such as <span class="option">--db</span> or
<span class="option">--branch</span>, such that you do not need to enter them repeatedly
after checking out a particular working copy. 
<br><dt><span class="file">MT/work</span><dd>Contains a list of additions, deletions, and renames which have occurred
in the current working copy, relative to the base version. 
<br><dt><span class="file">MT/log</span><dd>Contains log messages to append to the &ldquo;changelog&rdquo; cert upon
commit. The user may add content to this file while they work.  Upon a
successful commit monotone will empty the file making it ready for the
next edit/commit cycle. 
<br><dt><span class="file">MT/inodeprints</span><dd>If this file exists, monotone considers the directory to be in
<a href="#Inodeprints">Inodeprints</a> mode, and uses this file to cache the inodeprints. 
<br><dt><span class="file">MT/debug</span><dd>If monotone detects a bug in itself or crashes, then before exiting it
dumps a log of its recent activity to this file, to aid in debugging. 
</dl>

<p><a name="Reserved-Certs"></a>

<h3 class="section">3.8 Reserved Certs</h3>

<p>Every certificate has a name. Some names have meaning which is built
in to monotone, others may be used for customization by a particular
user, site, or community. If you wish to define custom certificates,
you should prefix such certificate names with <code>x-</code>. For example,
if you want to make a certificate describing the existence of security
vulnerabilities in a revision, you might wish to create a certificate
called <code>x-vulnerability</code>.  Monotone reserves all names which do
not begin with <code>x-</code> for possible internal use. If an <code>x-</code>
certificate becomes widely used, monotone will likely adopt it as a
reserved cert name and standardize its semantics.

   <p>Most reserved certificate names have no meaning yet; some do. Usually
monotone is also responsible for <em>generating</em> these certificates,
so you should generally have no cause to make them yourself. They are
described here to help you understand monotone's operation.

   <p>The pre-defined, reserved certificate names are:

     <dl>
<dt><code>author</code><dd>This cert's value is the name of a person who committed the revision
the cert is attached to. The cert is generated when you commit a
revision. It is displayed by the <code>log</code> command.

     <br><dt><code>branch</code><dd>This cert's value is the name of a branch. A <code>branch</code> cert
associates a revision with a branch. The revision is said to be &ldquo;in
the branch&rdquo; named by the cert. The cert is generated when you commit
a revision, either directly with the <code>commit</code> command or
indirectly with the <code>merge</code> or <code>propagate</code> commands. The
<code>branch</code> certs are read and directly interpreted by <em>many</em>
monotone commands, and play a fundamental role in organizing work in
any monotone database.

     <br><dt><code>changelog</code><dd>This cert's value is the change log message you provide when you
commit a revision. It is displayed by the <code>log</code> command.

     <br><dt><code>comment</code><dd>This cert's value is an additional comment, usually provided after
committing, about a revision. Certs with the name <code>comment</code> can
be applied to files as well, and will be shown by the <code>log</code>
command.

     <br><dt><code>date</code><dd>This cert's value is an ISO date string indicating the time at which a
revision was committed. It is displayed by the <code>log</code> command, and
may be used as an additional heuristic or selection criterion in other
commands in the future.

     <br><dt><code>tag</code><dd>This cert's value is a symbolic name given to a revision, which may be
used in the future as a way of selecting versions for <code>checkout</code>.

     <br><dt><code>testresult</code><dd>This cert's value is interpreted as a boolean string, either <code>0</code>
or <code>1</code>. It is generated by the <code>testresult</code> command and
represents the results of running a particular test on the underlying
revision. Typically you will make a separate signing key for each test
you intend to run on revisions. This cert influences the
<span class="command">update</span> algorithm.

   </dl>

<p><a name="Naming-Conventions"></a>

<h3 class="section">3.9 Naming Conventions</h3>

<p>Some names in monotone are private to your work, such as
filenames. Other names are potentially visible outside your project,
such as <span class="sc">rsa</span> key identifiers or branch names. It is possible that if
you choose such names carelessly, you will choose a name which someone
else in the world is using, and subsequently you may cause confusion
when your work and theirs is received simultaneously by some third
party.

   <p>We therefore recommend two naming conventions:

     <ul>
<li>For <span class="sc">rsa</span> keys, use the name of an active email address you
own. This will minimize conflicts, and also serves as a mnemonic to
associate your personal <em>identity</em> with signatures made with your
key. For example, monotone's primary author uses the key identifier
<code>graydon@pobox.com</code>.

     <li>For branch names, select any name you like but prefix it with the
&ldquo;inverted domain name&rdquo; of a DNS domain you control or are otherwise
authorized to use. This behavior mimics the package naming convention
in the java programming language. For example, monotone itself is
developed within the <code>net.venge.monotone</code> branch, because the
author owns the DNS domain <code>venge.net</code>. 
</ul>

<p><a name="File-Attributes"></a>

<h3 class="section">3.10 File Attributes</h3>

<p>Monotone contains a mechanism for storing <dfn>persistent file
attributes</dfn>.  These differ from file certificates in an important way:
attributes are associated with a path name in your working copy,
rather than a particular version of a file. Otherwise they are
similar: a file attribute associates a simple name/value pair with a
file in your working copy.

   <p>The attribute mechanism is motivated by the fact that some people like
to store executable programs in version control systems, and would like
the programs to remain executable when they check out a working copy. 
For example, the <code>configure</code> shell script commonly shipped with
many programs should be executable.

   <p>Similarly, some people would like to store devices, symbolic links,
read-only files, and all manner of extra attributes of a file, not
directly related to a file's data content.

   <p>Rather than try to extend the manifest file format to accommodate
attributes, monotone requires that you place your attributes in a
specially named file in the root of your working copy. The file is
called <span class="file">.mt-attrs</span>, and it has a simple stanza-based format, for
example:

<pre class="smallexample">     file "analyze_coverage"
     execute "true"
     
     file "autogen.sh"
     execute "true"
     otherattr "bob"
</pre>
   <p>Each stanze of the <span class="file">.mt-attrs</span> file assigns attributes to a file in
your working copy.  The first line of each stanza is <code>file</code>
followed by the quoted name of the file you want to assign attributes
to.  Each subsequent line is the name of an attribute, followed by a
quoted value for that attribute.  Stanzas are separated by blank lines.

   <p>As a convenience, you can use the <code>monotone attr</code> command to set
and view the values of these attributes; see <a href="#Working-Copy">Working Copy</a>.

   <p>You can tell monotone to automatically take actions based on these
attributes by defining hooks; see the <code>attr_functions</code> entry in
<a href="#Hook-Reference">Hook Reference</a>.

   <p>Every time your working copy is written to, monotone will look for the
<span class="file">.mt-attrs</span> file, and if it exists, run the corresponding hooks
registered for each attribute found in the file. This way, you can
extend the vocabulary of attributes understood by monotone simply by
writing new hooks.

   <p>Aside from its special interpretation, the <span class="file">.mt-attrs</span> file is a
normal text file. If you want other people to see your attributes, you
should <code>add</code> and <code>commit</code> the <span class="file">.mt-attrs</span> file in your
working copy. If you make changes to it which conflict with changes
other people make, you will have to resolve those conflicts, as plain
text, just as with any other text file in your working copy.

<p><a name="Merging"></a>

<h3 class="section">3.11 Merging</h3>

<p>Monotone has two merging modes, controlled by the <code>manual_merge</code>
attribute. 
By default all files are merged in automatic mode, unless the
<code>manual_merge</code> attribute for that file is present and
<code>true</code>. 
In automatic mode files are merged without user intervention, using
monotone internal three-way merging algorithm. 
Only if there are conflicts or an ancestor is not available monotone
switches to manual mode, essentially escalating the merging to the user. 
When working in manual mode, monotone invokes the merge2 (for two-way
merging) or merge3 (three-way) hooks to start an user defined external
merge tool. 
If the tool terminates without writing the merged file, monotone aborts the
merging, reverting any changes made. 
By redefining the aforementioned hooks the user can not only choose a
preferred merge tool, but even select different programs for different
file types.  For example, gimp for .png files, OpenOffice.org for
.doc, and so on. 
Starting with monotone 0.20, the <code>manual_merge</code> attribute is
automatically set at add time for all &ldquo;binary&rdquo; files, i.e. all files
for wich the <code>binary_file</code> hook returns true. 
Currently, this means all files with extension gif, jpeg, png, bz2, gz
and zip, plus files containing at least one of the following
bytes:

<pre class="smallexample">     0x00 thru 0x06
     0x0E thru 0x1a
     0x1c thru 0x1f
</pre>
   <p>The attribute could also be manually forced or removed using the
appropriate monotone commands. 
Remember that monotone switches to manual merging even if only one of
the files to be merged has the <code>manual_merge</code> attribute set.

<p><a name="Migrating-and-Dumping"></a>

<h3 class="section">3.12 Migrating and Dumping</h3>

<p>While the state of your database is logically captured in terms of a
packet stream, it is sometimes necessary or desirable (especially
while monotone is still in active development) to modify the SQL table
layout or storage parameters of your version database, or to make
backup copies of your database in plain text. These issues are not
properly addressed by generating packet streams: instead, you must use
<dfn>migration</dfn> or <dfn>dumping</dfn> commands.

   <p>The <span class="command">monotone db migrate</span> command is used to alter the SQL
schema of a database. The schema of a monotone database is identified
by a special hash of its generating SQL, which is stored in the
database's auxiliary tables. Each version of monotone knows which
schema version it is able to work with, and it will refuse to operate
on databases with different schemas. When you run the
<span class="command">migrate</span> command, monotone looks in an internal list of SQL
logic which can be used to perform in-place upgrades. It applies
entries from this list, in order, attempting to change the database it
<em>has</em> into the database it <em>wants</em>. Each step of this
migration is checked to ensure no errors occurred and the resulting
schema hashes to the intended value. The migration is attempted inside
a transaction, so if it fails &mdash; for example if the result of
migration hashes to an unexpected value &mdash; the migration is aborted.

   <p>If more drastic changes to the underlying database are made, such as
changing the page size of sqlite, or if you simply want to keep a
plain text version of your database on hand, the <span class="command">monotone db
dump</span> command can produce a plain ASCII SQL statement which generates
the state of your database. This dump can later be reloaded using the
<span class="command">monotone db load</span> command.

   <p>Note that when reloading a dumped database, the schema of the dumped
database is <em>included</em> in the dump, so you should not try to
<span class="command">init</span> your database before a <span class="command">load</span>.

<p><a name="Importing-from-CVS"></a>

<h3 class="section">3.13 Importing from CVS</h3>

<p>Monotone is capable of reading CVS files directly and importing them
into a database. This feature is still somewhat immature, but
moderately large &ldquo;real world&rdquo; CVS trees on the order of 1GB have
successfully been imported.

   <p>Note however that the machine requirements for CVS trees of this size
are not trivial: it can take several hours on a modern system to
reconstruct the history of such a tree and calculate the millions of
cryptographic certificates involved. We recommend experimenting with
smaller trees first, to get a feel for the import process.

   <p>We will assume certain values for this example which will differ in your case:
     <ul>
<li>Your domain name, <code>example.net</code> in this example. 
<li>Your key name, <code>import@example.net</code> in this example. 
<li>Your project name, <code>wobbler</code> in this example. 
<li>Your database name, <span class="file">test.db</span> in this example. 
<li>Your CVS repository path, <span class="file">/usr/local/cvsroot</span> in this example. 
<li>The CVS module name for your project, <code>wobbler</code> in this example. 
</ul>

   <p>Accounting for these differences at your site, the following is an
example procedure for importing a CVS repository &ldquo;from scratch&rdquo;, and
checking the resulting head version of the import out into a working
copy:

<pre class="smallexample">     $ monotone --db=test.db db init
     $ monotone --db=test.db genkey import@example.net
     $ monotone --db=test.db --branch=net.example.wobbler cvs_import /usr/local/cvsroot/wobbler
     $ monotone --db=test.db --branch=net.example.wobbler checkout wobber-checkout
</pre>
   <p><a name="CVS-Phrasebook"></a>

<h2 class="chapter">4 CVS Phrasebook</h2>

<p>This chapter translates common CVS commands into monotone commands. It
is an easy alternative to reading through the complete command
reference.

<h3 class="heading">Checking Out a Tree</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ CVSROOT=:pserver:cvs.foo.com/wobbler
     $ cvs -d $CVSROOT checkout -r 1.2
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone pull www.foo.com com.foo.wobbler*
     $ monotone checkout --revision=fe37 wobbler
</pre>
<p><br></td></tr></table>

   <p>The CVS command contacts a network server, retrieves a revision, and
stores it in your working copy. There are two cosmetic differences
with the monotone command: remote databases are specified by hostnames
and globs, and revisions are denoted by <span class="sc">sha1</span> values (or
selectors).

   <p>There is also one deep difference: pulling revisions into your
database is a separate step from checking out a single revision; after
you have pulled from a network server, your database will contain
<em>several</em> revisions, possibly the entire history of a
project. Checking out is a separate step, after communication, which
only copies a particular revision out of your database and into a named
directory.

<h3 class="heading">Committing Changes</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs commit -m "log message"
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone commit --message="log message"
     $ monotone push www.foo.com com.foo.wobbler*
</pre>
<p><br></td></tr></table>

   <p>As with other networking commands, the communication step with
monotone is explicit: committing changes only saves them to the local
database. A separate command, <span class="command">push</span>, sends the changes to a
remote database.

<h3 class="heading">Incorporating New Changes</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs update -d
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone pull www.foo.com com.foo.wobbler*
     $ monotone merge
     $ monotone update
</pre>
<p><br></td></tr></table>

   <p>This command, like other networking commands, involves a separate
communication step with monotone. The extra command, <span class="command">merge</span>,
ensures that the branch your are working on has a unique head. You can
omit the <span class="command">merge</span> step if you only want <span class="command">update</span> to
examine descendents of your base revision, and ignore other heads on
your branch.

<h3 class="heading">Moving Working Copy to Another Revision</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs update -r FOO_TAG -d
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone update -r 830ac1a5f033825ab364f911608ec294fe37f7bc
     $ monotone update -r t:FOO_TAG
</pre>
<p><br></td></tr></table>

   <p>With a revision parameter, the <span class="command">update</span> command operates
similarly in monotone and CVS. One difference is that a subsequent
<span class="command">commit</span> will be based off the chosen revision in monotone,
while a <span class="command">commit</span> in the CVS case is not possible without going
back to the branch head again.  This version of <span class="command">update</span> can
thus be very useful if, for example, you discover that the tree you are
working against is somehow broken &mdash; you can <span class="command">update</span> to an
older non-broken version, and continue to work normally while waiting
for the tree to be fixed.

<h3 class="heading">Viewing Differences</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs diff
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone diff
</pre>
   <p><br></td></tr><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs diff -r 1.2 -r 1.4 myfile
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone diff -r 3e7db -r 278df myfile
</pre>
<p><br></td></tr></table>

   <p>Monotone's <span class="command">diff</span> command is modeled on that of CVS, so the
main features are the same: <span class="command">diff</span> alone prints the
differences between your working copy and its base revision, whereas
<span class="command">diff</span> accompanied by two revision numbers prints the
difference between those two revisions. The major difference between
CVS and monotone here is that monotone's revision numbers are
<em>revision IDs</em>, rather than file IDs.  If one leaves off the file
argument, then diff can print the difference between two entire trees.

<h3 class="heading">Showing Working Copy Status</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs status
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone status
</pre>
<p><br></td></tr></table>

   <p>This command operates similarly in monotone and CVS. The only major
difference is that monotone's <span class="command">status</span> command always gives a
status of the whole tree, and outputs a more compact summary than CVS.

<h3 class="heading">Adding Directories and Files to Working Copy</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs add dir
     $ cvs add dir/subdir
     $ cvs add dir/subdir/file.txt
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone add dir/subdir/file.txt
</pre>
<p><br></td></tr></table>

   <p>Monotone does not explicitly store directories, so adding a file only
involves adding the file's complete path, including any directories. 
Directories are created as needed, and empty directories are ignored.

<h3 class="heading">Removing Directories and Files from Working Copy</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ rm file.txt
     $ cvs remove file.txt
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone drop file.txt
</pre>
<p><br></td></tr></table>

   <p>Monotone does not require that you erase a file from the working copy
before you drop it. Dropping a file merely removes its entry in the
manifest of the current revision.

<h3 class="heading">Viewing History</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs log [file]
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone log [file]
</pre>
<p><br></td></tr></table>

   <p>Unlike CVS log, monotone log can also be used without a working
directory; but in this case you must pass a <span class="option">--revision</span> argument
to tell monotone where to start displaying the log from.

<h3 class="heading">Importing a New Project</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs import wobbler vendor start
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone --db=/path/to/database.db --branch=com.foo.wobbler setup .
     $ monotone add .
     $ monotone commit
</pre>
<p><br></td></tr></table>

   <p>The <span class="command">setup</span> command turns an ordinary directory into a
monotone working copy.  After that, you can add your files and commit
them as usual.

<h3 class="heading">Initializing a Repository</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs init -d /path/to/repository
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ monotone db init --db=/path/to/database.db
</pre>
<p><br></td></tr></table>

   <p>Monotone's &ldquo;repository&rdquo; is a single-file database, which is created
and initialized by this command. This file is only ever used by you,
and does not need to be in any special location, or readable by other
users.

<p><a name="Command-Reference"></a>

<h2 class="chapter">5 Command Reference</h2>

<p>Monotone has a large number of commands. To help navigate through them
all, commands are grouped into logical categories.

<p><a name="Tree"></a>

<h3 class="section">5.1 Tree</h3>

     <dl>
<dt><span class="command">monotone cat </span><var>path</var><a name="index-monotone-cat-_0040var_007bpath_007d-1"></a><dt><span class="command">monotone cat --revision=</span><var>id</var> <var>path</var><a name="index-monotone-cat-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpath_007d-2"></a><dd>
Write the contents of a specific file <var>path</var> to standard output.

     <p>Without a <span class="option">--revision</span> argument, the command outputs the
contents of <var>path</var> as found in the current revision. This requires
the command be executed from within a working copy.

     <p>With an explicit <span class="option">--revision</span> argument, the command outputs
contents of <var>path</var> at that revision.

     <br><dt><span class="command">monotone checkout --revision=</span><var>id</var> <var>directory</var><a name="index-monotone-checkout-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-3"></a><dt><span class="command">monotone co --revision=</span><var>id</var> <var>directory</var><a name="index-monotone-co-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-4"></a><dt><span class="command">monotone --branch=</span><var>branchname</var><span class="command"> checkout </span><var>directory</var><a name="index-monotone-_002d_002dbranch_003d_0040var_007bbranchname_007d-checkout-_0040var_007bdirectory_007d-5"></a><dt><span class="command">monotone --branch=</span><var>branchname</var><span class="command"> co </span><var>directory</var><a name="index-monotone-_002d_002dbranch_003d_0040var_007bbranchname_007d-co-_0040var_007bdirectory_007d-6"></a><dd>
These commands copy a revision <var>id</var> out of your database, writing
the string <var>id</var> into the file
<var>directory</var><span class="file">/MT/revision</span>. These commands then copy every
file version listed in the revision's manifest to paths under
<var>directory</var>. For example, if the revision's manifest contains
these entries:

     <pre class="smallexample">          84e2c30a2571bd627918deee1e6613d34e64a29e  Makefile
          c61af2e67eb9b81e46357bb3c409a9a53a7cdfc6  include/hello.h
          97dfc6fd4f486df95868d85b4b81197014ae2a84  src/hello.c
     </pre>
     <p>Then the following files are created:
     <pre class="smallexample">          <var>directory</var>/Makefile
          <var>directory</var>/include/hello.h
          <var>directory</var>/src/hello.c
     </pre>
     <p>If you wish to <span class="command">checkout</span> in the current directory, you can
supply the special name <span class="file">.</span> (a single period) for
<var>directory</var>.

     <p>If no <var>id</var> is provided, as in the latter two commands, you
<em>must</em> provide a <var>branchname</var>; monotone will attempt to infer
<var>id</var> as the unique head of <var>branchname</var> if it exists.

     <br><dt><span class="command">monotone disapprove </span><var>id</var><a name="index-monotone-disapprove-_0040var_007bid_007d-7"></a><dd>
This command records a disapproval of the changes between <var>id</var>'s
ancestor and <var>id</var>. It does this by committing the <i>inverse</i>
changes as a new revision descending from <var>id</var>. The new revision
will show up as a new head and thus a subsequent <span class="command">merge</span> will
incorporate the inverse of the disapproved changes in the other head(s).

     <p>Note that this command only works if <var>id</var> has exactly one ancestor.

     <br><dt><span class="command">monotone heads --branch=</span><var>branchname</var><a name="index-monotone-heads-_002d_002dbranch_003d_0040var_007bbranchname_007d-8"></a><dd>This command lists the &ldquo;heads&rdquo; of <var>branchname</var>.

     <p>The &ldquo;heads&rdquo; of a branch is the set of revisions which are members of
the branch, but which have no descendents. These revisions are
generally the &ldquo;newest&rdquo; revisions committed by you or your
colleagues, at least in terms of ancestry. The heads of a branch may
not be the newest revisions, in terms of time, but synchronization of
computer clocks is not reliable, so monotone usually ignores time.

     <br><dt><span class="command">monotone merge [--branch=</span><var>branchname</var><span class="command">]</span><a name="index-monotone-merge-_005b_002d_002dbranch_003d_0040var_007bbranchname_007d_005d-9"></a><br><dt><span class="command">monotone merge --lca [--branch=</span><var>branchname</var><span class="command">]</span><a name="index-monotone-merge-_002d_002dlca-_005b_002d_002dbranch_003d_0040var_007bbranchname_007d_005d-10"></a><dd>This command merges the &ldquo;heads&rdquo; of <var>branchname</var>, if there are
multiple heads, and commits the results to the database, marking the
resulting merged revision as a member of <var>branchname</var>. The merged
revision will contain each of the head revision IDs as ancestors.

     <p>Merging is performed by repeated pairwise merges: two heads are
selected, then their least common ancestor is located in the ancestry
graph and these 3 revisions are provided to the built-in 3-way merge
algorithm. The process then repeats for each additional head, using
the result of each previous merge as an input to the next.

     <p>The <span class="option">--lca</span> option is provided as a temporary workaround for some
inherent problems with 3-way merging; if you encounter a huge number of
spurious conflicts, or get an invariant failure, then you may wish to
try using <span class="option">--lca</span>.  Using it <em>can</em>, in certain
circumstances, cause some edits that should be conflicts to merge
cleanly instead, which is why it is not the default; but these cases are
rare, and until we can find something better than 3-way merging to use,
you may find this option more convenient than <span class="command">explicit_merge</span>

     <br><dt><span class="command">monotone propagate </span><var>sourcebranch</var> <var>destbranch</var><a name="index-monotone-propagate-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-11"></a><br><dt><span class="command">monotone propagate --lca </span><var>sourcebranch</var> <var>destbranch</var><a name="index-monotone-propagate-_002d_002dlca-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-12"></a><dd>This command takes a unique head from <var>sourcebranch</var> and merges it
with a unique head of <var>destbranch</var>, using the least common
ancestor of the two heads for a 3-way merge. The resulting revision is
committed to <var>destbranch</var>. If
either <var>sourcebranch</var> or <var>destbranch</var> has multiple heads,
<span class="command">propagate</span> aborts, doing nothing.

     <p>The purpose of <span class="command">propagate</span> is to copy all the changes on
<var>sourcebranch</var>, since the last <span class="command">propagate</span>, to
<var>destbranch</var>. This command supports the idea of making separate
branches for medium-length development activities, such as
maintenance branches for stable software releases, trivial bug fix
branches, public contribution branches, or branches devoted to the
development of a single module within a larger project.

     <p>The <span class="option">--lca</span> option is provided as a temporary workaround for some
inherent problems with 3-way merging; if you encounter a huge number of
spurious conflicts, or get an invariant failure, then you may wish to
try using <span class="option">--lca</span>.  Using it <em>can</em>, in certain
circumstances, cause some edits that should be conflicts to merge
cleanly instead, which is why it is not the default; but these cases are
rare, and until we can find something better than 3-way merging to use,
you may find this option more convenient than <span class="command">explicit_merge</span>

     <br><dt><span class="command">monotone explicit_merge </span><var>id</var> <var>id</var> <var>destbranch</var><a name="index-monotone-explicit_005fmerge-_0040var_007bid_007d-_0040var_007bid_007d-_0040var_007bdestbranch_007d-13"></a><dt><span class="command">monotone explicit_merge </span><var>id</var> <var>id</var> <var>ancestor</var> <var>destbranch</var><a name="index-monotone-explicit_005fmerge-_0040var_007bid_007d-_0040var_007bid_007d-_0040var_007bancestor_007d-_0040var_007bdestbranch_007d-14"></a><dd>This command merges exactly the two <var>id</var>s you give it, and places
the result in branch <var>destbranch</var>.  It is useful when you need more
control over the merging process than <code>propagate</code> or <code>merge</code>
give you.  For instance, if you have a branch with three heads, and you
only want to merge two of them, you can use this command.  Or if you
have a branch with two heads, and you want to propagate one of them to
another branch, again, you can use this command. If the optional
<var>ancestor</var> argument is given, the merge uses that revision as the
common ancestor instead of the default ancestor. 
</dl>

<p><a name="Working-Copy"></a>

<h3 class="section">5.2 Working Copy</h3>

     <dl>
<dt><span class="command">monotone add </span><var>pathname...</var><a name="index-monotone-add-_0040var_007bpathname_002e_002e_002e_007d-15"></a><dd>This command places &ldquo;add&rdquo; entries for the paths specified in
<var>pathname...</var> in the working copy's &ldquo;work list&rdquo;. The work list
of your working copy is located at <span class="file">MT/work</span>, and is a list of
explicit pathname changes you wish to commit at some future time, such
as addition, removal or renaming of files.

     <p>While this command places an &ldquo;add&rdquo; entry on your work list, it does
not immediately affect your database. When you <span class="command">commit</span> your
working copy, monotone will use the work list to build a new revision,
which it will then commit to the database. The new revision will have
any added entries inserted in its manifest.

     <br><dt><span class="command">monotone drop </span><var>pathname...</var><a name="index-monotone-drop-_0040var_007bpathname_002e_002e_002e_007d-16"></a><dd>This command places &ldquo;drop&rdquo; entries for the paths specified in
<var>pathname...</var> in the working copy's &ldquo;work list&rdquo;. The work list of
your working copy is located at <span class="file">MT/work</span>, and is a list of
explicit pathname changes you wish to commit at some future time, such
as addition, removal, or renaming of files.  This command also removes
any attributes on <var>pathname</var>; see <a href="#File-Attributes">File Attributes</a> for more
details.

     <p>While this command places a &ldquo;drop&rdquo; entry on your work list, it does
not immediately affect your database. When you <span class="command">commit</span> your
working copy, monotone will use the work list to build a new revision,
which it will then commit to the database. The new revision will have
any dropped entries removed from its manifest.

     <p>Currently this command does <em>not</em> actually delete the file
<var>src</var> in your filesystem; if you want to actually delete the file,
you should run <span class="command">drop</span>, and then perform the actual delete using
whatever mechanism you normally use to delete files.

     <br><dt><span class="command">monotone rename </span><var>src</var> <var>dst</var><a name="index-monotone-rename-_0040var_007bsrc_007d-_0040var_007bdst_007d-17"></a><dd>This command places &ldquo;rename&rdquo; entries for the paths specified in
<var>src</var> and <var>dst</var> in the working copy's &ldquo;work list&rdquo;. The work
list of your working copy is located at <span class="file">MT/work</span>, and is a list of
explicit pathname changes you wish to commit at some future time, such
as addition, removal, or renaming of files.  This command also moves any
attributes on <var>src</var> to <var>dst</var>; see <a href="#File-Attributes">File Attributes</a> for more
details.

     <p>While this command places a &ldquo;rename&rdquo; entry on your work list, it
does not immediately affect your database. When you <span class="command">commit</span>
your working copy, monotone will use the work list to build a new
revision, which it will then commit to the database. The new revision
will have any renamed entries in its manifest adjusted to their new
names.

     <p>Currently this command does <em>not</em> actually rename the file
<var>src</var> in your filesystem; after you run this command, you should do
the actual rename, using whatever mechanism you normally use to rename
files.

     <br><dt><span class="command">monotone commit</span><a name="index-monotone-commit-18"></a><dt><span class="command">monotone commit --message=</span><var>logmsg</var><a name="index-monotone-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-19"></a><dt><span class="command">monotone commit --message-file=</span><var>logfile</var><a name="index-monotone-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-20"></a><dt><span class="command">monotone commit </span><var>pathname...</var><a name="index-monotone-commit-_0040var_007bpathname_002e_002e_002e_007d-21"></a><dt><span class="command">monotone commit --message=</span><var>logmsg</var> <var>pathname...</var><a name="index-monotone-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-_0040var_007bpathname_002e_002e_002e_007d-22"></a><dt><span class="command">monotone commit --message-file=</span><var>logfile</var> <var>pathname...</var><a name="index-monotone-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-_0040var_007bpathname_002e_002e_002e_007d-23"></a><dd>
This command looks at your working copy, decides which files have
changed, and saves the changes to your database. It does this by loading
the revision named in the <span class="file">MT/revision</span> file, locating the base
manifest for your working copy, applying any changes described in the
<span class="file">MT/work</span> file, and then comparing the updated base manifest to the
files it finds in your working copy, to determine which files have been
edited.

     <p>For each edited file, a delta is copied into the database. Then the
newly constructed manifest is recorded (as a delta) and finally the
new revision.  Once all these objects are recorded in you database,
<span class="command">commit</span> overwrites the <span class="file">MT/revision</span> file with the new
revision ID, and deletes the <span class="file">MT/work</span> file.

     <p>Specifying pathnames to <span class="command">commit</span> restricts the set of changes
that are visible and results in only a partial commit of the working
copy. Changes to files not included in the specified set of pathnames
will be ignored and will remain in the working copy until they are
included in a future commit. With a partial commit, only the relevant
entries in the <span class="file">MT/work</span> file will be removed and other entries
will remain for future commits.

     <p>From within a subdirectory of the working copy the <span class="command">commit</span>
command will, by default, include <em>all changes</em> in the working
copy.  Specifying only the pathname "." will restrict <span class="command">commit</span>
to files changed within the current subdirectory of the working copy.

     <p>The <span class="option">--message</span> and <span class="option">--message-file</span> options are mutually
exclusive.  Both provide a <var>logmsg</var> describing the commit. 
<span class="option">--message-file</span> actually specifies the name of the file containing
the log message, while <span class="option">--message</span> provides it directly.

     <p>The <span class="file">MT/log</span> file can be edited by the user during their daily work
to record the changes made to the working copy. When running the
<span class="command">commit</span> command without a <var>logmsg</var> supplied, the contents
of the <span class="file">MT/log</span> file will be read and passed to the Lua hook
<code>edit_comment</code> as a second parameter named <var>user_log_content</var>. 
If the commit is successful, the <span class="file">MT/log</span> file is cleared of
all content making it ready for another edit/commit cycle.

     <p>If a <span class="option">--branch</span> option is specified, the <span class="command">commit</span> command
commits to this branch (creating it if necessary).  The branch becomes
the new default branch of the working copy.

     <p>The <span class="command">commit</span> command also synthesizes a number of
certificates, which it attaches to the new manifest version and copies
into your database:
          <ul>
<li>An <code>author</code> cert, indicating the person responsible for the changes
leading to the new revision.  Normally this defaults to your signing key
or the return value of the <code>get_author</code> hook; you may override this
by passing the <span class="option">--author</span> option to commit.  This is useful when
committing a patch on behalf of someone else, or when importing &ldquo;by
hand&rdquo; from another version control system. 
<li>A <code>branch</code> cert, indicating the branch the committed revision
belongs to. 
<li>A <code>date</code> cert, indicating when the new revision was created. 
Normally this defaults to the current time; you may override this by
passing the <span class="option">--date</span> option to commit.  This is useful when
importing &ldquo;by hand&rdquo; from another version control system. 
<li>A <code>changelog</code> cert, containing the &ldquo;log message&rdquo; for these
changes.  If you provided <var>logmsg</var> on the command line, this text
will be used, otherwise <span class="command">commit</span> will run the Lua hook
<code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_content</var><code>)</code>, which
typically invokes an external editor program, in which you can compose
and/or review your log message for the change. 
</ul>

     <br><dt><span class="command">monotone revert</span><a name="index-monotone-revert-24"></a><dt><span class="command">monotone revert </span><var>pathname...</var><a name="index-monotone-revert-_0040var_007bpathname_002e_002e_002e_007d-25"></a><dd>
With no files given, this command changes your working copy, so that
changes you have made since the last checkout or update are discarded. 
It does this by changing every file listed in the working copy's base
manifest to have contents equal to the <span class="sc">sha1</span> value listed in the
manifest, and by erasing the <span class="file">MT/work</span> file.

     <p>If files or directories are given as arguments, only those files and
directories are affected instead of the entirety of your working copy.

     <p>From within a subdirectory of the working copy the <span class="command">revert</span>
command will, by default, revert <em>all changes</em> in the working copy. 
Specifying only the pathname "." will restrict <span class="command">revert</span> to files
changed within the current subdirectory of the working copy. <i>Caution
should be used when reverting files to ensure that the correct set of
files is reverted.</i>

     <br><dt><span class="command">monotone update</span><a name="index-monotone-update-26"></a><dt><span class="command">monotone update --revision=</span><var>revision</var><a name="index-monotone-update-_002d_002drevision_003d_0040var_007brevision_007d-27"></a><dd>Without a <span class="option">--revision</span> argument, this command incorporates
&ldquo;recent&rdquo; changes found in your database into your working copy. It
does this by performing 3 separate stages. If any of these stages
fails, the update aborts, doing nothing. The stages are:

          <ul>
<li>Examine the ancestry graph of revisions in your database, and (subject
to trust evaluation) select the set of all descendents of your working
copy's base revision. Call this set the &ldquo;candidates&rdquo; of the update. 
<li>Remove any candidates which lack acceptable testresult
certificates. From the remaining candidates, select the deepest child
by ancestry and call it the &ldquo;target&rdquo; of the update. 
<li>Merge the target of the update with the working copy, in memory, and
if the merge is successful, write the result over top of the working
copy. 
</ul>

     <p>With an explicit <span class="option">--revision</span> argument, the command uses that revision
as the update target instead of finding an acceptable candidate.

     <p>The effect is always to take whatever changes you have made in the
working copy, and to &ldquo;transpose&rdquo; them onto a new revision, using
monotone's 3-way merge algorithm to achieve good results.  Note that
with the explicit <span class="option">--revision</span> argument, it is possible to update
&ldquo;backwards&rdquo; or &ldquo;sideways&rdquo; in history &mdash; for example, reverting to
an earlier revision, or if your branch has two heads, updating to the
other.  In all cases, the end result will be whatever revision you
specified, with your local changes (and only your local changes)
applied.

     <p>If a <span class="option">--branch</span> option is specified, the <span class="command">update</span> command
tries to select the revision to update to from this branch.  The branch
becomes the new default branch of the working copy (even if you also
specify an explicit <span class="option">--revision</span> argument).

     <br><dt><span class="command">monotone refresh_inodeprints</span><a name="index-monotone-refresh_005finodeprints-28"></a><dd>This command puts the current working copy into <a href="#Inodeprints">Inodeprints</a> mode,
if it was not already, and forces a full inodeprints cache refresh. 
After running this command, you are guaranteed that your working copy is
in inodeprints mode, and that the inodeprints cache is accurate and up
to date.

</dl>

<p><a name="Network"></a>

<h3 class="section">5.3 Network</h3>

     <dl>
<dt><span class="command">monotone serve </span><var>address</var><span class="command">[:</span><var>port</var><span class="command">] </span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]</span><a name="index-monotone-serve-_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d-29"></a><dt><span class="command">monotone pull [--set-default] [</span><var>address</var><span class="command">[:</span><var>port</var><span class="command">] [</span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]]]</span><a name="index-monotone-pull-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-30"></a><dt><span class="command">monotone push [--set-default] [</span><var>address</var><span class="command">[:</span><var>port</var><span class="command">] [</span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]]]</span><a name="index-monotone-push-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-31"></a><dt><span class="command">monotone sync [--set-default] [</span><var>address</var><span class="command">[:</span><var>port</var><span class="command">] [</span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]]]</span><a name="index-monotone-sync-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-32"></a><dd>
These commands operate the &ldquo;netsync&rdquo; protocol built into
monotone. This is a custom protocol for rapidly synchronizing two
monotone databases using a hash tree index. The protocol is &ldquo;peer to
peer&rdquo;, but requires one peer to listen for incoming connections (the
server) and the other peer (the client) to connect to the server.

     <p>The network <var>address</var> specified in each case should be the same: a
host name to listen on, or connect to, optionally followed by a colon
and a port number.  The default port number is 5253. The <var>glob</var>
parameters indicate a set of branches to exchange.  Multiple <var>glob</var>
and <span class="option">--exclude</span> options can be specified; every branch which
matches a <var>glob</var> exactly, and does not match an <var>exclude-glob</var>,
will be indexed and made available for synchronization.

     <p>For example, perhaps Bob and Alice wish to synchronize their
<code>net.venge.monotone.win32</code> and <code>net.venge.monotone.i18n</code>
branches. Supposing Alice's computer has hostname
<code>alice.someisp.com</code>, then Alice might run:

     <pre class="smallexample">          $ monotone serve alice.someisp.com "net.venge.monotone*"
     </pre>
     <p>And Bob might run

     <pre class="smallexample">          $ monotone sync alice.someisp.com "net.venge.monotone*"
     </pre>
     <p>When the operation completes, all branches matching
<code>net.venge.monotone*</code> will be synchronized between Alice and Bob's
databases.

     <p>The <span class="command">pull</span>, <span class="command">push</span>, and <span class="command">sync</span> commands only
require you pass <var>address</var> and <var>glob</var> the first time you use one
of them; monotone will memorize this use and in the future default to
the same server and glob.  For instance, if Bob wants to <span class="command">sync</span>
with Alice again, he can simply run:

     <pre class="smallexample">          $ monotone sync
     </pre>
     <p>Of course, he can still <span class="command">sync</span> with other people and other
branches by passing an address or address plus globs on the command
line; this will not affect his default affinity for Alice.  If you ever
do want to change your defaults, simply pass the <span class="option">--set-default</span>
option when connecting to the server and branch pattern that you want to
make the new default.

     <p>In the server, different permissions can be applied to each branch; see
the hooks <code>get_netsync_read_permitted</code> and
<code>get_netsync_write_permitted</code> (see <a href="#Hook-Reference">Hook Reference</a>).

     <p>If a <span class="option">--pid-file</span> option is specified, the command
<span class="command">serve</span> will create the specified file and record the process
identifier of the server in the file.  This file can then be read to
identify specific monotone server processes.

     <p>The syntax for patterns is very simple.  <code>*</code> matches 0 or more
arbitrary characters.  <code>?</code> matches exactly 1 arbitrary character. 
<code>{foo,bar,baz}</code> matches &ldquo;foo&rdquo;, or &ldquo;bar&rdquo;, or &ldquo;baz&rdquo;.  These
can be combined arbitrarily.  A backslash, <code>\</code>, can be prefixed to
any character, to match exactly that character &mdash; this might be useful
in case someone, for some odd reason, decides to put a &ldquo;*&rdquo; into their
branch name.

</dl>

<p><a name="Informative"></a>

<h3 class="section">5.4 Informative</h3>

     <dl>
<dt><span class="command">monotone status</span><a name="index-monotone-status-33"></a><dt><span class="command">monotone status </span><var>pathname...</var><a name="index-monotone-status-_0040var_007bpathname_002e_002e_002e_007d-34"></a><dd>
This command prints a description of the &ldquo;status&rdquo; of your working copy. 
In particular, it prints:
          <ul>
<li>The &ldquo;base revision ID&rdquo; and &ldquo;base manifest ID&rdquo;, which are
referenced by the file <span class="file">MT/revision</span>, and which your working copy
is an in-progress descendent of. 
<li>The &ldquo;current manifest ID&rdquo;, which is the ID of the manifest which
results from applying <span class="file">MT/work</span> to the base manifest, and
updating any <span class="sc">sha1</span> values of files to reflect changes you have
made to the working copy. In other words, the current manifest ID is
the ID which would accompany any revision you would commit, if you ran
<span class="command">monotone commit</span>. 
<li>A list of logical changes between the base and current manifest
versions, such as adds, drops, renames, and patches. 
</ul>

     <p>Specifying optional <var>pathname...</var> arguments to the <span class="command">status</span>
command restricts the set of changes that are visible and results in
only a partial status of the working copy. Changes to files not included
in the specified set of pathnames will be ignored.

     <p>From within a subdirectory of the working copy the <span class="command">status</span>
command will, by default, include <em>all changes</em> in the working
copy.  Specifying only the pathname "." will restrict <span class="command">status</span>
to files changed within the current subdirectory of the working copy.

     <br><dt><span class="command">monotone log</span><a name="index-monotone-log-35"></a><dt><span class="command">monotone log [--last=</span><var>n</var><span class="command">] [--revision=</span><var>id</var><span class="command"> [...]] [--brief] [</span><var>file</var><span class="command"> [...]]</span><a name="index-monotone-log-_005b_002d_002dlast_003d_0040var_007bn_007d_005d-_005b_002d_002drevision_003d_0040var_007bid_007d-_005b_002e_002e_002e_005d_005d-_005b_002d_002dbrief_005d-_005b_0040var_007bfile_007d-_005b_002e_002e_002e_005d_005d-36"></a><dd>
This command prints out a log, in reverse-ancestry order, of small
history summaries.  Each summary contains author, date, changelog and
comment information associated with a revision.  If <code>--brief</code> is
given, the output consists of one line per revision with the revision
ID, the author, the date and the branches (separated with commas).

     <p>If <code>--last=</code><var>n</var> is given, at most that many log entries will be
given.

     <p>If one or more revision IDs are given, the command starts tracing back
through history from these revisions, otherwise it starts from the base
revision of your working copy.

     <p>If one or more files are given, the command will only log the revisions
where those files are changed.

     <br><dt><span class="command">monotone annotate </span><var>file</var><a name="index-monotone-annotate-_0040var_007bfile_007d-37"></a><dt><span class="command">monotone annotate --revision=</span><var>id</var> <var>file</var><a name="index-monotone-annotate-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bfile_007d-38"></a><dd>
Dumps an annotated copy of the file to stdout.  Each line of the file
is translated to &lt;revision id&gt;: &lt;line&gt; in the output, where &lt;revision id&gt;
is the revision in which that line of the file was last edited.

     <br><dt><span class="command">monotone complete file </span><var>partial-id</var><a name="index-monotone-complete-file-_0040var_007bpartial_002did_007d-39"></a><dt><span class="command">monotone complete [--brief] key </span><var>partial-id</var><a name="index-monotone-complete-_005b_002d_002dbrief_005d-key-_0040var_007bpartial_002did_007d-40"></a><dt><span class="command">monotone complete manifest </span><var>partial-id</var><a name="index-monotone-complete-manifest-_0040var_007bpartial_002did_007d-41"></a><dt><span class="command">monotone complete [--brief] revision </span><var>partial-id</var><a name="index-monotone-complete-_005b_002d_002dbrief_005d-revision-_0040var_007bpartial_002did_007d-42"></a><dd>
These commands print out all known completions of a partial <span class="sc">sha1</span>
value, listing completions which are <code>file</code>, <code>manifest</code> or
<code>revision</code> IDs depending on which variant is used. For
example, suppose you enter this command and get this result:

     <pre class="smallexample">          $ monotone complete manifest fa36
          fa36deead87811b0e15208da2853c39d2f6ebe90
          fa36b76dd0139177b28b379fe1d56b22342e5306
          fa36965ec190bee14c5afcac235f1b8e2239bb2a
     </pre>
     <p>Then monotone is telling you that there are 3 manifests it knows
about, in its database, which begin with the 4 hex digits
<code>fa36</code>. This command is intended to be used by programmable
completion systems, such as those in <span class="command">bash</span> and <span class="command">zsh</span>.

     <p>The complete command for keys and revisions have a <code>--verbose</code> option. 
Programmable completion systems can use <code>--verbose</code> output to
present users with additional information about each completion option.

     <p>For example, verbose output for <code>revision</code> looks like this:
     <pre class="smallexample">          $ mt complete revision 01f
          01f5da490941bee1f0000f0561fc62eabfb2fa23 graydon@dub.net 2003-12-03T03:14:35
          01f992577bd8bcdcade0f89e724fd5dc2d2bbe8a kinetik@orcon.nz 2005-05-11T05:19:29
          01faad191d8d0474777c70b4d606782942333a78 kinetik@orcon.nz 2005-04-11T04:24:01
     </pre>
     <br><dt><span class="command">monotone diff</span><a name="index-monotone-diff-43"></a><br><dt><span class="command">monotone diff --context</span><a name="index-monotone-diff-_002d_002dcontext-44"></a><br><dt><span class="command">monotone diff --external [--diff-args=</span><var>argstring</var><span class="command">]</span><a name="index-monotone-diff-_002d_002dexternal-_005b_002d_002ddiff_002dargs_003d_0040var_007bargstring_007d_005d-45"></a><dt><span class="command">monotone diff </span><var>pathname...</var><a name="index-monotone-diff-_0040var_007bpathname_002e_002e_002e_007d-46"></a><dt><span class="command">monotone diff --revision=</span><var>id</var><a name="index-monotone-diff-_002d_002drevision_003d_0040var_007bid_007d-47"></a><dt><span class="command">monotone diff --revision=</span><var>id</var> <var>pathname...</var><a name="index-monotone-diff-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpathname_002e_002e_002e_007d-48"></a><dt><span class="command">monotone diff --revision=</span><var>id1</var><span class="command"> --revision=</span><var>id2</var><a name="index-monotone-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-49"></a><dt><span class="command">monotone diff --revision=</span><var>id1</var><span class="command"> --revision=</span><var>id2</var> <var>pathname...</var><a name="index-monotone-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-_0040var_007bpathname_002e_002e_002e_007d-50"></a><dd>
These commands print out GNU &ldquo;unified diff format&rdquo; textual difference
listings between various manifest versions. With no <span class="option">--revision</span>
options, <span class="command">diff</span> will print the differences between the
base revision and the current revision in the working copy.

     <p>With one <span class="option">--revision</span> option, <span class="command">diff</span> will print the
differences between the revision <var>id</var> and the current revision in
the working copy.  With two <span class="option">--revision</span> options <span class="command">diff</span>
will print the differences between revisions <var>id1</var> and <var>id2</var>,
ignoring any working copy.

     <p>In all cases, monotone will print a textual summary &ndash; identical to
the summary presented by <span class="command">monotone status</span> &ndash; of the logical
differences between revisions in lines proceeding the diff. These
lines begin with a single hash mark <code>#</code>, and should be ignored by
a program processing the diff, such as <span class="command">patch</span>.

     <p>Specifying pathnames to the <span class="command">diff</span> command restricts the set of
changes that are visible and results in only a partial diff between
two revisions. Changes to files not included in the specified set of
pathnames will be ignored.

     <p>From within a subdirectory of the working copy the <span class="command">diff</span>
command will, by default, include <em>all changes</em> in the working
copy.  Specifying only the pathname "." will restrict <span class="command">diff</span>
to files changed within the current subdirectory of the working copy.

     <p>The output format of <span class="command">diff</span> is controlled by the options
<span class="option">--unified</span>, <span class="option">--context</span>, and <span class="option">--external</span>. 
<span class="option">--unified</span> requests the &ldquo;unified diff&rdquo; format, the default
(analogous to running the program <code>diff -u</code>).  <span class="option">--context</span>
request the &ldquo;context diff&rdquo; format (analogous to running the program
<code>diff -c</code>).  Both of these formats are generated directly by
monotone, using its built-in diff algorithm.

     <p>Sometimes, you may want more flexibility in output formats; for these
cases, you can use <span class="option">--external</span>, which causes monotone to invoke
an external program to generate the actual output.  By default, the
external program is <code>diff</code>, and you can use the option
<span class="option">--diff-args</span> to pass additional arguments controlling
formatting.  The actual invocation of <code>diff</code>, default arguments
passed to it, and so on, are controlled by the hook
<code>external_diff</code>; see <a href="#Hooks">Hooks</a> for more details.

     <br><dt><span class="command">monotone list certs </span><var>id</var><a name="index-monotone-list-certs-_0040var_007bid_007d-51"></a><dd>
These commands will print out a list of certificates associated with
a particular revision <var>id</var>. Each line of the print out will
indicate:
          <ul>
<li>Whether the signature on the certificate is <code>ok</code> or <code>bad</code>
<li>The key ID of the signer of the certificate
<li>The name of the certificate
<li>The value of the certificate
</ul>

     <p>For example, this command lists the certificates associated with a
particular version of monotone itself, in the monotone development
branch:

     <pre class="smallexample">          $ monotone list certs 4a96
          monotone: expandeding partial id '4a96'
          monotone: expanded to '4a96a230293456baa9c6e7167cafb3c5b52a8e7f'
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : author
          Value : graydon@dub.venge.net
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : branch
          Value : monotone
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : date
          Value : 2003-10-17T03:20:27
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : changelog
          Value : 2003-10-16  graydon hoare  &lt;graydon@pobox.com&gt;
                :
                :         * sanity.hh: Add a const version of idx().
                :         * diff_patch.cc: Change to using idx() everywhere.
                :         * cert.cc (find_common_ancestor): Rewrite to recursive
                :         form, stepping over historic merges.
                :         * tests/t_cross.at: New test for merging merges.
                :         * testsuite.at: Call t_cross.at.
                :
     </pre>
     <br><dt><span class="command">monotone list keys</span><a name="index-monotone-list-keys-52"></a><dt><span class="command">monotone list keys </span><var>pattern</var><a name="index-monotone-list-keys-_0040var_007bpattern_007d-53"></a><dd>These commands list <span class="sc">rsa</span> keys held in your current database. They
do not print out any cryptographic information; they simply list the
names of public and private keys you have on hand.

     <p>If <var>pattern</var> is provided, it is used as a glob to limit the keys
listed. Otherwise all keys in your database are listed.

     <br><dt><span class="command">monotone list branches</span><a name="index-monotone-list-branches-54"></a><dd>
This command lists all known branches in your database.

     <br><dt><span class="command">monotone list tags</span><a name="index-monotone-list-tags-55"></a><dd>
This command lists all known tags in your database.

     <br><dt><span class="command">monotone list vars</span><a name="index-monotone-list-vars-56"></a><br><dt><span class="command">monotone list vars </span><var>domain</var><a name="index-monotone-list-vars-_0040var_007bdomain_007d-57"></a><dd>
This command lists all vars in your database, or all vars within a given
<var>domain</var>.  See <a href="#Vars">Vars</a> for more information.

     <br><dt><span class="command">monotone list known</span><a name="index-monotone-list-known-58"></a><dt><span class="command">monotone list known </span><var>pathname...</var><a name="index-monotone-list-known-_0040var_007bpathname_002e_002e_002e_007d-59"></a><dd>
This command lists all files which would become part of the manifest of
the next revision if you comitted your working copy at this point.

     <p>Specifying pathnames to the <span class="command">list known</span> command restricts
the set of paths that are searched for manifest files. Files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the working copy the <span class="command">list
known</span> command will, by default, search the entire working copy. 
Specifying only the pathname "." will restrict the search for known
files to the current subdirectory of the working copy.

     <br><dt><span class="command">monotone list unknown</span><a name="index-monotone-list-unknown-60"></a><dt><span class="command">monotone list unknown </span><var>pathname...</var><a name="index-monotone-list-unknown-_0040var_007bpathname_002e_002e_002e_007d-61"></a><dd>
This command lists all files in your working copy that monotone is
either ignoring or knows nothing about.

     <p>Specifying pathnames to the <span class="command">list unknown</span> command restricts the
set of paths that are searched for unknown files. Unknown files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the working copy the <span class="command">list
unknown</span> command will, by default, search the entire working copy. 
Specifying only the pathname "." will restrict the search for unknown
files to the current subdirectory of the working copy.

     <br><dt><span class="command">monotone list ignored</span><a name="index-monotone-list-ignored-62"></a><dt><span class="command">monotone list ignored </span><var>pathname...</var><a name="index-monotone-list-ignored-_0040var_007bpathname_002e_002e_002e_007d-63"></a><dd>
This command lists all files in your working copy that monotone is
intentionally ignoring, due to the results of the <code>ignore_file
(</code><var>filename</var><code>)</code> hook.

     <p>Specifying pathnames to the <span class="command">list ignored</span> command restricts the
set of paths that are searched for ignored files. Ignored files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the working copy the <span class="command">list
ignored</span> command will, by default, search the entire working copy. 
Specifying only the pathname "." will restrict the search for ignored
files to the current subdirectory of the working copy.

     <br><dt><span class="command">monotone list missing</span><a name="index-monotone-list-missing-64"></a><dt><span class="command">monotone list missing </span><var>pathname...</var><a name="index-monotone-list-missing-_0040var_007bpathname_002e_002e_002e_007d-65"></a><dd>
This command lists all files in your working copy's base manifest,
which are not present in the working copy.

     <p>Specifying pathnames to the <span class="command">list missing</span> command restricts the
set of paths that are searched for missing files. Missing files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the working copy the <span class="command">list
missing</span> command will, by default, search the entire working copy. 
Specifying only the pathname "." will restrict the search for missing
files to the current subdirectory of the working copy.

</dl>

<p><a name="Key-and-Cert"></a>

<h3 class="section">5.5 Key and Cert</h3>

     <dl>
<dt><span class="command">monotone genkey </span><var>keyid</var><a name="index-monotone-genkey-_0040var_007bkeyid_007d-66"></a><dd>
This command generates an <span class="sc">rsa</span> public/private key pair, using a
system random number generator, and stores it in your database under
the key name <var>keyid</var>. If the the hook
<code>non_blocking_rng_ok()</code> returns <code>true</code>, the key
generation will use an unlimited random number generator (such as
<span class="file">/dev/urandom</span>), otherwise it will use a higher quality random
number generator (such as <span class="file">/dev/random</span>) but might run slightly
slower.

     <p>The private half of the key is stored in an encrypted form, using the
symmetric cipher <span class="sc">arc4</span>, so that anyone accidentally reading your
database cannot extract your private key and use it. You must provide
a passphrase for your key when it is generated, which is used to key
the <span class="sc">arc4</span> cipher. In the future you will need to enter this
passphrase again each time you sign a certificate, which happens every
time you <span class="command">commit</span> to your database. You can tell monotone to
automatically use a certain passphrase for a given key using the
<code>get_passphrase(</code><var>keypair_id</var><code>)</code>, but this significantly
increases the risk of a key compromise on your local computer. Be
careful using this hook.

     <br><dt><span class="command">monotone dropkey </span><var>keyid</var><a name="index-monotone-dropkey-_0040var_007bkeyid_007d-67"></a><dd>
This command drops the public and/or private key. If both exist, both
are dropped, if only one exists, it is dropped. This command should
be used with caution as changes are irreversible without a backup of
the key(s) that were dropped. Note also that the private key is not
guaranteed to actually be erased from your database file &mdash; if you are
going to make the database file public, you should use <span class="command">db dump</span>
and <span class="command">db load</span> to import into a fresh database.

     <br><dt><span class="command">monotone chkeypass </span><var>id</var><a name="index-monotone-chkeypass-_0040var_007bid_007d-68"></a><dd>
This command lets you change the passphrase of the private half of the
key <var>id</var>.

     <br><dt><span class="command">monotone cert </span><var>id</var> <var>certname</var><a name="index-monotone-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-69"></a><dt><span class="command">monotone cert </span><var>id</var> <var>certname</var> <var>certval</var><a name="index-monotone-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-70"></a><dd>
These commands create a new certificate with name <var>certname</var>, for
a revision with version <var>id</var>. If <var>certval</var> is provided, it is
the value of the certificate.  Otherwise the certificate value is read
from <code>stdin</code>.

     <br><dt><span class="command">monotone trusted </span><var>id</var> <var>certname</var> <var>certval</var> <var>signers</var><a name="index-monotone-trusted-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-_0040var_007bsigners_007d-71"></a><dd>
This command lets you test your revision trust hook
<code>get_revision_cert_trust</code> (see <a href="#Hook-Reference">Hook Reference</a>).  You pass it
a revision ID, a certificate name, a certificate value, and one or more
key IDs, and it will tell you whether, under your current settings,
Monotone would trust a cert on that revision with that value signed by
those keys.

</dl>

<p><a name="Certificate"></a>

<h3 class="section">5.6 Certificate</h3>

     <dl>
<dt><span class="command">monotone approve </span><var>id</var><a name="index-monotone-approve-_0040var_007bid_007d-72"></a><dd>
This command is a synonym for <code>monotone cert </code><var>id</var><code> branch
</code><var>branchname</var> where <var>branchname</var> is the current branch name
(either deduced from the working copy or from the <span class="option">--branch</span>
option).

     <br><dt><span class="command">monotone comment </span><var>id</var><a name="index-monotone-comment-_0040var_007bid_007d-73"></a><dt><span class="command">monotone comment </span><var>id</var> <var>comment</var><a name="index-monotone-comment-_0040var_007bid_007d-_0040var_007bcomment_007d-74"></a><dd>
These commands are synonyms for <code>monotone cert </code><var>id</var><code>
comment </code><var>comment</var>. If <var>comment</var> is not provided, it is read
from <code>stdin</code>.

     <br><dt><span class="command">monotone tag </span><var>id</var> <var>tagname</var><a name="index-monotone-tag-_0040var_007bid_007d-_0040var_007btagname_007d-75"></a><dd>
This command is a synonym for <code>monotone cert </code><var>id</var><code> tag
</code><var>tagname</var>.

     <br><dt><span class="command">monotone testresult </span><var>id</var><span class="command"> 0</span><a name="index-monotone-testresult-_0040var_007bid_007d-0-76"></a><dt><span class="command">monotone testresult </span><var>id</var><span class="command"> 1</span><a name="index-monotone-testresult-_0040var_007bid_007d-1-77"></a><dd>
These commands are synonyms for <code>monotone cert </code><var>id</var><code>
testresult 0</code> or <code>monotone cert </code><var>id</var><code> testresult 1</code>.

</dl>

<p><a name="Packet-I_002fO"></a>

<h3 class="section">5.7 Packet I/O</h3>

<p>Monotone can produce and consume data in a convenient, portable form
called <dfn>packets</dfn>. A packet is a sequence of ASCII text, wrapped at
70-columns and easily sent through email or other transports. If you
wish to manually transmit a piece of information &ndash; for example a
public key &ndash; from one monotone database to another, it is often
convenient to read and write packets.

   <p><em>Note:</em> earlier versions of monotone queued and replayed packet
streams for their networking system. This older networking system is
deprecated and will be removed in a future version, as the netsync
protocol has several properties which make it advantageous as a
communication system. However, the packet i/o facility will remain in
monotone as a utility for moving individual data items around
manually.

     <dl>
<dt><span class="command">monotone certs </span><var>id</var><a name="index-monotone-certs-_0040var_007bid_007d-78"></a><dd>
This command prints out an <code>rcert</code> packet for each cert in your
database associated with <var>id</var>. These can be used to transport
certificates safely between monotone databases.

     <br><dt><span class="command">monotone fdata </span><var>id</var><a name="index-monotone-fdata-_0040var_007bid_007d-79"></a><dt><span class="command">monotone mdata </span><var>id</var><a name="index-monotone-mdata-_0040var_007bid_007d-80"></a><dt><span class="command">monotone rdata </span><var>id</var><a name="index-monotone-rdata-_0040var_007bid_007d-81"></a><dd>
These commands print out an <code>fdata</code>, <code>mdata</code> or <code>rdata</code>
packet for the file, manifest or revision <var>id</var> in your database. 
These can be used to transport files, manifests or revisions, in their
entirety, safely between monotone databases.

     <br><dt><span class="command">monotone fdelta </span><var>id1</var> <var>id2</var><a name="index-monotone-fdelta-_0040var_007bid1_007d-_0040var_007bid2_007d-82"></a><dt><span class="command">monotone mdelta </span><var>id1</var> <var>id2</var><a name="index-monotone-mdelta-_0040var_007bid1_007d-_0040var_007bid2_007d-83"></a><dd>
These commands print out an <code>fdelta</code> or <code>mdelta</code> packet for
the differences between file or manifest versions <var>id1</var> and
<var>id2</var>, in your database.  These can be used to transport file or
manifest differences safely between monotone databases.

     <br><dt><span class="command">monotone privkey </span><var>keyid</var><a name="index-monotone-privkey-_0040var_007bkeyid_007d-84"></a><dt><span class="command">monotone pubkey </span><var>keyid</var><a name="index-monotone-pubkey-_0040var_007bkeyid_007d-85"></a><dd>
These commands print out an <code>privkey</code> or <code>pubkey</code> packet for
the <span class="sc">rsa</span> key <var>keyid</var>. These can be used to transport public or
private keys safely between monotone databases.

     <br><dt><span class="command">monotone read</span><a name="index-monotone-read-86"></a><br><dt><span class="command">monotone read </span><var>file1</var> <var>file2...</var><a name="index-monotone-read-_0040var_007bfile1_007d-_0040var_007bfile2_002e_002e_002e_007d-87"></a><dd>
This command reads packets from files or <code>stdin</code> and stores them
in your database.

   </dl>

<p><a name="Database"></a>

<h3 class="section">5.8 Database</h3>

     <dl>
<dt><span class="command">monotone set </span><var>domain</var> <var>name</var> <var>value</var><a name="index-monotone-set-_0040var_007bdomain_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-88"></a><dd>
Associates the value <var>value</var> to <var>name</var> in domain <var>domain</var>. 
See <a href="#Vars">Vars</a> for more information.

     <br><dt><span class="command">monotone unset </span><var>domain</var> <var>name</var><a name="index-monotone-unset-_0040var_007bdomain_007d-_0040var_007bname_007d-89"></a><dd>
Deletes any value associated with <var>name</var> in <var>domain</var>.  See
<a href="#Vars">Vars</a> for more information.

     <br><dt><span class="command">monotone db init --db=</span><var>dbfile</var><a name="index-monotone-db-init-_002d_002ddb_003d_0040var_007bdbfile_007d-90"></a><dd>
This command initializes a new monotone database at <span class="file">dbfile</span>.

     <br><dt><span class="command">monotone db rebuild --db=</span><var>dbfile</var><a name="index-monotone-db-rebuild-_002d_002ddb_003d_0040var_007bdbfile_007d-91"></a><dd>
This command rebuilds the ancestry graph of the monotone database at
<span class="file">dbfile</span>, which may become necessary if future bugs in monotone
allow invalid changesets to be saved in your database.  This command is
destructive, and you should make a backup copy of your database before
running it.  It will preserve the contents of each revision, but it will
lose rename history.  Use it carefully, and only after understanding
<a href="#Rebuilding-ancestry">Rebuilding ancestry</a>.  Note that it will make your history
incompatible with that of anyone else working on the same project!  Read
<a href="#Rebuilding-ancestry">Rebuilding ancestry</a>.

     <br><dt><span class="command">monotone db info --db=</span><var>dbfile</var><a name="index-monotone-db-info-_002d_002ddb_003d_0040var_007bdbfile_007d-92"></a><dd>
This command prints information about the monotone database <span class="file">dbfile</span>,
including its schema version and various table size statistics.

     <br><dt><span class="command">monotone db version --db=</span><var>dbfile</var><a name="index-monotone-db-version-_002d_002ddb_003d_0040var_007bdbfile_007d-93"></a><dd>
This command prints out just the schema version of the monotone
database <span class="file">dbfile</span>.

     <br><dt><span class="command">monotone db dump --db=</span><var>dbfile</var><a name="index-monotone-db-dump-_002d_002ddb_003d_0040var_007bdbfile_007d-94"></a><dd>
This command dumps an SQL statement representing the entire state of
<span class="file">dbfile</span> to the standard output stream. It is a very low-level
command, and produces the most &ldquo;recoverable&rdquo; dumps of your database
possible. It is sometimes also useful when migrating databases between
variants of the underlying sqlite database format.

     <br><dt><span class="command">monotone db load --db=</span><var>dbfile</var><a name="index-monotone-db-load-_002d_002ddb_003d_0040var_007bdbfile_007d-95"></a><dd>
This command applies a raw SQL statement, read from the standard input
stream, to the database <span class="file">dbfile</span>. It is most useful when loading
a database dumped with the <span class="command">dump</span> command.

     <p>Note that when reloading a dumped database, the schema of the dumped
database is <em>included</em> in the dump, so you should not try to
<span class="command">init</span> your database before a <span class="command">load</span>.

     <br><dt><span class="command">monotone db migrate --db=</span><var>dbfile</var><a name="index-monotone-db-migrate-_002d_002ddb_003d_0040var_007bdbfile_007d-96"></a><dd>
This command attempts to migrate the database <span class="file">dbfile</span> to the
newest schema known by the version of monotone you are currently
running.  If the migration fails, no changes should be made to the
database.

     <p>If you have important information in your database, you should back up
a copy of it before migrating, in case there is an untrapped error
during migration.

     <br><dt><span class="command">monotone db check --db=</span><var>dbfile</var><a name="index-monotone-db-check-_002d_002ddb_003d_0040var_007bdbfile_007d-97"></a><dd>
Monotone always works hard to verify the data it creates and accesses. 
For instance, if you have hard drive problems that corrupt data in
monotone's database, and you attempt to retrieve this data, then
monotone will notice the problem and stop, instead of silently giving
you garbage data.

     <p>However, it's also nice to notice such problems early, and in rarely
used parts of history, while you still have backups.  That's what this
command is for.  It systematically checks the database <span class="file">dbfile</span> to
ensure that it is complete and consistent. The following problems are
detected:

          <ul>
<li>missing files
that are referenced by their <span class="sc">sha1</span> hash from some manifest but do not
exist in the database.  This is a serious problem; it means that your
history is not fully reconstructible.  You can fix it by finding the
file with the given hash, and loading it into your database with
<span class="command">fload</span>.

          <li>unreferenced files
that exist in the database but are not referenced by their <span class="sc">sha1</span>
hash from any existing manifest.  In itself, this only indicates some
wasted space, and is not a problem; it's possible it could arise under
normal use (for instance, in some strange corner cases following an
incomplete netsync).  It could also arise, though, as a symptom of some
other more serious problem.

          <li>missing manifests
that are referenced by their <span class="sc">sha1</span> hash from some revision but do
not exist in the database.  This is a serious problem; it means that
your history is not fully reconstructible.  You can fix it by finding a
database containing the manifest, and using <span class="command">mdata</span> on that
database to create a manifest data packet, which can be loaded into your
database with <span class="command">read</span>.

          <li>unreferenced manifests
that exist in the database but are not referenced by their <span class="sc">sha1</span>
hash from any existing revision.  In itself, this only indicates some
wasted space, and is not a problem; it's possible it could arise under
normal use (for instance, if you have run <span class="command">db kill_rev_locally</span>,
or in some strange-but-harmless corner cases following an incomplete
netsync).  It could also arise, though, as a symptom of some other more
serious problem.

          <li>incomplete manifests
that exist in the database but contain references to files that do not
exist in the database.  For diagnosis and solution, see &ldquo;missing
files&rdquo; above.

          <li>missing revisions
that are referenced by their <span class="sc">sha1</span> hash from some other revision or
revision cert but do not exist in the database.  This may be a serious
problem; it may indicate that your history is not fully reconstructible
(if the reference is from another revision) or that someone is creating
bogus certs (if the reference is from a cert).  You can fix it by
finding a database containing the revision, and using <span class="command">rdata</span> on
that database to create a revision data packet, which can be loaded into
your database with <span class="command">read</span>.

          <li>incomplete revisions
that exist in the database but contain references to missing manifests,
incomplete manifests or missing revisions.  This always occurs with some
more detailed error; see above.

          <li>revisions with mismatched parents
that disagree with the cached revision ancestry on their parent
revisions.  This may cause problems in using the database, and suggests
the presence of a bug in monotone's caching system, but does not involve
data loss.

          <li>revisions with mismatched children
that disagree with the cached revision ancestry on their child
revisions.  This may cause problems in using the database, and suggests
the presence of a bug in monotone's caching system, but does not involve
data loss.

          <li>revisions with bad history
that exist in the database but fail monotone's normal sanity checks for
consistent and correct history.  This is a serious problem; it indicates
that your history record is somehow malformed.  This should not be
possible, since monotone carefully checks every revision before storing
it into the database, but if it does, then please request assistance on
the monotone mailing list.  Fixing this generally means you may lose
some history &mdash; for instance, renames may be degraded into delete/add
pairs &mdash; but the actual contents of every revision will still be
reproducible.

          <li>revisions with missing certs
that exist in the database lacking at least one author, branch,
changelog or date cert. All revisions are expected to have at least one
of each of these certs.  In itself, this is not necessarily a problem,
but it is peculiar, and some operations such as netsync may behave
strangely.

          <li>revisions with mismatched certs
that exist in the database with differing numbers of author, changelog
and date certs. These certs are expected to appear together, as each
revision committed should have an author, changelog and date associated
with it.  In itself, this is not a problem, but it is peculiar.  All
operations should behave normally.

          <li>missing keys
that have been used to sign certs but do not exist in the database.  In
itself, this is not a problem, except that monotone will ignore any
certs signed by the missing key.  You can fix it by finding a database
containing the key in question, and using <span class="command">pubkey</span> on that
database to create a public key packet, which can be loaded into your
database with <span class="command">read</span>.

          <li>certs with bad signatures
that exist in the database with signatures that are invalid.  In itself,
this is not a problem, except that monotone will ignore any such certs. 
You may also wish to find out who is creating certs with bad
signatures; it may indicate some kind of security attack.

          <li>certs with unchecked signatures
that exist in the database but cannot have their signatures checked
because the signing key is missing.  In itself, this is not a problem,
except that monotone will ignore any certs signed by the missing key. 
You can fix it by finding a database containing the key in question, and
using <span class="command">pubkey</span> on that database to create a public key packet,
which can be loaded into your database with <span class="command">read</span>.

     </ul>

     <p>This command also verifies that the <span class="sc">sha1</span> hash of every file, manifest,
and revision is correct.

     <br><dt><span class="command">monotone db kill_rev_locally </span><var>id</var><a name="index-monotone-db-kill_005frev_005flocally-_0040var_007bid_007d-98"></a><dd>
This command &ldquo;kills&rdquo;, i.e., deletes, a given revision, as well as any
certs attached to it.  It has an ugly name because it is a dangerous
command; it permanently and irrevocably deletes historical information
from your database.  There are a number of caveats:
          <ul>
<li>It can only be applied to revisions that have no descendents.  If you
want to kill a revision that has descendents, you must kill all of the
descendents first. 
<li>It only removes the revision from your local database (hence the
&ldquo;locally&rdquo; in the command name).  If you have already pushed this
revision out to another database, then the next time you pull from that
database it may come back again.  There is no way to delete a revision
from somebody else's database except to ask them to delete it for you. 
<li>It does not actually delete the revision's files or manifest from your
database.  If you run this command, and then run <span class="command">db check</span>, it
will note that you have an &ldquo;unreferenced manifest&rdquo;.  If you wish to
eliminate this data for good (and thus free up the space), you may use
netsync to <span class="command">pull</span> from your current database into a new
database; this creates a copy of your old database, without the
unreferenced data.  However, having this data in your database will not
cause any problems, and acts as a safety net; if you later realize that
you do, after all, need to retrieve the data in <var>id</var>, then
<span class="command">db check</span> will let you see which manifest it was, and with some
work you can extract <var>id</var>'s data. 
</ul>

     <br><dt><span class="command">monotone db kill_branch_certs_locally </span><var>branch</var><a name="index-monotone-db-kill_005fbranch_005fcerts_005flocally-_0040var_007bbranch_007d-99"></a><dd>
This command &ldquo;kills&rdquo; a branch by deleting all branch certs with that
branch name. You should consider carefully whether you want to use it,
because it can irrevocably delete important information. It does not
modify or delete any revisions or any of the other certificates on
revisions in the branch; it simply removes the branch certificates
matching the given branch name. Because of this, it can leave
revisions without any branch certificate at all. As with <span class="command">db
kill_rev_locally</span>, it only deletes the information from your local
database; if there are other databases that you sync with which have
revisions in this branch, the branch certificates will reappear when
you sync, unless the owners of those databases also delete those
certificates locally.

     <br><dt><span class="command">monotone db kill_tag_locally </span><var>tag</var><a name="index-monotone-db-kill_005ftag_005flocally-_0040var_007btag_007d-100"></a><dd>
This command &ldquo;kills&rdquo; a tag by deleting all tag certs with that tag
name. You should consider carefully whether you want to use it, because
it can irrevocably delete important information. It does not modify or
delete any revisions, or any of the other certificates on tagged
revisions; it simply removes all tag certificates with the given name. 
As with <span class="command">db kill_rev_locally</span>, it only deletes the information
from your local database; if there are other databases that you sync
with which have this tag, the tag certificates will reappear when you
sync, unless the owners of those databases also delete those
certificates locally.

     <br><dt><span class="command">monotone db execute </span><var>sql-statement</var><a name="index-monotone-db-execute-_0040var_007bsql_002dstatement_007d-101"></a><dd>
This is a debugging command which executes <var>sql-statement</var> against
your database, and prints any results of the expression in a tabular
form.  It can be used to investigate the state of your database, or
help diagnose failures.

</dl>

<p><a name="Automation"></a>

<h3 class="section">5.9 Automation</h3>

<p>This section contains subcommands of the <code>monotone automate</code>
command, used for scripting monotone.  All give output on stdout; they
may also give useful chatter on stderr, including warnings and error
messages.

     <dl>
<dt><span class="command">monotone automate interface_version</span><a name="index-monotone-automate-interface_005fversion-102"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
0.0

          <br><dt><strong>Purpose:</strong><dd>
Prints version of the automation interface.  Major number increments
whenever a backwards incompatible change is made to the <code>automate</code>
command; minor number increments whenever any change is made (but is
reset when major number increments).

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          1.2
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A decimal number, followed by &ldquo;.&rdquo; (full stop/period), followed by a
decimal number, followed by a newline, followed by end-of-file.  The
first decimal number is the major version, the second is the minor version.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><span class="command">monotone automate heads [</span><var>branch</var><span class="command">]</span><a name="index-monotone-automate-heads-_005b_0040var_007bbranch_007d_005d-103"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One branch name,  <var>branch</var>. If none is given, the current default branch is used.

          <br><dt><strong>Added in:</strong><dd>
0.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the heads of branch <var>branch</var>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one head of the given branch. 
Each line consists of a revision ID, in hexadecimal, followed by a
newline.  The lines are printed in alphabetically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
If the given branch contains no members or does not exist, then no lines are printed.

     </dl>

     <br><dt><span class="command">monotone automate ancestors </span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]</span><a name="index-monotone-automate-ancestors-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-104"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints the ancestors of one or more revisions.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one ancestor of the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <p>The output does not include <var>rev1</var>, <var>rev2</var>, etc., except if
<var>rev2</var> is itself an ancestor of <var>rev1</var>, then <var>rev2</var> will be
included in the output.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate parents </span><var>rev</var><a name="index-monotone-automate-parents-_0040var_007brev_007d-105"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One revision ID, <var>rev</var>.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints the immediate parents of a revision.  This is like a
non-recursive version of <span class="command">automate ancestors</span>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one parent of the given
revision.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <br><dt><strong>Error conditions:</strong><dd>
If the given revision <var>rev</var> does not exist, prints nothing to
stdout, prints an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate descendents </span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]</span><a name="index-monotone-automate-descendents-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-106"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints the descendents of one or more revisions.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one descendent of the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <p>The output does not include <var>rev1</var>, <var>rev2</var>, etc., except that if
<var>rev2</var> is itself a descendent of <var>rev1</var>, then <var>rev2</var> will be
included in the output.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate children </span><var>rev</var><a name="index-monotone-automate-children-_0040var_007brev_007d-107"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One revision ID, <var>rev</var>.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints the immediate children of a revision.  This is like a
non-recursive version of <span class="command">automate descendents</span>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one child of the given
revision.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <br><dt><strong>Error conditions:</strong><dd>
If the given revision <var>rev</var> does not exist, prints nothing to
stdout, prints an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate graph</span><a name="index-monotone-automate-graph-108"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints out the complete ancestry graph of this database.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          0c05e8ec9c6af4224672c7cc4c9ef05ae8bdb794
          27ebcae50e1814e35274cb89b5031a423c29f95a 5830984dec5c41d994bcadfeab4bf1bf67747b89
          4e284617c80bec7da03925062a84f715c1b042bd 27ebcae50e1814e35274cb89b5031a423c29f95a 657c756d24fb65213d59f4ae07e117d830dcc95b
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving ancestry information for one revision. 
Each line begins with a revision ID.  Following this are zero or more
space-prefixed revision IDs.  Each revision ID after the first is a
parent (in the sense of <span class="command">automate parents</span>) of the first.  For
instance, in the above sample output,
0c05e8ec9c6af4224672c7cc4c9ef05ae8bdb794 is a root node,
27ebcae50e1814e35274cb89b5031a423c29f95a has one parent, and
4e284617c80bec7da03925062a84f715c1b042bd has two parents, i.e., is a
merge node.

          <p>The output as a whole is alphabetically sorted by line; additionally,
the parents within each line are alphabetically sorted.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><span class="command">monotone automate erase_ancestors [</span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]]</span><a name="index-monotone-automate-erase_005fancestors-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-109"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all arguments, except those that are an ancestor of some other
argument.  One way to think about this is that it prints the minimal
elements of the given set, under the ordering imposed by the &ldquo;child
of&rdquo; relation.  Another way to think of it is if the arguments formed a
branch, then we would print the heads of that branch.  If there
are no arguments, prints nothing.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one descendent of the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate toposort [</span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]]</span><a name="index-monotone-automate-toposort-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-110"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all arguments, topologically sorted.  I.e., if <var>rev1</var> is an
ancestor of <var>rev2</var>, then <var>rev1</var> will appear before <var>rev2</var> in
the output; if <var>rev2</var> is an ancestor of <var>rev1</var>, then <var>rev2</var>
will appear before <var>rev1</var> in the output; and if neither is an
ancestor of the other, then they may appear in either order.  If there
are no arguments, prints nothing.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A list of revision IDs, in hexadecimal, each followed by a newline. 
Revisions are printed in topologically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate ancestry_difference </span><var>new</var><span class="command"> [</span><var>old1</var><span class="command"> [</span><var>old2</var><span class="command"> [...]]]</span><a name="index-monotone-automate-ancestry_005fdifference-_0040var_007bnew_007d-_005b_0040var_007bold1_007d-_005b_0040var_007bold2_007d-_005b_002e_002e_002e_005d_005d_005d-111"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A &ldquo;new&rdquo; revision ID <var>new</var>, followed by zero or more &ldquo;old&rdquo;
revision IDs <var>old1</var>, <var>old2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all ancestors of the revision <var>new</var>, that are not also
ancestors of one of the old revisions.  For purposes of this command,
&ldquo;ancestor&rdquo; is an inclusive term; for example, if <var>new</var> is an
ancestor of <var>old1</var>, it will not be printed; but if <var>new</var> is not
an ancestor of any of the &ldquo;old&rdquo; revisions, then it will be. 
Similarly, <var>old1</var> will never be printed, because it is considered to
be an ancestor of itself.  The reason for the names is that if <var>new</var>
a new revision, and <var>old1</var>, <var>old2</var>, etc. are revisions that you
have processed before, then this command tells you which revisions are
new since then.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A list of revision IDs, in hexadecimal, each followed by a newline. 
Revisions are printed in topologically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate leaves</span><a name="index-monotone-automate-leaves-112"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints the leaves of the revision graph, i.e. all revision that have no
children.  This is similar, but not identical to the functionality of
<span class="command">heads</span>, which prints every revision in a branch, that has no
descendents in that branch.  If every revision in the database was in
the same branch, then they would be identical.  Generally, every leaf is
the head of some branch, but not every branch head is a leaf.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each a leaf of the revision graph.  Each line
consists of a revision ID, in hexadecimal, followed by a newline.  The
lines are printed in alphabetically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><span class="command">monotone automate select </span><var>selector</var><a name="index-monotone-automate-select-_0040var_007bselector_007d-113"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One selector (or combined selector).

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Print all revisions that match the given selector.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one revision that matches the
given selector.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><span class="command">monotone automate inventory</span><a name="index-monotone-automate-inventory-114"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the inventory of every file found in the working copy or its
associated base manifest. Each unique path is listed on a line prefixed by
three status characters and two numeric values used for identifying
renames.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
            M 0 0 missing
           AP 0 0 added patched
          D   0 0 dropped
          R   1 0 renamed-from-this
           R  0 1 renamed-to-this
            P 0 0 patched
              0 0 unchanged
            U 0 0 unknown
            I 0 0 ignored
          
          # swapped but not moved
          
          RRP 1 2 unchanged
          RRP 2 1 original
          
          # swapped and moved
          
          RR  1 2 unchanged
          RR  2 1 original
          
          # rename foo bar; add foo
          
          RAP 1 0 foo
           R  0 1 bar
          
          # rotated but not moved dropped -> missing -> original -> dropped
          
          RRP 1 3 dropped
          RRP 2 1 missing
          RRP 3 2 original
          
          # rotated and moved
          
          RR  1 3 dropped
          RR  2 1 missing
          RR  3 2 original
          
          # dropped but not removed and thus unknown
          
          D U 0 0 dropped
          
          # added but removed and thus missing
          
           AM 0 0 added
          
          # renamed but not moved and thus unknown source and missing target
          
          R U 1 0 original
           RM 0 1 renamed
          
          # moved but not renamed and thus missing source and unknown target
          
            M 0 0 original
            U 0 0 renamed
          
          # renamed and patched
          
          R   1 0 original
           RP 0 1 renamed
          
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Each path is printed on its own line, prefixed by three status
characters described below. The status is followed by a single space and
two numbers, each separated by a single space, used for identifying renames. 
The numbers are followed by a single space and then the pathname, which
includes the rest of the line. Directory paths are identified as ending with
the "/" character, file paths do not end in this character.

          <p>The three status characters are as follows.

          <pre class="verbatim">          
          column 1 pre-state
                ' ' the path was unchanged in the pre-state
                'D' the path was deleted from the pre-state
                'R' the path was renamed from the pre-state name
          column 2 post-state
                ' ' the path was unchanged in the post-state
                'R' the path was renamed to the post-state name
                'A' the path was added to the post-state
          column 3 file-state
                ' ' the file is known and unchanged from the current manifest version
                'P' the file is patched to a new version
                'U' the file is unknown and not included in the current manifest
                'I' the file is ignored and not included in the current manifest
                'M' the file is missing but is included in the current manifest
     </pre>

          <p>Note that there are 45 possible status code combinations, some of which
are not valid, detailed below.

          <pre class="verbatim">          
          '   ' unchanged
          '  P' patched (contents changed)
          '  U' unknown (exists on the filesystem but not tracked)
          '  I' ignored (exists on the filesystem but excluded by lua hook)
          '  M' missing (exists in the manifest but not on the filesystem)
          
          ' A ' added (invalid, add should have associated patch)
          ' AP' added and patched
          ' AU' added but unknown (invalid)
          ' AI' added but ignored (seems invalid, but may be possible?)
          ' AM' added but missing from the filesystem
          
          ' R ' rename target
          ' RP' rename target and patched
          ' RU' rename target but unknown (invalid)
          ' RI' rename target but ignored (seems invalid, but may be possible?)
          ' RM' rename target but missing from the filesystem
          
          'D  ' dropped
          'D P' dropped and patched (invalid)
          'D U' dropped and unknown (still exists on the filesystem)
          'D I' dropped and ignored (seems invalid, but may be possible?)
          'D M' dropped and missing (invalid)
          
          'DA ' dropped and added (invalid, add should have associated patch)
          'DAP' dropped and added and patched
          'DAU' dropped and added but unknown (invalid)
          'DAI' dropped and added but ignored (seems invalid, but may be possible?)
          'DAM' dropped and added but missing from the filesystem
          
          'DR ' dropped and rename target
          'DRP' dropped and rename target and patched
          'DRU' dropped and rename target but unknown (invalid)
          'DRI' dropped and rename target but ignored (invalid)
          'DRM' dropped and rename target but missing from the filesystem
          
          'R  ' rename source
          'R P' rename source and patched (invalid)
          'R U' rename source and unknown (still exists on the filesystem)
          'R I' rename source and ignored (seems invalid, but may be possible?)
          'R M' rename source and missing (invalid)
          
          'RA ' rename source and added (invalid, add should have associated patch)
          'RAP' rename source and added and patched
          'RAU' rename source and added but unknown (invalid)
          'RAI' rename source and added but ignored (seems invalid, but may be possible?)
          'RAM' rename source and added but missing from the filesystem
          
          'RR ' rename source and target
          'RRP' rename source and target and target patched
          'RRU' rename source and target and target unknown (invalid)
          'RRI' rename source and target and target ignored (seems invalid, but may be possible?)
          'RRM' rename source and target and target missing
     </pre>

          <p>Full support for versioned directories is not yet complete and the
inventory will only list entries for renamed or dropped
directories.

          <br><dt><strong>Error conditions:</strong><dd>
When executed from outside of a working copy directory, prints an error
message to stderr, and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate certs </span><var>id</var><a name="index-monotone-automate-certs-_0040var_007bid_007d-115"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A revision ID <var>id</var>, for which any certificates will be printed.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints all certificates associated with the given revision ID. 
Each certificate is contained in a basic IO stanza. For each certificate,
the following values are provided:

          <pre class="verbatim">          
          'key'
                a string indicating the key used to sign this certificate.
          'signature'
                a string indicating the status of the signature. Possible 
                values of this string are:
                      'ok'        : the signature is correct
                      'bad'       : the signature is invalid
                      'unknown'   : signature was made with an unknown key
          'name'
                the name of this certificate
          'value'
                the value of this certificate
          'trust'
                is this certificate trusted by the defined trust metric?
                Possible values of this string are:
                      'trusted'   : this certificate is trusted
                      'untrusted' : this certificate is not trusted
     </pre>

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "author"
              value "emile@alumni.reed.edu"
              trust "trusted"
          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "branch"
              value "net.venge.monotone"
              trust "trusted"
          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "changelog"
              value "propagate from branch 'net.venge.monotone.annotate' (head 76a886ef7c8ae12a4bba5fc2bd252557bf863aff)
                      to branch 'net.venge.monotone' (head 2490479a4e4e99243fead6d627d78291fde592f0)
          "
              trust "trusted"
          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "date"
              value "2005-05-20T20:19:25"
              trust "trusted"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
All stanzas are formatted by basic_io. Stanzas are seperated
by a blank line. Values will be escaped, '\' to '\\' and
'"' to '\"'.

          <br><dt><strong>Error conditions:</strong><dd>
If a certificate is signed with an unknown public key, a
warning message is printed to stderr. If the revision specified is unknown
or invalid prints an error message to stderr and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate stdio</span><a name="index-monotone-automate-stdio-116"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
none

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Allow multiple automate commands to be run from one instance of monotone.

          <br><dt><strong>Sample input:</strong><dd>
<pre class="verbatim">          
          l6:leavese
          l7:parents40:0e3171212f34839c2e3263e7282cdeea22fc5378e
     </pre>

          <br><dt><strong>Input format:</strong><dd>
The input is a series of commands of the form 'l' &lt;token&gt; [&lt;token&gt; ...] 'e',
where &lt;token&gt; = &lt;size&gt; colon &lt;string&gt; . Characters between the ending 'e'
of one commad and the beginning 'l' of the next are ignored, but characters
other than '\n' should not be present as this space is reserved.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          0:0:l:205:0e3171212f34839c2e3263e7282cdeea22fc5378
          1f4ef73c3e056883c6a5ff66728dd764557db5e6
          2133c52680aa2492b18ed902bdef7e083464c0b8
          23501f8afd1f9ee037019765309b0f8428567f8a
          2c295fcf5fe20301557b9b3a5b4d437b5ab8ec8c
          1:0:l:41:7706a422ccad41621c958affa999b1a1dd644e79
     </pre>

          <br><dt><strong>Output format:</strong><dd>
&lt;command number&gt;:&lt;err code&gt;:&lt;last?&gt;:&lt;size&gt;:&lt;output&gt;

          <p>&lt;command number&gt; is a decimal number specifying which command this output
is from. It is 0 for the first command, and increases by one each time.

          <p>&lt;err code&gt; is 0 for success, 1 for a syntax error, and 2 for any other error.

          <p>&lt;last?&gt; is 'l' if this is the last piece of output for this command, and 'm'
if there is more output to come.

          <p>&lt;size&gt; is the number of bytes in the output.

          <p>&lt;output&gt; is the output of the command. This will never exceed 1024 bytes. 
If a command produces more than 1024 bytes of output, it will be split into
multiple peices, with all but the last having the &lt;last?&gt; field set to 'm'.

          <br><dt><strong>Error conditions:</strong><dd>
If a badly formatted command is recieved, prints an error message to
standard error and exits with nonzero status. Errors in the commands run
through this interface do not affect the exit status. Instead, the &lt;err code&gt;
field in the output is set to 2, and the output of the command becomes
whatever error message would have been given. The output of an invalid
command line will have an error code of 1, and the output text will be a help
message.

     </dl>

     <br><dt><span class="command">monotone automate get_revision</span><a name="index-monotone-automate-get_005frevision-117"></a><br><dt><span class="command">monotone automate get_revision </span><var>id</var><a name="index-monotone-automate-get_005frevision-_0040var_007bid_007d-118"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
Specifying the option <var>id</var> argument outputs the changeset
information for the specified <var>id</var>. Otherwise, <var>id</var> is
determined from the working directory.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints changeset information for the specified revision id.

          <p>There are several changes that are described; each of these is described by
a different basic_io stanza. The first string pair of each stanza indicates the
type of change represented.

          <p>Possible values of this first value are along with an ordered list of
basic_io formatted string pairs that will be provided are:

          <pre class="verbatim">          
          'old_revision'
                represents a parent revision.
                format: ('old_revision', revision id)
          'new_manifest'
                represents the new manifest associated with the revision.
                format: ('new_manifest', manifest id)
          'old_manifest'
                represents a manifest associated with a parent revision.
                format: ('old_manifest', manifest id)
          'patch'
                represents a file that was modified.
                format: ('patch', filename), ('from', file id), ('to', file id)
          'add_file'
                represents a file that was added.
                format: ('add_file', filename)
          'delete_file'
                represents a file that was deleted.
                format: ('delete_file', filename)
          'delete_dir'
                represents a directory that was deleted.
                format: ('delete_dir', filename)
          'rename_file'
                represents a file that was renamed.
                format: ('rename_file', old filename), ('to', new filename)
          'rename_dir'
                represents a directory that was renamed.
                format: ('rename_dir', old filename), ('to', new filename)
     </pre>

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          new_manifest [bfe2df785c07bebeb369e537116ab9bb7a4b5e19]
          
          old_revision [429fea55e9e819a046843f618d90674486695745]
          old_manifest [b71855116f7049ac663102c0cb628653ffe316d1]
          
          patch "ChangeLog"
           from [7dc21d3a46c6ecd94685ab21e67b131b32002f12]
             to [234513e3838d423b24d5d6c98f70ce995c8bab6e]
          
          patch "std_hooks.lua"
           from [0408707bb6b97eae7f8da61af7b35364dbd5a189]
             to [d7bd0756c48ace573926197709e53eb24dae5f5f]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
All stanzas are formatted by basic_io. Stanzas are seperated
by a blank line. Values will be escaped, '\' to '\\' and
'"' to '\"'.

          <br><dt><strong>Error conditions:</strong><dd>
If the revision specified is unknown or invalid prints an error message
to stderr and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate get_manifest</span><a name="index-monotone-automate-get_005fmanifest-119"></a><br><dt><span class="command">monotone automate get_manifest </span><var>id</var><a name="index-monotone-automate-get_005fmanifest-_0040var_007bid_007d-120"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
Specifying the optional <var>id</var> argument outputs the maifest for the
specified <var>id</var>. Otherwise, <var>id</var> is determined from the working
directory.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the contents of the manifest associated with the given manifest ID.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          e3915658cb464d05f21332e03d30dca5d94fe776  .htaccess
          00ff89c69e7a8f6a0f48c6503168d9b62a0cfeb0  .mt-attrs
          80d8f3f75c9b517ec462233e155f7dfb93379f67  AUTHORS
          fc74a48c7f73eedcbe1ea709755fbe819b29736c  ChangeLog
          dfac199a7539a404407098a2541b9482279f690d  LICENSE
          440eec971e7bb61ccbb61634deb2729bb25931cd  README
          e0ea26c666b37c5f98ccf80cb933d021ee55c593  TODO
          b28ece354969314ce996f3030569215d685973d6  branch.psp
          1fdb62e05fb2a9338d2c72ddc58de3ab2b3976fe  common.py
          64cb5898e3a026b4782c343ca4386585e0c3c275  config.py.example
          7152c3ff110418aca5d23c374ea9fb92a0e98379  error.psp
          5d8536100fdf51d505b6f20bc9c16aa78d4e86a8  fileinbranch.psp
          981df124a0b5655a9f78c42504cfa8c6f02b267a  headofbranch.psp
          a43d0588a69e622b2afc681678c2a5c3b3b1f342  help.psp
          18a8bffc8729d7bfd71d2e0cb35a1aed1854fa74  html.py
          c621827db187839e1a7c6e51d5f1a7f6e0aa560c  index.psp
          708b61436dce59f47bd07397ce96a1cfabe81970  monotone.py
          a02b1c161006840ea8685e461fd07f0e9bb145a3  revision.psp
          027515fd4558abf317d54c437b83ec6bc76e3dd8  rss_feed.gif
          638140d6823eee5844de37d985773be75707fa25  tags.psp
          be83f459a152ffd49d89d69555f870291bc85311  tarofbranch.psp
          fb51955563d64e628e0e67e4acca1a1abc4cd989  utility.py
          8d04b3fc352a860b0e3240dcb539c1193705398f  viewmtn.css
          7cb5c6b1b1710bf2c0fa41e9631ae43b03424a35  viewmtn.py
          530290467a99ca65f87b74f653bf462b28c6cda9  wrapper.py
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The output format is one line for each file in the manifest. Each line begins
with a 40 character file ID, followed by two space characters ('  ') and then
the filename.

          <br><dt><strong>Error conditions:</strong><dd>
If the manifest ID specified is unknown or invalid prints an error
message to stderr and exits with status 1.

     </dl>

     <br><dt><span class="command">monotone automate get_file </span><var>id</var><a name="index-monotone-automate-get_005ffile-_0040var_007bid_007d-121"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The  <var>id</var> argument specifies the file to be output.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the contents of the specified file.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          If you've downloaded a release, see INSTALL for installation
          instructions.  If you've checked this out, the generated files are not
          included, and you must use "autoreconf --install" to create them.
          
          "make html" for docs, or read the .info file and / or man page.
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The file contents are output without modification.

          <br><dt><strong>Error conditions:</strong><dd>
If the file id specified is unknown or invalid prints an error message
to stderr and exits with status 1.

     </dl>

   </dl>

<p><a name="RCS"></a>

<h3 class="section">5.10 RCS</h3>

     <dl>
<dt><span class="command">monotone rcs_import </span><var>filename...</var><a name="index-monotone-rcs_005fimport-_0040var_007bfilename_002e_002e_002e_007d-122"></a><dd>
This command imports all the file versions in each RCS file listed in
<var>filename...</var>.  These files should be raw RCS files, ending in
<code>,v</code>. Monotone parses them directly and inserts them into your
database.  Note that this does not do any revision reconstruction, and
is only useful for debugging.

     <br><dt><span class="command">monotone cvs_import </span><var>pathname</var><a name="index-monotone-cvs_005fimport-_0040var_007bpathname_007d-123"></a><dd>
This command imports all the file versions in each RCS file found in the
tree of files starting at <var>pathname</var>, then reconstructs the
tree-wide history of logical changes by comparing RCS time stamps and
change log entries. For each logical tree-wide change, monotone
synthesizes a manifest and revision, and commits them (along with all
associated file deltas) to your database. It also copies all change log
entries, author identifiers, and date stamps to manifest certificates.

     <p>In normal use, <var>pathname</var> will be a CVS module, though it is
possible to point it at a directory within a module as well.  Whatever
directory you point it at will become the root of monotone's version of
the tree.

</dl>

<p><a name="Hook-Reference"></a>

<h2 class="chapter">6 Hook Reference</h2>

<p>Monotone's behavior can be customized and extended by writing
<dfn>hook functions</dfn>, which are written in the
<a href="http://www.lua.org">Lua</a> programming language. At certain points
in time, when monotone is running, it will call a hook function to
help it make a decision or perform some action.  If you provide a hook
function definition which suits your preferences, monotone will
execute it. This way you can modify how monotone behaves.

   <p>You can put new definitions for any of these hook functions in a file
<span class="file">$HOME/.monotone/monotonerc</span>, or in your working copy in
<span class="file">MT/monotonerc</span>, both of which will be read every time monotone
runs. Definitions in <span class="file">MT/monotonerc</span> shadow (override)
definitions made in your <span class="file">$HOME/.monotone/monotonerc</span>. You can also tell
monotone to interpret extra hook functions from any other <var>file</var>
using the <span class="option">--rcfile=</span><var>file</var> option; hooks defined in files
specified on the command-line will shadow hooks from the the automatic
files. 
By specifying <span class="option">--rcfile=</span><var>directory</var> you can automatically
load all the files contained into <var>directory</var>.

   <p>Monotone also makes available to hook writers a number of helper
functions exposing functionality not available with standard lua.

   <p>For the complete source of the default hooks see <a href="#Default-hooks">Default hooks</a>.

<p><a name="Hooks"></a>

<h3 class="section">6.1 Hooks</h3>

<p>This section documents the existing hook functions and their default
definitions.

     <dl>
<dt><code>note_commit (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code><a name="index-note_005fcommit-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-124"></a><dd>
Called by monotone after the version <var>new_id</var> is committed. The
second parameter, <var>revision</var> is the text of the revision, what would
be given by "monotone cat revision <var>new_id</var>". The
third parameter, <var>certs</var>, is a lua table containing the set of
certificate names and values committed along with this version. There
is no default definition for this hook.

     <p>Note that since the <var>certs</var> table does not contain cryptographic
or trust information, and only contains one entry per cert name, it is
an incomplete source of information about the committed version. This
hook is only intended as an aid for integrating monotone with informal
commit-notification systems such as mailing lists or news services. It
should not perform any security-critical operations.

     <br><dt><code>note_netsync_revision_received (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code><a name="index-note_005fnetsync_005frevision_005freceived-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-125"></a><dd>
Called by monotone after the revision <var>new_id</var> is recieved through
netsync. <var>revision</var> is the text of the revision, what would be given
by "monotone cat revision <var>new_id</var>". <var>certs</var> is a lua table
containing one subtable for each
cert attached to the revision <var>new_id</var>. These subtables have fields
named "key", "name", and "value", containing the signing key for the cert,
the name of the cert, and the value of the cert. There is no default
definition for this hook.

     <br><dt><code>note_netsync_cert_received (</code><var>rev_id</var><code>, </code><var>key</var><code>,</code><a name="index-note_005fnetsync_005fcert_005freceived-_0028_0040var_007brev_005fid_007d_002c-_0040var_007bkey_007d_002c-126"></a><dd>                                  <var>name</var>, <var>value</var>)

     <p>Called by monotone after a cert is received through netsync, iff the revision
that the cert is attached to was not also received in the same netsync
operation. <var>rev_id</var> is the revision id that the cert is attached to,
<var>key</var> is the key that the cert is signed with, <var>name</var> is the name
of the cert, and <var>value</var> is the cert value. There is no default
definition for this hook.

     <br><dt><code>note_netsync_pubkey_received (</code><var>keyname</var><code>)</code><a name="index-note_005fnetsync_005fpubkey_005freceived-_0028_0040var_007bkeyname_007d_0029-127"></a><dd>
Called by monotone after a pubkey is received through netsync. <var>keyname</var>
is the name of the key received. There is no default definition for this hook.

     <br><dt><code>get_branch_key (</code><var>branchname</var><code>)</code><a name="index-get_005fbranch_005fkey-_0028_0040var_007bbranchname_007d_0029-128"></a><dd>
Returns a string which is the name of an <span class="sc">rsa</span> private key used to sign
certificates in a particular branch <var>branchname</var>. There is no
default definition for this hook. The command-line option
<span class="option">--key=</span><var>keyname</var> overrides any value returned from this
hook function. If you have only one private key in your database, you
do not need to define this function or provide a
<span class="option">--key=</span><var>keyname</var> option; monotone will guess that you want
to use the unique private key.

     <br><dt><code>get_passphrase (</code><var>keypair_id</var><code>)</code><a name="index-get_005fpassphrase-_0028_0040var_007bkeypair_005fid_007d_0029-129"></a><dd>
Returns a string which is the passphrase used to encrypt the private
half of <var>keypair_id</var> in your database, using the <span class="sc">arc4</span> symmetric
cipher.  <var>keypair_id</var> is a Lua string containing the label that you
used when you created your key &mdash; something like
<code>"nicole@example.com"</code>.  This hook has no default definition. If
this hook is not defined or returns false, monotone will prompt you for
a passphrase each time it needs to use a private key.

     <br><dt><code>get_author (</code><var>branchname</var><code>)</code><a name="index-get_005fauthor-_0028_0040var_007bbranchname_007d_0029-130"></a><dd>
Returns a string which is used as a value for automatically generated
<code>author</code> certificates when you commit changes to
<var>branchname</var>.  Generally this hook remains undefined, and monotone
selects your signing key name for the author certificate. You can use
this hook to override that choice, if you like.

     <p>This hook has no default definition, but a possible definition might be:
     <pre class="smallexample">          function get_author(branchname)
                  local user = os.getenv("USER")
                  local host = os.getenv("HOSTNAME")
                  if ((user == nil) or (host == nil)) then return nil end
                  return string.format("%s@%s", user, host)
          end
     </pre>
     <br><dt><code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_message</var><code>)</code><a name="index-edit_005fcomment-_0028_0040var_007bcommentary_007d_002c-_0040var_007buser_005flog_005fmessage_007d_0029-131"></a><dd>
Returns a log entry for a given set of changes, described in
<var>commentary</var>.  The commentary is identical to the output of
<span class="command">monotone status</span>. This hook is intended to interface with
some sort of editor, so that you can interactively document each
change you make. The result is used as the value for a
<code>changelog</code> certificate, automatically generated when you commit
changes.

     <p>The contents of <span class="file">MT/log</span> are read and passed as
<var>user_log_message</var>. This allows you to document your changes as
you proceed instead of waiting until you are ready to commit. Upon
a successful commit, the contents of <span class="file">MT/log</span> are erased setting
the system up for another edit/commit cycle.

     <p>For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>persist_phrase_ok ()</code><a name="index-persist_005fphrase_005fok-_0028_0029-132"></a><dd>
Returns <code>true</code> if you want monotone to remember the passphrase of
a private key for the duration of a single command, or <code>false</code> if
you want monotone to prompt you for a passphrase for each certificate
it generates. Since monotone often generates several certificates in
quick succession, unless you are very concerned about security you
probably want this hook to return <code>true</code>.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function persist_phrase_ok()
                  return true
          end
     </pre>
     <br><dt><code>non_blocking_rng_ok ()</code><a name="index-non_005fblocking_005frng_005fok-_0028_0029-133"></a><dd>
Returns <code>true</code> if you are willing to let monotone use the
system's non-blocking random number generator, such as
<span class="file">/dev/urandom</span>, for generating random values during cryptographic
operations. This diminishes the cryptographic strength of such
operations, but speeds them up. Returns <code>false</code> if you want to
force monotone to always use higher quality random numbers, such as
those from <span class="file">/dev/random</span>.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function non_blocking_rng_ok()
                  return true
          end
     </pre>
     <br><dt><code>use_inodeprints ()</code><a name="index-use_005finodeprints-_0028_0029-134"></a><dd>
Returns <code>true</code> if you want monotone to automatically enable
<a href="#Inodeprints">Inodeprints</a> support in all working copies.  Only affects working
copies created after you modify the hook.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function use_inodeprints()
                  return false
          end
     </pre>
     <br><dt><code>get_netsync_read_permitted (</code><var>branch</var><code>, </code><var>identity</var><code>)</code><a name="index-get_005fnetsync_005fread_005fpermitted-_0028_0040var_007bbranch_007d_002c-_0040var_007bidentity_007d_0029-135"></a><dd>
Returns <code>true</code> if a peer authenticated as key <var>identity</var>
should be allowed to read from your database certs, revisions,
manifests, and files associated with <var>branch</var>; otherwise <code>false</code>. 
This hook has no default definition, therefore the default behavior is
to deny all reads.

     <p>If a client connects anonymously, this hook will be called with a
<var>identity</var> of <code>nil</code>.

     <p>Note that the <var>identity</var> value is a key ID (such as
&ldquo;<code>graydon@pobox.com</code>&rdquo;) but will correspond to a <em>unique</em>
key fingerprint (hash) in your database. Monotone will not permit two
keys in your database to have the same ID. Make sure you confirm the
key fingerprints of each key in your database, as key ID strings are
&ldquo;convenience names&rdquo;, not security tokens.

     <br><dt><code>get_netsync_write_permitted (</code><var>identity</var><code>)</code><a name="index-get_005fnetsync_005fwrite_005fpermitted-_0028_0040var_007bidentity_007d_0029-136"></a><dd>
Returns <code>true</code> if a peer authenticated as key <var>identity</var> should
be allowed to write into your database certs, revisions, manifests, and
files; otherwise <code>false</code>.  This hook has no default definition,
therefore the default behavior is to deny all writes.

     <p>If a client connects anonymously, it will be unconditionally denied
write access; this hook will <em>not</em> be called with a <var>identity</var>
of <code>nil</code>.

     <p>Note that the <var>identity</var> value is a key ID (such as
&ldquo;<code>graydon@pobox.com</code>&rdquo;) but will correspond to a <em>unique</em>
key fingerprint (hash) in your database. Monotone will not permit two
keys in your database to have the same ID. Make sure you confirm the
key fingerprints of each key in your database, as key ID strings are
&ldquo;convenience names&rdquo;, not security tokens.

     <br><dt><code>ignore_file (</code><var>filename</var><code>)</code><a name="index-ignore_005ffile-_0028_0040var_007bfilename_007d_0029-137"></a><dd>
Returns <code>true</code> if <var>filename</var> should be ignored while adding,
dropping, or moving files. Otherwise returns <code>false</code>. This is
most important when performing recursive actions on directories, which
may affect multiple files simultaneously. 
For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>ignore_branch (</code><var>branchname</var><code>)</code><a name="index-ignore_005fbranch-_0028_0040var_007bbranchname_007d_0029-138"></a><dd>
Returns <code>true</code> if <var>branchname</var> should be ignored while listing
branches. Otherwise returns <code>false</code>. This hook has no default
definition, therefore the default behavior is to list all branches.

     <br><dt><code>get_revision_cert_trust (</code><var>signers</var><code>, </code><var>id</var><code>, </code><var>name</var><code>, </code><var>val</var><code>)</code><a name="index-get_005frevision_005fcert_005ftrust-_0028_0040var_007bsigners_007d_002c-_0040var_007bid_007d_002c-_0040var_007bname_007d_002c-_0040var_007bval_007d_0029-139"></a><dd>
Returns whether or not you <em>trust</em> the assertion
<var>name</var>=<var>value</var> on a given revision <var>id</var>, given a valid
signature from all the keys in <var>signers</var>. The <var>signers</var>
parameter is a table containing all the key names which signed this
cert, the other three parameters are strings.

     <p>The default definition of this hook simply returns <code>true</code>, which
corresponds to a form of trust where every key which is defined in
your database is trusted. This is a <em>weak</em> trust setting; you
should change it to something stronger. A possible example of a
stronger trust function (along with a utility function for computing
the intersection of tables) is the following:

     <pre class="smallexample">          function intersection(a,b)
             local s={}
             local t={}
             for k,v in pairs(a) do s[v] = 1 end
             for k,v in pairs(b) do if s[v] ~= nil then table.insert(t,v) end end
             return t
          end
          
          function get_revision_cert_trust(signers, id, name, val)
             local trusted_signers = { "bob@happyplace.example.com",
                                       "friend@trustedplace.example.com",
                                       "myself@home.example.com" }
             local t = intersection(signers, trusted_signers)
          
             if t == nil then return false end
          
             if    (name ~= "ancestor" and table.getn(t) &gt;= 1)
                or (name == "ancestor" and table.getn(t) &gt;= 2)
             then
                return true
             else
                return false
             end
          end
     </pre>
     <p>In this example, any revision certificate is trusted if it is signed
by at least one of three &ldquo;trusted&rdquo; keys, unless it is an
<code>ancestor</code> certificate, in which case it must be signed by
<em>two</em> or more trusted keys. This is one way of requiring that
ancestry assertions go through an extra &ldquo;reviewer&rdquo; before they are
accepted.

     <br><dt><code>accept_testresult_change (</code><var>old_results</var><code>, </code><var>new_results</var><code>)</code><a name="index-accept_005ftestresult_005fchange-_0028_0040var_007bold_005fresults_007d_002c-_0040var_007bnew_005fresults_007d_0029-140"></a><dd>
This hook is used by the update algorithm to determine whether a
change in test results between update source and update target is
acceptable. The hook is called with two tables, each of which maps a
signing key &ndash; representing a particular testsuite &ndash; to a boolean
value indicating whether or not the test run was successful. The
function should return <code>true</code> if you consider an update from the
version carrying the <var>old_results</var> to the version carrying the
<var>new_results</var> to be acceptable.

     <p>The default definition of this hook follows:

     <pre class="smallexample">          function accept_testresult_change(old_results, new_results)
             for test,res in pairs(old_results)
             do
                if res == true and new_results[test] ~= true
                then
          	 return false
                end
             end
             return true
          end
     </pre>
     <p>This definition accepts only those updates which preserve the set of
<code>true</code> test results from update source to target. If no rest
results exist, this hook has no affect; but once a <code>true</code> test
result is present, future updates will require it. If you want a more
lenient behavior you must redefine this hook.

     <p><a name="merge2"></a>
<br><dt><code>merge2 (</code><var>left</var><code>, </code><var>right</var><code>)</code><a name="index-merge2-_0028_0040var_007bleft_007d_002c-_0040var_007bright_007d_0029-141"></a><dd>
Returns a string, which should be the merger of the 2 provided
strings, which are the contents of the <var>left</var> and <var>right</var>
nodes of a file fork which monotone was unable to automatically
merge. The merge should either call an intelligent merge program or
interact with the user. 
For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <p><a name="get_005fpreferred_005fmerge2_005fcommand"></a>
<br><dt><code>get_preferred_merge2_command(</code><var>tbl</var><code>)</code><a name="index-get_005fpreferred_005fmerge2_005fcommand_0028_0040var_007btbl_007d_0029-142"></a><dd>
Returns the results of running an external merge on two strings. 
<var>tbl</var> wraps up the various arguments for each merge command and
is always provided by <a href="#merge2">merge2</a>. If there is a particular editor
that you would like to use to perform merge2 operations, override
this hook to specify it.

     <p><a name="merge3"></a>
<br><dt><code>merge3 (</code><var>ancestor</var><code>, </code><var>left</var><code>, </code><var>right</var><code>)</code><a name="index-merge3-_0028_0040var_007bancestor_007d_002c-_0040var_007bleft_007d_002c-_0040var_007bright_007d_0029-143"></a><dd>
Returns a string, which should be the merger of the 3 provided
strings, which are the contents of <var>left</var> and <var>right</var> nodes,
and least common <var>ancestor</var>, of a file fork which monotone was
unable to automatically merge. This hook delegates the actual merge
to the result of <a href="#get_005fpreferred_005fmerge3_005fcommand">get_preferred_merge3_command</a>. 
For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <p><a name="get_005fpreferred_005fmerge3_005fcommand"></a>
<br><dt><code>get_preferred_merge3_command(</code><var>tbl</var><code>)</code><a name="index-get_005fpreferred_005fmerge3_005fcommand_0028_0040var_007btbl_007d_0029-144"></a><dd>
Returns the results of running an external merge on three strings. 
<var>tbl</var> wraps up the various arguments for each merge command and
is always provided by <a href="#merge3">merge3</a>. If there is a particular editor
that you would like to use to perform merge3 operations, override
this hook to specify it.

     <br><dt><code>expand_selector (</code><var>str</var><code>)</code><a name="index-expand_005fselector-_0028_0040var_007bstr_007d_0029-145"></a><dd>
Attempts to expand <var>str</var> as a selector. Expansion generally means
providing a type prefix for the selector, such as <code>a:</code> for
authors or <code>d:</code> for dates. Expansion may also mean recognizing
and interpreting special words such as <code>yesterday</code> or <code>6
months ago</code> and converting them into well formed selectors. For more
detail on the use of selectors, see <a href="#Selectors">Selectors</a>. 
For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>expand_date (</code><var>str</var><code>)</code><a name="index-expand_005fdate-_0028_0040var_007bstr_007d_0029-146"></a><dd>
Attempts to expand <var>str</var> as a date expression. Expansion means recognizing
and interpreting special words such as <code>yesterday</code> or <code>6
months ago</code> and converting them into well formed date expressions. For more
detail on the use of selectors, see <a href="#Selectors">Selectors</a>. 
For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>get_system_linesep ()</code><a name="index-get_005fsystem_005flinesep-_0028_0029-147"></a><dd>
Returns a string which defines the default system line separator. 
This should be one of the strings <code>CR</code>, <code>LF</code>, or
<code>CRLF</code>. The system line separator may be used when reading or
writing data to the terminal, or otherwise interfacing with the user. 
The system line separator is not used to convert files in the working
copy; use <code>get_linesep_conv</code> for converting line endings in the
working copy.

     <p>This hook has no default definition. For more information on line
ending conversion, see the section on <a href="#Internationalization">Internationalization</a>.

     <br><dt><code>get_linesep_conv (</code><var>filename</var><code>)</code><a name="index-get_005flinesep_005fconv-_0028_0040var_007bfilename_007d_0029-148"></a><dd>
Returns a table which contains two strings. The first string in the
return value is the name of a line ending convention to use for the
&ldquo;internal&rdquo; representation of <var>filename</var>. The second string in
the return value is the name of a line ending convention to use for
the &ldquo;external&rdquo; representation of <var>filename</var>. Line ending
conventions should be one of the strings <code>CR</code>, <code>LF</code>, or
<code>CRLF</code>.

     <p>When <var>filename</var> is read from the working copy, it is run through
line ending conversion from the external form to the internal
form. When <var>filename</var> is written to the working copy, it is run
through line ending conversion from the internal form to the external
form. <span class="sc">sha1</span> values are calculated from the internal form of
<var>filename</var>. It is your responsibility to decide which line ending
conversions your work will use.

     <p>This hook has no default definition; monotone's default behavior is to
keep external and internal forms byte-for-byte identical. For more
information on line ending conversion, see the section on
<a href="#Internationalization">Internationalization</a>.

     <br><dt><code>get_charset_conv (</code><var>filename</var><code>)</code><a name="index-get_005fcharset_005fconv-_0028_0040var_007bfilename_007d_0029-149"></a><dd>
Returns a table which contains two strings. The first string in the
return value is the name of a character set to use for the
&ldquo;internal&rdquo; representation of <var>filename</var>. The second string in
the return value is the name of a character set to use for the
&ldquo;external&rdquo; representation of <var>filename</var>.

     <p>When <var>filename</var> is read from the working copy, it is run through
character set conversion from the external form to the internal
form. When <var>filename</var> is written to the working copy, it is run
through character set conversion from the internal form to the
external form. <span class="sc">sha1</span> values are calculated from the internal
form of <var>filename</var>. It is your responsibility to decide which
character set conversions your work will use.

     <p>This hook has no default definition; monotone's default behavior is to
keep external and internal forms byte-for-byte identical. For more
information on character set conversion, see the section on
<a href="#Internationalization">Internationalization</a>.

     <br><dt><code>attr_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>, </code><var>value</var><code>)</code><a name="index-attr_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_002c-_0040var_007bvalue_007d_0029-150"></a><dd>
This is not a hook function, but a <em>table</em> of hook
functions. Each entry in the table <code>attr_functions</code>, at table
entry <var>attribute</var>, is a function taking a file name <var>filename</var>
and a attribute value <var>value</var>. The function should &ldquo;apply&rdquo; the
attribute to the file, possibly in a platform-specific way.

     <p>Persistent attributes are stored in the <span class="file">.mt-attrs</span>, in your
working copy and manifest. If such a file exists, hook functions from
this table are called for each triple found in the file, after any
command which modifies the working copy. This facility can be used to
extend monotone's understanding of files with platform-specific
attributes, such as permission bits, access control lists, or special
file types.

     <p>By default, there is only one entry in this table, for the <code>execute</code>
attribute. Its definition is:

     <pre class="smallexample">          attr_functions["execute"] =
            function(filename, value)
                  if (value == "true") then
                   make_executable(filename)
                end
             end
     </pre>
     <br><dt><code>attr_init_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>)</code><a name="index-attr_005finit_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_0029-151"></a><dd>
This is not a hook function, but a <em>table</em> of hook
functions. Each entry in the table <code>attr_init_functions</code>, at table
entry <var>attribute</var>, is a function taking a file name
<var>filename</var>. Each function defines the attributes that should be
stored in <span class="file">.mt-attrs</span> for the given <var>filename</var>. This table of
hook functions is called once for each file during an <dfn>add</dfn>.

     <p>By default, there are only two entries in this table, for the
<code>execute</code> and <code>manual_merge</code> attributes. Their definition is:

     <pre class="smallexample">          attr_init_functions["execute"] =
             function(filename)
                if (is_executable(filename)) then
                  return "true"
                else
                  return nil
                  end
            end
          attr_init_functions["manual_merge"] =
             function(filename)
                if (binary_file(filename)) then
                  return "true" -- binary files must merged manually
                else
                  return nil
                end
             end
     </pre>
     <p>The <code>binary_file</code> function is also defined as a lua hook. See
<a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>external_diff (</code><var>file_path</var><code>, </code><var>old_data</var><code>, </code><var>new_data</var><code>, </code><var>is_binary</var><code>,</code><a name="index-external_005fdiff-_0028_0040var_007bfile_005fpath_007d_002c-_0040var_007bold_005fdata_007d_002c-_0040var_007bnew_005fdata_007d_002c-_0040var_007bis_005fbinary_007d_002c-152"></a><dd>                     <var>diff_args</var>, <var>old_rev</var>, <var>new_rev</var>)

     <p>Called for each file when <span class="command">diff</span> is given the
<span class="option">--external</span> command.  <var>file_path</var> is the pathname of the
file that is being diffed.  <var>old_data</var> and <var>new_data</var> are the
data contents of the old and the new file.  If the data is binary,
<var>is_binary</var> will be true, otherwise false.  <var>old_rev</var> and
<var>new_rev</var> are the revision IDs of the old and new data.

     <p>If an extra arguments are given via <span class="option">--diff-args</span>, the string
will be passed in as <var>diff_args</var>.  Otherwise <var>diff_args</var> will
be nil.

     <p>The default implementation of this hook calls the program <code>diff</code>,
and if <span class="option">--diff-args</span> were not passed, takes default arguments
from the lua variable <code>external_diff_default_args</code>.  You can
override this variable in your configuration file, without overriding
the whole hook.

   </dl>

<p><a name="Additional-Lua-Functions"></a>

<h3 class="section">6.2 Additional Lua Functions</h3>

<p>This section documents the additional lua functions made available to
hook writers.

     <dl>
<dt><code>existonpath(</code><var>possible_command</var><code>)</code><a name="index-existonpath_0028_0040var_007bpossible_005fcommand_007d_0029-153"></a><dd>
This function receives a string containing the name of an external
program and returns 0 if it exists on path and is executable, -1
otherwise. 
As an example, <code>existonpath("xxdiff")</code> returns 0 if the
program xxdiff is available. 
On windows, this function automatically appends &ldquo;.exe&rdquo; to the
program name. In the previous example, <code>existonpath</code> would search
for &ldquo;xxdiff.exe&rdquo;.

     <br><dt><code>guess_binary(</code><var>filespec</var><code>)</code><a name="index-guess_005fbinary_0028_0040var_007bfilespec_007d_0029-154"></a><dd>
Returns true if the file appears to be binary, i.e. contains one or
more of the following characters:
     <pre class="smallexample">          0x00 thru 0x06
          0x0E thru 0x1a
          0x1c thru 0x1f
     </pre>
     <br><dt><code>include(</code><var>scriptfile</var><code>)</code><a name="index-include_0028_0040var_007bscriptfile_007d_0029-155"></a><dd>
This function tries to load and execute the script contained into
scriptfile.  It returns true for success and false if there is an
error.

     <br><dt><code>includedir(</code><var>scriptpath</var><code>)</code><a name="index-includedir_0028_0040var_007bscriptpath_007d_0029-156"></a><dd>
This function loads and executes in alphabetical order all the scripts
contained into the directory scriptpath. 
If one of the scripts has an error, the functions doesn't process the
remaining scripts and immediately returns false.

     <br><dt><code>is_executable(</code><var>filespec</var><code>)</code><a name="index-is_005fexecutable_0028_0040var_007bfilespec_007d_0029-157"></a><dd>
This function returns true if the file is executable, false
otherwise.  On windows this function returns always false.

     <br><dt><code>kill(</code><var>pid</var><code> [, </code><var>signal</var><code>])</code><a name="index-kill_0028_0040var_007bpid_007d-_005b_002c-_0040var_007bsignal_007d_005d_0029-158"></a><dd>
This function calls the kill() C library function on posix systems and
TerminateProcess on Win32 (in that case <var>pid</var> is the process
handle).  If the optional <var>signal</var> parameter is missing, SIGTERM
will be used. 
Returns 0 on succes, -1 on error.

     <br><dt><code>make_executable(</code><var>filespec</var><code>)</code><a name="index-make_005fexecutable_0028_0040var_007bfilespec_007d_0029-159"></a><dd>
This function marks the named file as executable.  On windows has no
effect.

     <br><dt><code>mkstemp(</code><var>template</var><code>)</code><a name="index-mkstemp_0028_0040var_007btemplate_007d_0029-160"></a><dd>
Like its C library counterpart,  mkstemp creates a unique name and
returns a file descriptor for the newly created file. 
The value of template should be a pointer to a character buffer loaded
with a null-terminated string that consists of contiguous, legal file
ad path name characters followed by six Xs. 
The function mkstemp replaces the Xs by an alpha-numeric sequence
that is chosen to ensure that no file in the chosen directory has that
name. 
Furthermore, subsequent calls to mkstemp within the same process
each yield different file names. 
Unlike other implementations, monotone mkstemp allows the template
string to contain a complete path, not only a filename, allowing users
to create temporary files outside the current directory.

     <p><strong>Important notice:</strong><br>
To create a temporary file, you must use the <code>temp_file()</code>
function, unless you need to run monotone with the <span class="option">--nostd</span>
option.  <code>temp_file()</code> builds on <code>mkstemp()</code> and creates a
file in the standard TMP/TEMP directories. 
For the definition of <code>temp_file()</code>, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>sleep(</code><var>seconds</var><code>)</code><a name="index-sleep_0028_0040var_007bseconds_007d_0029-161"></a><dd>
Makes the calling process sleep for the specified number of seconds.

     <br><dt><code>spawn(</code><var>executable</var><code> [, </code><var>args ...</var><code>])</code><a name="index-spawn_0028_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-162"></a><dd>
Starts the named executable with the given arguments.  Returns the
process pid on Posix systems, the process handle on Win32 or -1 if
there was an error. 
Calls fork/execvp on Posix, CreateProcess on Win32.

     <p><strong>Important notice:</strong><br>
To spawn a process and wait for its completion, use the <code>execute()</code>
function, unless you need to run monotone with the <span class="option">--nostd</span>
option.  <code>execute()</code> builds on <code>spawn()</code> and <code>wait()</code>
in a standardized way.

     <br><dt><code>wait(</code><var>pid</var><code>)</code><a name="index-wait_0028_0040var_007bpid_007d_0029-163"></a><dd>
Wait until the process with given pid (process handle on Win32) exits. 
Returns two values: a result value and the exit code of the waited-for
process. 
The exit code is meaningful only if the result value is 0.

   </dl>

<p><a name="Special-Topics"></a>

<h2 class="chapter">7 Special Topics</h2>

<p>This chapter describes some &ldquo;special&rdquo; issues which are not directly
related to monotone's <em>use</em>, but which are occasionally of
interest to people researching monotone or trying to learn the
specifics of how it works. Most users can ignore these sections.

<p><a name="Internationalization"></a>

<h3 class="section">7.1 Internationalization</h3>

<p>Monotone initially dealt with only ASCII characters, in file path
names, certificate names, key names, and packets. Some
conservative extensions are provided to permit internationalized
use. These extensions can be summarized as follows:

     <ul>
<li>Monotone uses GNU gettext to provide localized progress and error
messages. Translations may or may not exist for your locale, but the
infrastructure is present to add them.

     <li>All command-line arguments are mapped from your local character set to
UTF-8 before processing. This means that monotone can <em>only</em>
handle key names, file names and certificate names which map cleanly
into UTF-8.

     <li>Monotone's control files are stored in UTF-8. This includes: revisions
and manifests, both inside the database and when written to the
<span class="file">MT/</span> directory of the working copy; the <span class="file">MT/options</span> and
<span class="file">MT/work</span> files; and the <span class="file">.mt-attrs</span> file. Converting these
files to any other character set will cause monotone to break; do not
do so.

     <li>File path names in the working copy are converted to the locale's
character set (determined via the LANG or CHARSET environment
variables) before monotone interacts with the file system. If you are
accustomed to being able to use file names in your locale's character
set, this should &ldquo;just work&rdquo; with monotone.

     <li>Key and cert names, and similar &ldquo;name-like&rdquo; entities are subject to
some cleaning and normalization, and conversion into network-safe
subsets of ASCII (typically ACE). Generally, you should be able to use
&ldquo;sensible&rdquo; strings in your locale's character set as names, but they
may appear mangled or escaped in certain contexts such as network
transmission.

     <li>Monotone's transmission and storage forms are otherwise
unchanged. Packets and database contents are 7-bit clean ASCII.

   </ul>

   <p>The remainder of this section is a precise specification of monotone's
internationalization behavior.

<h3 class="heading">General Terms</h3>

     <dl>
<dt>Character set conversion<dd>The process of mapping a string of bytes representing wide characters
from one encoding to another. Per-file character set conversions are
specified by a Lua hook <code>get_charset_conv</code> which takes a filename
and returns a table of two strings: the first represents the
"internal" (database) charset, the second represents the "external"
(file system) charset.

     <br><dt>Line ending conversion<dd>The process of converting platform-dependent end-of-line codes
(<code>0x0D</code>, <code>0x0A</code>, or the pair <code>0x0D 0x0A</code>) from one
convention to another. Per-file line ending conversion is specified by
a Lua hook <code>get_linesep_conv</code> which takes a filename and returns
a table of two strings: the first represents the "internal" (database)
line ending convention, the second represents the "external"
(file system) line ending convention. each string should be one of the
three strings "CR", "LF", or "CRLF".

     <p>Note that Line ending conversion is always performed on the internal
character set, when both character set and line ending conversion are
enabled; this behavior is meant to encourage the use of the monotone's
&ldquo;normal form&rdquo; (UTF-8, '\n') as an internal form for your source
files, when working with multiple external forms. Also note that line
ending conversion only works on character encodings with the specific
code bytes described above, such as ASCII, ISO-8859x, and UTF-8.

     <br><dt>Normal form conversion<dd>Character set and line ending conversions done between a "system form"
and a "normal form". The system character set form is inferred from
the environment, using the various locale environment variables. The
system line ending form can be additionally specialized using the
<code>get_system_linesep</code> hook. No hooks exist for adjusting the
system character set, since the system character set must be known
during command-line argument processing, before any Lua hooks are
loaded.

     <p>Monotone's normal form is the UTF-8 character set and the <code>0x0A</code>
(LF) line ending form. This form is used in any files monotone needs
to read, write, and interpret itself, such as: <span class="file">MT/revision</span>,
<span class="file">MT/work</span>, <span class="file">MT/options</span>, <span class="file">.mt-attrs</span>

     <br><dt>LDH<dd>Letters, digits, and hyphen: the set of ASCII bytes <code>0x2D</code>,
<code>0x30..0x39</code>, <code>0x41..0x5A</code>, and <code>0x61..0x7A</code>.

     <br><dt>stringprep<dd>RFC 3454, a general framework for mapping, normalizing, prohibiting
and bidirectionality checking for international names prior to use in
public network protocols.

     <br><dt>nameprep<dd>RFC 3491, a specific profile of stringprep, used for preparing
international domain names (IDNs)

     <br><dt>punycode<dd>RFC 3492, a "bootstring" encoding of unicode into ASCII.

     <br><dt>IDNA<dd>RFC 3490, international domain names for applications, a combination
of the above technologies (nameprep, punycoding, limiting to LDH
characters) to form a specific "ASCII compatible encoding" (ACE) of
unicode, signified by the presence of an "unlikely" ACE prefix string
"xn&ndash;". IDNA is intended to make it possible to use unicode relatively
"safely" over legacy ASCII-based applications. the general picture of
an IDNA string is this:

     <pre class="smallexample">                {ACE-prefix}{LDH-sanitized(punycode(nameprep(UTF-8-string)))}
     </pre>
     <p>It is important to understand that IDNA encoding does <em>not</em>
preserve the input string: it both prohibits a wide variety of
possible strings and normalizes non-equal strings to supposedly
"equivalent" forms.

     <p>By default, monotone does <em>not</em> decode IDNA when printing to the
console (IDNA names are ASCII, which is a subset of UTF-8, so this
normal form conversion can still apply, albeit oddly). this behavior
is to protect users against security problems associated with
malicious use of "similar-looking" characters. If the hook
<code>display_decoded_idna</code> returns true, IDNA names are decoded for
display.

</dl>

<h3 class="heading">Filenames</h3>

     <ul>
<li>Filenames are subject to normal form conversion.

     <li>Filenames are subject to an additional normal form stage which adjusts
for platform name semantics, for example changing the Windows
<code>0x5C</code> '\' path separator to <code>0x2F</code> '/'. This extra
processing is performed by boost::filesystem.

     <li>FIXME: Monotone does not properly handle case insensitivity on windows.

     <li>A filename (in normal form) is constrained to be a nonempty sequence
of path components, separated by byte <code>0x2F</code> (ASCII / ), and
without a leading or trailing <code>0x2F</code>.

     <li>A path component is a nonempty sequence of any UTF-8 character codes
except the path separator byte <code>0x2F</code> and any ASCII "control codes"
(<code>0x00..0x1F</code> and <code>0x7F</code>).

     <li>The path components "." and ".." are prohibited.

     <li>Manifests and revisions are constructed from the normal form
(UTF-8). The LC_COLLATE locale category is <em>not</em> used to sort
manifest or revision entries.

</ul>

<h3 class="heading">File contents</h3>

     <ul>
<li>Files are subject to character set conversion and line ending
conversion.

     <li>File SHA1 values are calculated from the internal form of the
conversions. If the external form of a file differs from the internal
form, running a 3rd party program such as <code>sha1sum</code> will produce
different results than those entries shown in a corresponding manifest.

</ul>

<h3 class="heading">UI messages</h3>

<p>UI messages are displayed via calls to <code>gettext()</code>.

<h3 class="heading">Host names</h3>

<p>Host names are read on the command-line and subject to normal form
conversion. Host names are then split at <code>0x2E</code> (ASCII '.'), each
component is subject to IDNA encoding, and the components are
rejoined.

   <p>After processing, host names are stored internally as ASCII. The
invariant is that a host name inside monotone contains only sequences
of LDH separated by <code>0x2E</code>.

<h3 class="heading">Cert names</h3>

<p>Read on the command line and subject to normal form conversion and
IDNA encoding as a single component. The invariant is that a cert name
inside monotone is a single LDH ASCII string.

<h3 class="heading">Cert values</h3>

<p>Cert values may be either text or binary, depending on the return
value of the hook <code>cert_is_binary</code>. If binary, the cert value is
never printed to the screen (the literal string "&lt;binary&gt;" is
displayed, instead), and is never subjected to line ending or
character conversion. If text, the cert value is subject to normal
form conversion, as well as having all UTF-8 codes corresponding to
ASCII control codes (<code>0x0..0x1F</code> and <code>0x7F</code>) prohibited in
the normal form, except <code>0x0A</code> (ASCII LF).

<h3 class="heading">Var domains</h3>

<p>Read on the command line and subject to normal form conversion and IDNA
encoding as a single component. The invariant is that a var domain
inside monotone is a single LDH ASCII string.

<h3 class="heading">Var names and values</h3>

<p>Var names and values are assumed to be text, and subject to normal form
conversion.

<h3 class="heading">Key names</h3>

<p>Read on the command line and subject to normal form conversion and
IDNA encoding as an email address (split and joined at '.' and '@'
characters). The invariant is that a key name inside monotone contains
only LDH, <code>0x2E</code> (ASCII '.') and <code>0x40</code> (ASCII '@')
characters.

<h3 class="heading">Packets</h3>

<p>Packets are 7-bit ASCII. The characters permitted in packets are
the union of these character sets:

     <ul>
<li>The 65 characters of base64 encoding (64 coding + "=" pad). 
<li>The 16 characters of hex encoding. 
<li>LDH, '@' and '.' characters, as required for key and cert names. 
<li>'[' and ']', the packet delimiters. 
<li>ASCII codes 0x0D (CR), 0x0A (LF), 0x09 (HT), and 0x20 (SP). 
</ul>

<h3 class="heading">The <span class="file">.mt-attrs</span> file</h3>

<p>Now uses 0x0A (ASCII LF) as a delimiter, to permit 0x20 in
filenames. This may change in the future.

<p><a name="Hash-Integrity"></a>

<h3 class="section">7.2 Hash Integrity</h3>

<p>Some proponents of a competing, proprietary version control system
have suggested, in a
<a href="http://www.usenix.org/events/hotos03/tech/full_papers/henson/henson_html/">usenix paper</a>, that the use of a cryptographic hash function such as
<span class="sc">sha1</span> as an identifier for a version is unacceptably unsafe. This
section addresses the argument presented in that paper and describes
monotone's additional precautions.

   <p>To summarize our position:
     <ul>
<li>the analysis in the paper is wrong,
<li>even if it were right, monotone is sufficiently safe. 
</ul>

<h3 class="heading">The analysis is wrong</h3>

<p>The paper displays a fundamental lack of understanding about what a
<em>cryptographic</em> hash function is, and how it differs from a
normal hash function. Furthermore it confuses accidental collision
with attack scenarios, and mixes up its analysis of the risk involved
in each. We will try to untangle these issues here.

   <p>A cryptographic hash function such as <span class="sc">sha1</span> is more than just a
uniform spread of inputs to an output range. Rather, it must be
designed to withstand attempts at:

     <ul>
<li>reversal: deriving an input value from the output
<li>collision: finding two different inputs which hash to the same output
</ul>

   <p>Collision is the problem the paper is concerned with. Formally, an
n-bit cryptographic hash should cost 2^n work units to collide
against a given value, and sqrt(2^n) tries to find a random
pair of colliding values. This latter probability is sometimes called
the hash's &ldquo;birthday paradox probability&rdquo;.

<h4 class="subheading">Accidental collision</h4>

<p>One way of measuring these bounds is by measuring how single-bit
changes in the input affect bits in the hash output. The <span class="sc">sha1</span>
hash has a strong <em>avalanche property</em>, which means that flipping
<em>any one bit</em> in the input will cause on average half the 160
bits in the output code to change. The fanciful <span class="sc">val1</span> hash
presented in the paper does not have such a property &mdash; flipping its
first bit when all the rest are zero causes <em>no change</em> to any of
the 160 output bits &mdash; and is completely unsuited for use as a
<em>cryptographic hash</em>, regardless of the general shape of its
probability distribution.

   <p>The paper also suggests that birthday paradox probability cannot be
used to measure the chance of accidental <span class="sc">sha1</span> collision on &ldquo;real
inputs&rdquo;, because birthday paradox probability assumes a uniformly
random sample and &ldquo;real inputs&rdquo; are not uniformly random. The paper
is wrong: the inputs to <span class="sc">sha1</span> are not what is being measured (and
in any case can be arbitrarily long); the collision probability being
measured is of <em>output space</em>. On output space, the hash is
designed to produce uniformly random spread, even given nearly
identical inputs. In other words, it is <em>a primary design
criterion</em> of such a hash that a birthday paradox probability is a
valid approximation of its collision probability.

   <p>The paper's characterization of risk when hashing &ldquo;non-random
inputs&rdquo; is similarly deceptive. It presents a fanciful case of a
program which is <em>storing</em> every possible 2kb block in a
file system addressed by <span class="sc">sha1</span> (the program is trying to find a
<span class="sc">sha1</span> collision). While this scenario <em>will</em> very likely
encounter a collision <em>somewhere</em> in the course of storing all
such blocks, the paper neglects to mention that we only expect it to
collide after storing about 2^80 of the 2^16384 possible
such blocks (not to mention the requirements for compute time to
search, or disk space to store 2^80 2kb blocks).

   <p>Noting that monotone can only store 2^41 bytes in a database,
and thus probably some lower number (say 2^32 or so) active
rows, we consider such birthday paradox probability well out of
practical sight. Perhaps it will be a serious concern when
multi-yottabyte hard disks are common.

<h4 class="subheading">Collision attacks</h4>

<p>Setting aside accidental collisions, then, the paper's underlying
theme of vulnerability rests on the assertion that someone will break
<span class="sc">sha1</span>. Breaking a cryptographic hash usually means finding a way
to collide it trivially. While we note that <span class="sc">sha1</span> has in fact
resisted attempts at breaking for 8 years already, we cannot say that
it will last forever. Someone might break it. We can say, however,
that finding a way to trivially collide it only changes the resistance
to <em>active attack</em>, rather than the behavior of the hash on
benign inputs.

   <p>Therefore the vulnerability is not that the hash might suddenly cease
to address benign blocks well, but merely that additional security
precautions might become a requirement to ensure that blocks are
benign, rather than malicious. The paper fails to make this
distinction, suggesting that a hash becomes &ldquo;unusable&rdquo; when it is
broken. This is plainly not true, as a number of systems continue to
get useful low collision hashing behavior &mdash; just not good security
behavior &mdash; out of &ldquo;broken&rdquo; cryptographic hashes such as MD4.

<h3 class="heading">Monotone is probably safe anyways</h3>

<p>Perhaps our arguments above are unconvincing, or perhaps you are the
sort of person who thinks that practice never lines up with
theory. Fair enough. Below we present <em>practical</em> procedures you
can follow to compensate for the supposed threats presented in the
paper.

<h4 class="subheading">Collision attacks</h4>

<p>A successful collision attack on <span class="sc">sha1</span>, as mentioned, does not
disrupt the <em>probability</em> features of <span class="sc">sha1</span> on benign
blocks. So if, at any time, you believe <span class="sc">sha1</span> is &ldquo;broken&rdquo;, it
does <em>not</em> mean that you cannot use it for your work with
monotone. It means, rather, that you cannot base your <em>trust</em> on
<span class="sc">sha1</span> values anymore. You must trust who you communicate with.

   <p>The way around this is reasonably simple: if you do not trust
<span class="sc">sha1</span> to prevent malicious blocks from slipping into your
communications, you can always augment it by enclosing your
communications in more security, such as tunnels or additional
signatures on your email posts. If you choose to do this, you will
still have the benefit of self-identifying blocks, you will simply
cease to trust such blocks unless they come with additional
authentication information.

   <p>If in the future <span class="sc">sha1</span> (or, indeed, <span class="sc">rsa</span>) becomes accepted as
broken we will naturally upgrade monotone to a newer hash or public
key scheme, and provide migration commands to recalculate existing
databases based on the new algorithm.

   <p>Similarly, if you do not trust our vigilance in keeping up to date
with cryptography literature, you can modify monotone to use any
stronger hash you like, at the cost of isolating your own
communications to a group using the modified version. Monotone is free
software, and runs atop <code>crypto++</code>, so it is both legal and
relatively simple to change it to use some other algorithm.

<p><a name="Rebuilding-ancestry"></a>

<h3 class="section">7.3 Rebuilding ancestry</h3>

<p>As described in <a href="#Historical-records">Historical records</a>, monotone revisions contain the
<span class="sc">sha1</span> hashes of their predecessors, which in turn contain the
<span class="sc">sha1</span> hashes of <em>their</em> predecessors, and so on until the
beginning of history.  This means that it is <em>mathematically
impossible</em> to modify the history of a revision, without some way to
defeat <span class="sc">sha1</span>.  This is generally a good thing; having immutable
history is the point of a version control system, after all, and it
turns out to be very important to building a <em>distributed</em> version
control system like monotone.

   <p>It does have one unfortunate consequence, though.  It means that in the
rare occasion where one <em>needs</em> to change a historical revision, it
will change the <span class="sc">sha1</span> of that revision, which will change the text
of its children, which will change their <span class="sc">sha1</span>s, and so on;
basically the entire history graph will diverge from that point
(invalidating all certs in the process).

   <p>In practice there are two situations where this might be necessary:
     <ul>
<li>bugs: monotone has occasionally allowed nonsense, uninterpretable
changesets to be generated and stored in the database, and this was not
detected until further work had been based off of them. 
<li>advances in crypto: if or when <span class="sc">sha1</span> is broken, we will need to
migrate to a different secure hash. 
</ul>
   Obviously, we hope neither of these things will happen, and we've taken
lots of precautions against the first recurring; but it is better to be
prepared.

   <p>If either of these events occur, we will provide migration commands
and explain how to use them for the situation in question; this much
is necessarily somewhat unpredictable.  In the past we've used the
<code>db rebuild</code> command, which extracts the ancestry graph from the
database and then recreates revisions from the manifests only &mdash; this
preserves the contents of each snapshot, but breaks tracking of file
identity across renames &mdash; and then reissues all existing certs that
you trust, signed with your key.<a rel="footnote" href="#fn-2" name="fnd-2"><sup>2</sup></a>

   <p>While the <code>db rebuild</code> command can reconstruct the ancestry graph
in <em>your</em> database, there are practical problems which arise when
working in a distributed work group.  For example, suppose our group
consists of the fictional developers Jim and Beth, and they need to
rebuild their ancestry graph. Jim performs a rebuild, and sends Beth
an email telling her that he has done so, but the email gets caught by
Beth's spam filter, she doesn't see it, and she blithely syncs her
database with Jim's. This creates a problem: Jim and Beth have
combined the pre-rebuild and post-rebuild databases.  Their databases
now contain two complete, parallel (but possibly overlapping) copies
of their project's ancestry.  The &ldquo;bad&rdquo; old revisions that they were
trying to get rid of are still there, mixed up with the &ldquo;good&rdquo; new
revisions.

   <p>To prevent such messy situations, monotone keeps a table of branch
<dfn>epochs</dfn> in each database. An epoch is just a large bit string
associated with a branch. Initially each branch's epoch is zero. Most
monotone commands ignore epochs; they are relevant in only two
circumstances:

     <ul>
<li>When monotone rebuilds ancestry, it generates a new <em>random</em>
epoch for each branch in the database.

     <li>When monotone runs netsync between databases, it checks to make sure
that all branches involved in the synchronization have the same
epochs. If any epochs differ, the netsync is aborted with no changes
made to either database. If either side is seeing a branch for the
first time, it adopts the epoch of the other side.

   </ul>

   <p>Thus, when a user rebuilds their ancestry graph, they select a new
epoch and thus effectively disassociate with the group of colleagues
they had previously been communicating with. Other members of that
group can then decide whether to follow the rebuild user into a new
group &mdash; by pulling the newly rebuilt ancestry &mdash; or to remain
behind in the old group.

   <p>In our example, if Jim and Beth have epochs, Jim's rebuild creates a
new epoch for their branch, in his database.  This causes monotone to
reject netsync operations between Jim and Beth; it doesn't matter if
Beth loses Jim's email. When she tries to synchronize with him, she
receives an error message indicating that the epoch does not
match. She must then discuss the matter with Jim and settle on a new
course of action &mdash; probably pulling Jim's database into a fresh
database on Beth's end &ndash; before future synchronizations will succeed.

<h3 class="heading">Best practices</h3>

<p>The previous section described the theory and rationale behind rebuilds
and epochs.  Here we discuss the practical consequences of that
discussion.

   <p>If you decide you must rebuild your ancestry graph &mdash; generally by
announcement of a bug from the monotone developers &mdash; the first thing
to do is get everyone to sync their changes with the central server;
if people have unshared changes when the database is rebuilt, they
will have trouble sharing them afterwards.

   <p>Next, the project should pick a designated person to take down the
netsync server, rebuild their database, and put the server back up
with the rebuilt ancestry in it.  Everybody else should then pull this
history into a fresh database, check out again from this database, and
continue working as normal.

   <p>In complicated situations, where people have private branches, or
ancestries cross organizational boundaries, matters are more complex. 
The basic approach is to do a local rebuild, then after carefully
examining the new revision IDs to convince yourself that the rebuilt
graph is the same as the upstream subgraph, use the special <code>db
epoch</code> commands to force your local epochs to match the upstream ones. 
(You may also want to do some fiddling with certs, to avoid getting
duplicate copies of all of them; if this situation ever arises in real
life we'll figure out how exactly that should work.)  Be very careful
when doing this; you're explicitly telling monotone to let you shoot
yourself in the foot, and it will let you.

   <p>Fortunately, this process should be extremely rare; with luck, it will
never happen at all.  But this way we're prepared.

<p><a name="Man-Page"></a>

<h2 class="chapter">8 Man Page</h2>

<!-- DEBUG: print_menu("Top") -->
<!-- TROFF INPUT: .SH NAME -->
<p><a name="NAME"></a>

<h3 class="section">8.1 NAME</h3>

<!-- DEBUG: print_menu("NAME") -->
<p>monotone &minus; distributed version control system
<!-- TROFF INPUT: .SH SYNOPSIS -->

<p><a name="SYNOPSIS"></a>

<h3 class="section">8.2 SYNOPSIS</h3>

<!-- DEBUG: print_menu("SYNOPSIS") -->
<p><b>monotone</b> <i>[options] &lt;command&gt; [parameters]</i>
<!-- TROFF INPUT: .P -->
<!-- .P -->

   <p>Options, which affect global behavior or set default values, come
first in the argument list. A single command must follow, indicating
the operation to perform, followed by parameters which vary depending
on the command. 
<!-- TROFF INPUT: .SS Note -->

<p><a name="Note"></a>

<h4 class="subsection">8.2.1 Note</h4>

<p>This man page is a summary of some of the features and commands of
<b>monotone</b>, but it is not the most detailed source of information
available. For a complete discussion of the concepts and a tutorial on
its use, please refer to the texinfo manual (via the <b>info
monotone</b> command, or online). 
<!-- TROFF INPUT: .SS Commands -->

<p><a name="Commands"></a>

<h4 class="subsection">8.2.2 Commands</h4>

<!-- TROFF INPUT: .TP -->
<!--  -->
<dl>
<dt><b>comment</b> <i>&lt;id&gt;</i><dd>Write a comment cert for a revision. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>approve</b> <i>&lt;id&gt;</i><dd>Make a &ldquo;branch&rdquo; cert approving of a revision's membership in a branch. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>disapprove</b> <i>&lt;id&gt;</i><dd>Disapprove of a revision, committing the inverse changes as as a
descendent of the disapproved revision. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>tag</b> <i>&lt;id&gt; &lt;tagname&gt;</i><dd>Put a symbolic tag cert on a revision. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>testresult</b> <i>&lt;id&gt; (0|1|true|false|yes|no|pass|fail)</i><dd>Indicate a passing or failing test result on a revision. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>diff</b> <i>[--revision=&lt;id1&gt; [--revision=&lt;id2&gt;] ] [&lt;pathname&gt;...]</i><dd>Show diffs between working copy and database. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>status</b> <i>[&lt;pathname&gt;...]</i><dd>Show status of working copy. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>log</b> <i>[id]</i><dd>Show historical log of revisions, starting from working copy
base revision, or <i>[id]</i> if given. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>cert</b> <i>&lt;id&gt; &lt;certname&gt; [certval]</i><dd>Create a custom cert for a revision. Reads cert value
from stdin if no value given on command line. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>genkey</b> <i>&lt;keyid&gt;</i><dd>Generate an <span class="sc">rsa</span> key-pair and store it in the database. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>dropkey</b> <i>&lt;keyid&gt;</i><dd>Drop a public and/or private key. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>chkeypass</b> <i>&lt;keyid&gt;</i><dd>Change passphrase of the private half of a key. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list certs</b> <i>&lt;id&gt;</i><dt><b>ls certs</b> <i> &lt;id&gt;</i><dd>List certs associated with revision. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list keys</b> <i>[partial-id]</i><dt><b>ls keys</b> <i>[partial-id]</i><dd>List keys matching glob, or list all keys if no glob given. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list branches</b><dt><b>ls branches</b><dd>List all branches. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list tags</b><dt><b>ls tags</b><dd>List all tags. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list known</b> <i>[&lt;pathname&gt;...]</i><dt><b>ls known</b> <i>[&lt;pathname&gt;...]</i><dd>List files which are in revision's manifest, or are on the work list of
the working copy. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list unknown</b> <i>[&lt;pathname&gt;...]</i><dt><b>ls unknown</b> <i>[&lt;pathname&gt;...]</i><dd>List files in working copy, but not in revision's manifest or
work list. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list ignored</b> <i>[&lt;pathname&gt;...]</i><dt><b>ls ignored</b> <i>[&lt;pathname&gt;...]</i><dd>List files intentionally ignored due to the ignore_file hook. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>list missing</b> <i>[&lt;pathname&gt;...]</i><dt><b>ls missing</b> <i>[&lt;pathname&gt;...]</i><dd>List files in revision's manifest, but not in working copy. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>fdata</b> <i>&lt;id&gt;</i><dd>Write file data packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>fdelta</b> <i>&lt;oldid&gt; &lt;newid&gt;</i><dd>Write file delta packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>mdata</b> <i>&lt;id&gt;</i><dd>Write manifest data packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>mdelta</b> <i>&lt;oldid&gt; &lt;newid&gt;</i><dd>Write manifest delta packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>rcerts</b> <i>&lt;id&gt;</i><dd>Write revision cert packets to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>rdata</b> <i>&lt;id&gt;</i><dd>Write revision data packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>privkey</b> <i>&lt;id&gt;</i><dd>Write private key packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>pubkey</b> <i>&lt;id&gt;</i><dd>Write public key packet to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>read</b> <i>[&lt;file1&gt; [&lt;file2&gt; [...]]]</i><dd>Read packets from files or stdin. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>cvs_import</b> <i>&lt;cvsroot&gt;/&lt;module&gt;</i><dd>Import all versions in a CVS module. Reconstructs revisions and converts
metadata to certificates. A private signing key must already exist in
the database. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>rcs_import</b> <i>&lt;rcsfile&gt; ...</i><dd>Import all file versions in RCS files. Does not reconstruct revisions
across the entire tree.  You do not want this command, it is for
debugging; use cvs_import. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>checkout</b> <i>[--revision=revision-id]</i> <i>[&lt;directory&gt;]</i><dt><b>co</b> <i>[--revision=revision-id]</i> <i>[&lt;directory&gt;]</i><dd>Check out revision from database, into directory. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>cat</b> <i>(file &lt;id&gt;|manifest [&lt;id&gt;]|revision [&lt;id&gt;])</i><dd>Write file, manifest or revision from database to stdout. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>heads</b><dd>Show unmerged heads of branch, or report when branch is merged. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>merge</b><dd>Merge unmerged heads of branch. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>add</b> <i>&lt;pathname&gt; [...]</i><dd>Add files to working copy. adding a file does not copy it into the
database, merely adds it to the work list. You must <b>commit</b> your
changes in order to copy added files to the database. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>drop</b> <i>&lt;pathname&gt; [...]</i><dd>Drop files from working copy. Files are not deleted from working copy,
merely noted as removals in the work list. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>rename</b> <i>&lt;src&gt; &lt;dst&gt;</i><dd>Rename files from <i>&lt;src&gt;</i> to <i>&lt;dst&gt;</i> in working copy. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>commit</b> <i>[--message=log message | --message-file=log message file] [&lt;pathname&gt;...]</i><dd>Commit working copy to database.  Each commit has a changelog message
associated with it.  If <span class="option">--message</span> is provided on the command
line, it is used; if <span class="option">--message-file</span> is provided, the content of
the named file will be used as a commit message.  If the filename is '-'
the commit message will be read from standard input.  Otherwise a log
message editor will be invoked.  If the file <span class="file">MT/log</span> exists and is
non-empty, its content is used to prefill the editor.  You cannot
specify both <span class="option">--message</span> and <span class="option">--message-file</span> at the same
time, and if <span class="file">MT/log</span> exists and is non-empty, you can cannot
specify either of them at all. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>update</b> <i>[--revision=revision]</i><dd>Update working copy. 
<!-- TROFF INPUT: .SH DESCRIPTION -->

     <br><dt><b>refresh_inodeprints</b><dd>Turn on inodeprints mode, and force a cache refresh.

     <br><dt><b>push</b> <i>&lt;host&gt; &lt;glob&gt;</i><dd>Push contents of branches matching <i>&lt;glob&gt;</i> to database on <i>&lt;host&gt;</i>
<!-- TROFF INPUT: .SH DESCRIPTION -->

     <br><dt><b>pull</b> <i>&lt;host&gt; &lt;glob&gt;</i><dd>Pull contents of branches matching <i>&lt;glob&gt;</i> from database on <i>&lt;host&gt;</i>
<!-- TROFF INPUT: .SH DESCRIPTION -->

     <br><dt><b>sync</b> <i>&lt;host&gt; &lt;glob&gt;</i><dd>Sync contents of branches matching <i>&lt;glob&gt;</i> with database on <i>&lt;host&gt;</i>
<!-- TROFF INPUT: .SH DESCRIPTION -->

     <br><dt><b>serve</b> <i>&lt;host&gt; &lt;glob&gt;</i><dd>Serve contents of branches matching <i>&lt;glob&gt;</i> at network address <i>&lt;host&gt;</i>
<!-- TROFF INPUT: .SH DESCRIPTION -->

     <br><dt><b>automate</b> <i>(interface_version|heads|ancestors|attributes|parents|descendents|children|graph|erase_ancestors|toposort|ancestry_difference|leaves|inventory|stdio|certs|select)</i><dd>Scripting interface.

     <br><dt><b>db</b> <i>(init|info|version|dump|load|migrate|execute &lt;sql&gt;)</i><dd>Manipulate database state. 
<!-- TROFF INPUT: .SH DESCRIPTION -->

</dl>

<!--  -->
<p><a name="DESCRIPTION"></a>

<h3 class="section">8.3 DESCRIPTION</h3>

<!-- DEBUG: print_menu("DESCRIPTION") -->
<p>Monotone is a version control system, which allows you to keep old
versions of files, as well as special <i>revisions</i> and <i>manifests</i>
which describe the edit history, location, and content of files in a
tree. Unlike other systems, versions in monotone are <i>identified</i> by
cryptographic hash, and operations are authenticated by individual
users' evaluating cryptographic signatures on meta-data, rather than
any central authority.

   <p>Monotone keeps a collection of versions in a single-file relational
database. It is essentially serverless, using network servers only as
untrusted communication facilities. A monotone database is a regular
file, which contains all the information needed to extract previous
versions of files, verify signatures, merge and modify versions, and
communicate with network servers. 
<!-- TROFF INPUT: .SH OPTIONS -->

<p><a name="OPTIONS"></a>

<h3 class="section">8.4 OPTIONS</h3>

<!-- DEBUG: print_menu("OPTIONS") -->
<!-- TROFF INPUT: .TP -->
<!--  -->
<dl>
<dt><b>--help</b><dd>Print help message. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--debug</b><dd>Turn on debugging log on standard error stream. This is very
verbose. Default is to be silent, unless an error occurs, in which
case failure log is dumped. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--quiet</b><dd>Turn off normal progress messages. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--dump=</b><i>&lt;file&gt;</i><dd>Dump debugging log to <i>&lt;file&gt;</i> on failure. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--nostd</b><dd>Do not evaluate "standard" Lua hooks compiled into <b>monotone</b>. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--norc</b><dd>Do not load Lua hooks from user's <b>~/.monotone/monotonerc</b> or the
working copy's <b>MT/monotonerc</b> file. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--rcfile=</b><i>&lt;file&gt;</i><dd>Load extra Lua hooks from <i>file</i> (may be given multiple times). 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--db=</b><i>&lt;file&gt;</i><dd>Use database in <i>file</i>. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--key=</b><i>&lt;keyid&gt;</i><dt><b>-k</b> <i>&lt;keyid&gt;</i><dd>Use <i>keyid</i> for operations which produce <span class="sc">rsa</span>
signatures. Default is inferred from presence of unique private key in
database. Can also be customized on a per-branch basis with hook
function <b>get</b><tt>_</tt><b>branch</b><tt>_</tt><b>key(branchname)</b>. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--branch=</b><i>&lt;branchname&gt;</i><dt><b>-b</b> <i>&lt;branchname&gt;</i><dd>Use <i>branchname</i> for operations on a branch. Default is inferred
in operations on existing branches (commit, update, etc). 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>--ticker=</b><code>[</code><b>dot</b><code>|</code><b>count</b><code>]</code><dd>Use the given method to print tickers.  The <b>count</b> method prints
the count for each ticker on one line, incrementing the numbers in
place, while the <b>dot</b> method prints a continuous string of
characters (like some programs provide a progress line of dots). 
The default is <b>count</b>.

     <br><dt><b>--revision=</b><i>&lt;id&gt;</i><dt><b>-r</b> <i>&lt;id&gt;</i><dd>Use the given revision with the current command. The revision id could be specified as a selector. <a href="#Selectors">Selectors</a>.

     <br><dt><b>--message-file=</b><i>&lt;log message file&gt;</i><dd>Use the content of the given file as the changelog when committing a new
revision rather than invoking the log message editor.  If the filename
is '-' the changelog is read from standard input.  Currently this option
only applies to the commit command, but it may also apply to the comment
command in the future.

     <br><dt><b>--message=</b><i>&lt;log message&gt;</i><dt><b>-m</b> <i>&lt;log message&gt;</i><dd>Use the given message as the changelog when committing a new revision
rather than invoking the log message editor. Currently this option only
applies to the commit command but it may also apply to the comment
command in the future.

     <br><dt><b>--author=</b><i>&lt;author email&gt;</i><dd>Use the given author as the value of the <code>author</code> cert when committing
a new revision, rather than the default author.  Useful when
committing a patch on behalf of someone else, or when importing
history from another version control system.

     <br><dt><b>--date=</b><i>&lt;date and time&gt;</i><dd>Use the given given date and time as value of the <code>date</code> cert when
committing a new revision, rather than the current time.  Useful when
importing history from another version control system.

     <br><dt><b>--root=</b><i>&lt;root dir&gt;</i><dd>Stop the search for a working copy (containing the <span class="file">MT</span> directory)
at the specified root directory rather than at the physical root of the
filesystem.

     <br><dt><b>--xargs=</b><i>&lt;file&gt;</i><dd>Inject the contents of the file in place among the command line
arguments.  This may be useful in case the command line would otherwise
become too long for your system.  This option can be used more than once
if needed.

     <br><dt><b>-@</b> <i>&lt;file&gt;</i><dd>An alias for <b>&ndash;xargs=</b><i>&lt;file&gt;</i>.

     <!-- TROFF INPUT: .SH ENVIRONMENT -->
</dl>

<!--  -->
<p><a name="ENVIRONMENT"></a>

<h3 class="section">8.5 ENVIRONMENT</h3>

<!-- DEBUG: print_menu("ENVIRONMENT") -->
<!-- TROFF INPUT: .TP -->
<!--  -->
<dl>
<dt><b>EDITOR</b><dd>Used to edit comments, log messages, etc. 
<!-- TROFF INPUT: .TP -->

     <br><dt><b>VISUAL</b><dd>Used in preference to <b>EDITOR</b>, if set. 
<!-- TROFF INPUT: .SH FILES -->

</dl>

<!--  -->
<p><a name="FILES"></a>

<h3 class="section">8.6 FILES</h3>

<!-- DEBUG: print_menu("FILES") -->
<!-- TROFF INPUT: .TP -->
<!--  -->
<dl>
<dt><b>$HOME/.monotone/monotonerc</b><dd>A Lua script, used as a customization file. 
<!-- TROFF INPUT: .SH NOTES -->

</dl>

<!--  -->
<p><a name="NOTES"></a>

<h3 class="section">8.7 NOTES</h3>

<!-- DEBUG: print_menu("NOTES") -->
<!-- TROFF INPUT: .IP \(bu -->
<p>Command line options override environment variables and
settings in Lua scripts (such as <b>monotonerc</b>)

<!-- TROFF INPUT: .SH "SEE ALSO" -->
<p><a name="SEE-ALSO"></a>

<h3 class="section">8.8 SEE ALSO</h3>

<!-- DEBUG: print_menu("SEE ALSO") -->
<p><b>info monotone</b>
<!-- TROFF INPUT: .SH BUGS -->

<p><a name="BUGS"></a>

<h3 class="section">8.9 BUGS</h3>

<!-- DEBUG: print_menu("BUGS") -->
<p>see http://savannah.nongnu.org/bugs/?group=monotone
<!-- TROFF INPUT: .SH AUTHOR -->

<p><a name="AUTHOR"></a>

<h3 class="section">8.10 AUTHOR</h3>

<!-- DEBUG: print_menu("AUTHOR") -->
<p>graydon hoare &lt;graydon@pobox.com&gt;

<p><a name="Default-hooks"></a>

<h2 class="appendix">Appendix A Default hooks</h2>

<p>This section contains the entire source code of the standard hook file,
that is built in to the monotone executable, and read before any user
hooks files (unless <span class="option">--nostd</span> is passed).  It contains the
default values for all hooks.

<pre class="verbatim">
-- this is the standard set of lua hooks for monotone;
-- user-provided files can override it or add to it.

function temp_file()
   local tdir
   tdir = os.getenv("TMPDIR")
   if tdir == nil then tdir = os.getenv("TMP") end
   if tdir == nil then tdir = os.getenv("TEMP") end
   if tdir == nil then tdir = "/tmp" end
   return mkstemp(string.format("%s/mt.XXXXXX", tdir))
end

function execute(path, ...)   
   local pid
   local ret = -1
   pid = spawn(path, unpack(arg))
   if (pid ~= -1) then ret, pid = wait(pid) end
   return ret
end

-- Wrapper around execute to let user confirm in the case where a subprocess
-- returns immediately
-- This is needed to work around some brokenness with some merge tools
-- (e.g. on OS X)
function execute_confirm(path, ...)   
   execute(path, unpack(arg))
   print(gettext("Press enter when the subprocess has completed"))
   io.read()
   return ret
end

-- attributes are persistent metadata about files (such as execute
-- bit, ACLs, various special flags) which we want to have set and
-- re-set any time the files are modified. the attributes themselves
-- are stored in a file .mt-attrs, in the working copy (and
-- manifest). each (f,k,v) triple in an attribute file turns into a
-- call to attr_functions[k](f,v) in lua.

if (attr_init_functions == nil) then
   attr_init_functions = {}
end

attr_init_functions["execute"] = 
   function(filename)
      if (is_executable(filename)) then 
        return "true" 
      else 
        return nil 
      end 
   end

attr_init_functions["manual_merge"] = 
   function(filename)
      if (binary_file(filename)) then 
        return "true" -- binary files must merged manually
      else 
        return nil
      end 
   end

if (attr_functions == nil) then
   attr_functions = {}
end

attr_functions["execute"] = 
   function(filename, value) 
      if (value == "true") then
         make_executable(filename)
      end
   end


function ignore_file(name)
   -- project specific
   if (ignored_files == nil) then
      ignored_files = {}
      local ignfile = io.open(".mt-ignore", "r")
      if (ignfile ~= nil) then
         local line = ignfile:read()
         while (line ~= nil)
         do
            table.insert(ignored_files, line)
            line = ignfile:read()
         end
         io.close(ignfile)
      end
   end
   for i, line in pairs(ignored_files)
   do
      if (regex.search(line, name)) then return true end
   end
   -- c/c++
   if (string.find(name, "%.a$")) then return true end
   if (string.find(name, "%.so$")) then return true end
   if (string.find(name, "%.o$")) then return true end
   if (string.find(name, "%.la$")) then return true end
   if (string.find(name, "%.lo$")) then return true end
   if (string.find(name, "^core$")) then return true end
   if (string.find(name, "/core$")) then return true end
   -- python
   if (string.find(name, "%.pyc$")) then return true end
   if (string.find(name, "%.pyo$")) then return true end
   -- TeX
   if (string.find(name, "%.aux$")) then return true end
   -- backup files
   if (string.find(name, "%.bak$")) then return true end
   if (string.find(name, "%.orig$")) then return true end
   if (string.find(name, "%.rej$")) then return true end
   if (string.find(name, "%~$")) then return true end
   -- editor temp files
   -- vim creates .foo.swp files
   if (string.find(name, "%.[^/]*%.swp$")) then return true end
   -- emacs creates #foo# files
   if (string.find(name, "%#[^/]*%#$")) then return true end
   -- autotools detritus:
   if (string.find(name, "^autom4te.cache/")) then return true end
   if (string.find(name, "/autom4te.cache/")) then return true end
   if (string.find(name, "^.deps/")) then return true end
   if (string.find(name, "/.deps/")) then return true end
   -- Cons/SCons detritus:
   if (string.find(name, "^.consign$")) then return true end
   if (string.find(name, "/.consign$")) then return true end
   if (string.find(name, "^.sconsign$")) then return true end
   if (string.find(name, "/.sconsign$")) then return true end
   -- other VCSes:
   if (string.find(name, "^CVS/")) then return true end
   if (string.find(name, "/CVS/")) then return true end
   if (string.find(name, "^%.svn/")) then return true end
   if (string.find(name, "/%.svn/")) then return true end
   if (string.find(name, "^SCCS/")) then return true end
   if (string.find(name, "/SCCS/")) then return true end
   if (string.find(name, "^_darcs/")) then return true end
   if (string.find(name, "^.cdv/")) then return true end
   if (string.find(name, "^.git/")) then return true end
   if (string.find(name, "%.scc$")) then return true end
   -- desktop/directory configuration metadata
   if (string.find(name, "^.DS_Store$")) then return true end
   if (string.find(name, "/.DS_Store$")) then return true end
   if (string.find(name, "^desktop.ini$")) then return true end
   if (string.find(name, "/desktop.ini$")) then return true end
   return false;
end

-- return true means "binary", false means "text",
-- nil means "unknown, try to guess"
function binary_file(name)
   local lowname=string.lower(name)
   -- some known binaries, return true
   if (string.find(lowname, "%.gif$")) then return true end
   if (string.find(lowname, "%.jpe?g$")) then return true end
   if (string.find(lowname, "%.png$")) then return true end
   if (string.find(lowname, "%.bz2$")) then return true end
   if (string.find(lowname, "%.gz$")) then return true end
   if (string.find(lowname, "%.zip$")) then return true end
   -- some known text, return false
   if (string.find(lowname, "%.cc?$")) then return false end
   if (string.find(lowname, "%.cxx$")) then return false end
   if (string.find(lowname, "%.hh?$")) then return false end
   if (string.find(lowname, "%.hxx$")) then return false end
   if (string.find(lowname, "%.lua$")) then return false end
   if (string.find(lowname, "%.texi$")) then return false end
   if (string.find(lowname, "%.sql$")) then return false end
   -- unknown - read file and use the guess-binary 
   -- monotone built-in function
   return guess_binary_file_contents(name)
end

function edit_comment(basetext, user_log_message)
   local exe = nil
   if (program_exists_in_path("vi")) then exe = "vi" end
   if (program_exists_in_path("notepad.exe")) then exe = "notepad.exe" end
   local visual = os.getenv("VISUAL")
   if (visual ~= nil) then exe = visual end
   local editor = os.getenv("EDITOR")
   if (editor ~= nil) then exe = editor end

   if (exe == nil) then
      io.write("Could not find editor to enter commit message\n"
               .. "Try setting the environment variable EDITOR\n")
      return nil
   end

   local tmp, tname = temp_file()
   if (tmp == nil) then return nil end
   basetext = "MT: " .. string.gsub(basetext, "\n", "\nMT: ") .. "\n"
   tmp:write(user_log_message)
   tmp:write(basetext)
   io.close(tmp)

   if (execute(exe, tname) ~= 0) then
      io.write(string.format(gettext("Error running editor '%s' to enter log message\n"),
                             exe))
      os.remove(tname)
      return nil
   end

   tmp = io.open(tname, "r")
   if (tmp == nil) then os.remove(tname); return nil end
   local res = ""
   local line = tmp:read()
   while(line ~= nil) do 
      if (not string.find(line, "^MT:")) then
         res = res .. line .. "\n"
      end
      line = tmp:read()
   end
   io.close(tmp)
   os.remove(tname)
   return res
end


function non_blocking_rng_ok()
   return true
end


function persist_phrase_ok()
   return true
end

-- trust evaluation hooks

function intersection(a,b)
   local s={}
   local t={}
   for k,v in pairs(a) do s[v] = 1 end
   for k,v in pairs(b) do if s[v] ~= nil then table.insert(t,v) end end
   return t
end

function get_revision_cert_trust(signers, id, name, val)
   return true
end

function get_manifest_cert_trust(signers, id, name, val)
   return true
end

function get_file_cert_trust(signers, id, name, val)
   return true
end

function accept_testresult_change(old_results, new_results)
   local reqfile = io.open("MT/wanted-testresults", "r")
   if (reqfile == nil) then return true end
   local line = reqfile:read()
   local required = {}
   while (line ~= nil)
   do
      required[line] = true
      line = reqfile:read()
   end
   io.close(reqfile)
   for test, res in pairs(required)
   do
      if old_results[test] == true and new_results[test] ~= true
      then
         return false
      end
   end
   return true
end

-- merger support

function merge2_meld_cmd(lfile, rfile)
   return 
   function()
      return execute("meld", lfile, rfile)
   end
end

function merge3_meld_cmd(lfile, afile, rfile)
   return 
   function()
      return execute("meld", lfile, afile, rfile)
   end
end

function merge2_tortoise_cmd(lfile, rfile, outfile)
   return
   function()
      return execute("tortoisemerge",
                     string.format("/theirs:%s", lfile),
                     string.format("/mine:%s", rfile),
                     string.format("/merged:%s", outfile))
   end
end

function merge3_tortoise_cmd(lfile, afile, rfile, outfile)
   return
   function()
      return execute("tortoisemerge",
                     string.format("/base:%s", afile),
                     string.format("/theirs:%s", lfile),
                     string.format("/mine:%s", rfile),
                     string.format("/merged:%s", outfile))
   end
end

function merge2_vim_cmd(vim, lfile, rfile, outfile)
   return
   function()
      return execute(vim, "-f", "-d", "-c", string.format("file %s", outfile),
                     lfile, rfile)
   end
end

function merge3_vim_cmd(vim, afile, lfile, rfile, outfile)
   return
   function()
      return execute(vim, "-f", "-d", "-c", string.format("file %s", outfile),
                     afile, lfile, rfile)
   end
end

function merge3_rcsmerge_vim_cmd(merge, vim, lfile, afile, rfile, outfile)
   return
   function()
      -- XXX: This is tough - should we check if conflict markers stay or not?
      -- If so, we should certainly give the user some way to still force
      -- the merge to proceed since they can appear in the files (and I saw
      -- that). --pasky
      if execute(merge, lfile, afile, rfile) == 0 then
         copy_text_file(lfile, outfile);
         return 0
      end
      return execute(vim, "-f", "-c", string.format("file %s", outfile),
                     lfile)
   end
end

function merge2_emacs_cmd(emacs, lfile, rfile, outfile)
   local elisp = "(ediff-merge-files \"%s\" \"%s\" nil \"%s\")"
   return 
   function()
      return execute(emacs, "-eval", 
                     string.format(elisp, lfile, rfile, outfile))
   end
end

function merge3_emacs_cmd(emacs, lfile, afile, rfile, outfile)
   local elisp = "(ediff-merge-files-with-ancestor \"%s\" \"%s\" \"%s\" nil \"%s\")"
   local cmd_fmt = "%s -eval " .. elisp
   return 
   function()
      execute(emacs, "-eval", 
              string.format(elisp, lfile, rfile, afile, outfile))
   end
end

function merge2_xxdiff_cmd(left_path, right_path, merged_path, lfile, rfile, outfile)
   return 
   function()
      return execute("xxdiff", 
                     "--title1", left_path,
                     "--title2", right_path,
                     lfile, rfile, 
                     "--merged-filename", outfile)
   end
end

function merge3_xxdiff_cmd(left_path, anc_path, right_path, merged_path, 
                           lfile, afile, rfile, outfile)
   return 
   function()
      return execute("xxdiff", 
                     "--title1", left_path,
                     "--title2", right_path,
                     "--title3", merged_path,
                     lfile, afile, rfile, 
                     "--merge", 
                     "--merged-filename", outfile)
   end
end
   
function merge2_kdiff3_cmd(left_path, right_path, merged_path, lfile, rfile, outfile)
   return 
   function()
      return execute("kdiff3", 
                     "--L1", left_path,
                     "--L2", right_path,
                     lfile, rfile, 
                     "-o", outfile)
   end
end

function merge3_kdiff3_cmd(left_path, anc_path, right_path, merged_path, 
                           lfile, afile, rfile, outfile)
   return 
   function()
      return execute("kdiff3", 
                     "--L1", anc_path,
                     "--L2", left_path,
                     "--L3", right_path,
                     afile, lfile, rfile, 
                     "--merge", 
                     "--o", outfile)
   end
end

function merge2_opendiff_cmd(left_path, right_path, merged_path, lfile, rfile, outfile)
   return 
   function()
      -- As opendiff immediately returns, let user confirm manually
      return execute_confirm("opendiff",lfile,rfile,"-merge",outfile) 
  end
end

function merge3_opendiff_cmd(left_path, anc_path, right_path, merged_path, lfile, afile, rfile, outfile)
   return 
   function()
      -- As opendiff immediately returns, let user confirm manually
      execute_confirm("opendiff",lfile,rfile,"-ancestor",afile,"-merge",outfile)
   end
end

function write_to_temporary_file(data)
   tmp, filename = temp_file()
   if (tmp == nil) then 
      return nil 
   end;
   tmp:write(data)
   io.close(tmp)
   return filename
end

function copy_text_file(srcname, destname)
   src = io.open(srcname, "r")
   if (src == nil) then return nil end
   dest = io.open(destname, "w")
   if (dest == nil) then return nil end

   while true do
      local line = src:read()
      if line == nil then break end
      dest:write(line, "\n")
   end

   io.close(dest)
   io.close(src)
end

function read_contents_of_file(filename, mode)
   tmp = io.open(filename, mode) 
   if (tmp == nil) then
      return nil
   end
   local data = tmp:read("*a")
   io.close(tmp)
   return data
end

function program_exists_in_path(program)
   return existsonpath(program) == 0
end

function get_preferred_merge2_command (tbl)
   local cmd = nil
   local left_path = tbl.left_path
   local right_path = tbl.right_path
   local merged_path = tbl.merged_path
   local lfile = tbl.lfile
   local rfile = tbl.rfile
   local outfile = tbl.outfile 

   local editor = os.getenv("EDITOR")
   if editor ~= nil then editor = string.lower(editor) else editor = "" end

   
   if program_exists_in_path("kdiff3") then
      cmd =   merge2_kdiff3_cmd (left_path, right_path, merged_path, lfile, rfile, outfile) 
   elseif program_exists_in_path ("xxdiff") then 
      cmd = merge2_xxdiff_cmd (left_path, right_path, merged_path, lfile, rfile, outfile) 
   elseif program_exists_in_path ("opendiff") then 
      cmd = merge2_opendiff_cmd (left_path, right_path, merged_path, lfile, rfile, outfile) 
   elseif program_exists_in_path ("TortoiseMerge") then
      cmd = merge2_tortoise_cmd(lfile, rfile, outfile)
   elseif string.find(editor, "emacs") ~= nil or string.find(editor, "gnu") ~= nil then 
      if string.find(editor, "xemacs") and program_exists_in_path("xemacs") then
         cmd = merge2_emacs_cmd ("xemacs", lfile, rfile, outfile) 
      elseif program_exists_in_path("emacs") then
         cmd = merge2_emacs_cmd ("emacs", lfile, rfile, outfile) 
      end
   elseif string.find(editor, "vim") ~= nil then
      io.write (string.format("\nWARNING: 'vim' was choosen to perform external 2-way merge.\n"..
          "You should merge all changes to *LEFT* file due to limitation of program\n"..
          "arguments.\n\n")) 
      if os.getenv ("DISPLAY") ~= nil and program_exists_in_path ("gvim") then
         cmd = merge2_vim_cmd ("gvim", lfile, rfile, outfile) 
      elseif program_exists_in_path ("vim") then 
         cmd = merge2_vim_cmd ("vim", lfile, rfile, outfile) 
      end
   elseif program_exists_in_path ("meld") then 
      tbl.meld_exists = true 
      io.write (string.format("\nWARNING: 'meld' was choosen to perform external 2-way merge.\n"..
          "You should merge all changes to *LEFT* file due to limitation of program\n"..
          "arguments.\n\n")) 
      cmd = merge2_meld_cmd (lfile, rfile) 
   end 
   return cmd 
end 

function merge2 (left_path, right_path, merged_path, left, right) 
   local ret = nil 
   local tbl = {}

   tbl.lfile = nil 
   tbl.rfile = nil 
   tbl.outfile = nil 
   tbl.meld_exists = false
 
   tbl.lfile = write_to_temporary_file (left) 
   tbl.rfile = write_to_temporary_file (right) 
   tbl.outfile = write_to_temporary_file ("") 

   if tbl.lfile ~= nil and tbl.rfile ~= nil and tbl.outfile ~= nil 
   then 
      tbl.left_path = left_path 
      tbl.right_path = right_path 
      tbl.merged_path = merged_path 

      local cmd = get_preferred_merge2_command (tbl) 

      if cmd ~=nil 
      then 
         io.write (string.format(gettext("executing external 2-way merge command\n")))
         cmd ()
         if tbl.meld_exists 
         then 
            ret = read_contents_of_file (tbl.lfile, "r")
         else
            ret = read_contents_of_file (tbl.outfile, "r") 
         end 
         if string.len (ret) == 0 
         then 
            ret = nil 
         end
      else
         io.write (string.format("No external 2-way merge command found.\n"..
            "You may want to check that $EDITOR is set to an editor that supports 2-way merge,\n"..
            "set this explicitly in your get_preferred_merge2_command hook,\n"..
            "or add a 2-way merge program to your path.\n\n"))
      end
   end

   os.remove (tbl.lfile)
   os.remove (tbl.rfile)
   os.remove (tbl.outfile)
   
   return ret
end

function get_preferred_merge3_command (tbl)
   local cmd = nil
   local left_path = tbl.left_path
   local anc_path = tbl.anc_path
   local right_path = tbl.right_path
   local merged_path = tbl.merged_path
   local lfile = tbl.lfile
   local afile = tbl.afile
   local rfile = tbl.rfile
   local outfile = tbl.outfile 

   local editor = os.getenv("EDITOR")
   if editor ~= nil then editor = string.lower(editor) else editor = "" end

   local merge = os.getenv("MTMERGE")
   -- TODO: Support for rcsmerge_emacs
   if merge ~= nil and string.find(editor, "vim") ~= nil then
      if os.getenv ("DISPLAY") ~= nil and program_exists_in_path ("gvim") then 
         cmd = merge3_rcsmerge_vim_cmd (merge, "gvim", lfile, afile, rfile, outfile) 
      elseif program_exists_in_path ("vim") then 
         cmd = merge3_rcsmerge_vim_cmd (merge, "vim", lfile, afile, rfile, outfile) 
      end

   elseif program_exists_in_path("kdiff3") then
      cmd = merge3_kdiff3_cmd (left_path, anc_path, right_path, merged_path, lfile, afile, rfile, outfile) 
   elseif program_exists_in_path ("xxdiff") then 
      cmd = merge3_xxdiff_cmd (left_path, anc_path, right_path, merged_path, lfile, afile, rfile, outfile) 
   elseif program_exists_in_path ("opendiff") then 
      cmd = merge3_opendiff_cmd (left_path, anc_path, right_path, merged_path, lfile, afile, rfile, outfile) 
   elseif program_exists_in_path ("TortoiseMerge") then
      cmd = merge3_tortoise_cmd(lfile, afile, rfile, outfile)
   elseif string.find(editor, "emacs") ~= nil or string.find(editor, "gnu") ~= nil then 
      if string.find(editor, "xemacs") and program_exists_in_path ("xemacs") then 
         cmd = merge3_emacs_cmd ("xemacs", lfile, afile, rfile, outfile) 
      elseif program_exists_in_path ("emacs") then 
         cmd = merge3_emacs_cmd ("emacs", lfile, afile, rfile, outfile) 
      end
   elseif string.find(editor, "vim") ~= nil then
      io.write (string.format("\nWARNING: 'vim' was choosen to perform external 2-way merge.\n"..
          "You should merge all changes to *LEFT* file due to limitation of program\n"..
          "arguments.  The order of the files is ancestor, left, right.\n\n")) 
      if os.getenv ("DISPLAY") ~= nil and program_exists_in_path ("gvim") then 
         cmd = merge3_vim_cmd ("gvim", afile, lfile, rfile, outfile) 
      elseif program_exists_in_path ("vim") then 
         cmd = merge3_vim_cmd ("vim", afile, lfile, rfile, outfile) 
      end
   elseif program_exists_in_path ("meld") then 
      tbl.meld_exists = true 
      io.write (string.format("\nWARNING: 'meld' was choosen to perform external 3-way merge.\n"..
          "You should merge all changes to *CENTER* file due to limitation of program\n"..
          "arguments.\n\n")) 
      cmd = merge3_meld_cmd (lfile, afile, rfile) 
   end 
   
   return cmd 
end 

function merge3 (anc_path, left_path, right_path, merged_path, ancestor, left, right) 
   local ret 
   local tbl = {}
   
   tbl.anc_path = anc_path 
   tbl.left_path = left_path 
   tbl.right_path = right_path 

   tbl.merged_path = merged_path 
   tbl.afile = nil 
   tbl.lfile = nil 
   tbl.rfile = nil 
   tbl.outfile = nil 
   tbl.meld_exists = false 
   tbl.lfile = write_to_temporary_file (left) 
   tbl.afile =   write_to_temporary_file (ancestor) 
   tbl.rfile =   write_to_temporary_file (right) 
   tbl.outfile = write_to_temporary_file ("") 
   
   if tbl.lfile ~= nil and tbl.rfile ~= nil and tbl.afile ~= nil and tbl.outfile ~= nil 
   then 
      local cmd =   get_preferred_merge3_command (tbl) 
      if cmd ~=nil 
      then 
         io.write (string.format(gettext("executing external 3-way merge command\n")))
         cmd ()
         if tbl.meld_exists 
         then 
            ret = read_contents_of_file (tbl.afile, "r")
         else
            ret = read_contents_of_file (tbl.outfile, "r") 
         end 
         if string.len (ret) == 0 
         then 
            ret = nil 
         end
      else
         io.write (string.format("No external 3-way merge command found.\n"..
            "You may want to check that $EDITOR is set to an editor that supports 3-way merge,\n"..
            "set this explicitly in your get_preferred_merge3_command hook,\n"..
            "or add a 3-way merge program to your path.\n\n"))
      end
   end
   
   os.remove (tbl.lfile)
   os.remove (tbl.rfile)
   os.remove (tbl.afile)
   os.remove (tbl.outfile)
   
   return ret
end 

-- expansion of values used in selector completion

function expand_selector(str)

   -- something which looks like a generic cert pattern
   if string.find(str, "^[^=]*=.*$")
   then
      return ("c:" .. str)
   end

   -- something which looks like an email address
   if string.find(str, "[%w%-_]+@[%w%-_]+")
   then
      return ("a:" .. str)
   end

   -- something which looks like a branch name
   if string.find(str, "[%w%-]+%.[%w%-]+")
   then
      return ("b:" .. str)
   end

   -- a sequence of nothing but hex digits
   if string.find(str, "^%x+$")
   then
      return ("i:" .. str)
   end

   -- tries to expand as a date
   local dtstr = expand_date(str)
   if  dtstr ~= nil
   then
      return ("d:" .. dtstr)
   end
   
   return nil
end

-- expansion of a date expression
function expand_date(str)
   -- simple date patterns
   if string.find(str, "^19%d%d%-%d%d")
      or string.find(str, "^20%d%d%-%d%d")
   then
      return (str)
   end

   -- "now" 
   if str == "now"
   then
      local t = os.time(os.date('!*t'))
      return os.date("%FT%T", t)
   end
   
         -- today don't uses the time
   if str == "today"
   then
      local t = os.time(os.date('!*t'))
      return os.date("%F", t)
   end
   
   -- "yesterday", the source of all hangovers
   if str == "yesterday"
   then
      local t = os.time(os.date('!*t'))
      return os.date("%F", t - 86400)
   end
   
   -- "CVS style" relative dates such as "3 weeks ago"
   local trans = { 
      minute = 60; 
      hour = 3600; 
      day = 86400; 
      week = 604800; 
      month = 2678400; 
      year = 31536000 
   }
   local pos, len, n, type = string.find(str, "(%d+) ([minutehordaywk]+)s? ago")
   if trans[type] ~= nil
   then
      local t = os.time(os.date('!*t'))
      if trans[type] &lt;= 3600
      then
        return os.date("%FT%T", t - (n * trans[type]))
      else      
        return os.date("%F", t - (n * trans[type]))
      end
   end
   
   return nil
end

function use_inodeprints()
   return false
end

external_diff_default_args = "-u"

-- default external diff, works for gnu diff
function external_diff(file_path, data_old, data_new, is_binary, diff_args, rev_old, rev_new)
   local old_file = write_to_temporary_file(data_old);
   local new_file = write_to_temporary_file(data_new);

   if diff_args == nil then diff_args = external_diff_default_args end
   execute("diff", diff_args, "--label", file_path .. "\told", old_file, "--label", file_path .. "\tnew", new_file);

   os.remove (old_file);
   os.remove (new_file);
end

</pre>
<a name="Index"></a>

<h2 class="unnumbered">Index</h2>

<ul class="index-cp" compact>
<li><a href="#index-accept_005ftestresult_005fchange-_0028_0040var_007bold_005fresults_007d_002c-_0040var_007bnew_005fresults_007d_0029-140"><code>accept_testresult_change (</code><var>old_results</var><code>, </code><var>new_results</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-attr_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_002c-_0040var_007bvalue_007d_0029-150"><code>attr_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>, </code><var>value</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-attr_005finit_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_0029-151"><code>attr_init_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-edit_005fcomment-_0028_0040var_007bcommentary_007d_002c-_0040var_007buser_005flog_005fmessage_007d_0029-131"><code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_message</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-existonpath_0028_0040var_007bpossible_005fcommand_007d_0029-153"><code>existonpath(</code><var>possible_command</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-expand_005fdate-_0028_0040var_007bstr_007d_0029-146"><code>expand_date (</code><var>str</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-expand_005fselector-_0028_0040var_007bstr_007d_0029-145"><code>expand_selector (</code><var>str</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-external_005fdiff-_0028_0040var_007bfile_005fpath_007d_002c-_0040var_007bold_005fdata_007d_002c-_0040var_007bnew_005fdata_007d_002c-_0040var_007bis_005fbinary_007d_002c-152"><code>external_diff (</code><var>file_path</var><code>, </code><var>old_data</var><code>, </code><var>new_data</var><code>, </code><var>is_binary</var><code>,</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fauthor-_0028_0040var_007bbranchname_007d_0029-130"><code>get_author (</code><var>branchname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fbranch_005fkey-_0028_0040var_007bbranchname_007d_0029-128"><code>get_branch_key (</code><var>branchname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fcharset_005fconv-_0028_0040var_007bfilename_007d_0029-149"><code>get_charset_conv (</code><var>filename</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005flinesep_005fconv-_0028_0040var_007bfilename_007d_0029-148"><code>get_linesep_conv (</code><var>filename</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fnetsync_005fread_005fpermitted-_0028_0040var_007bbranch_007d_002c-_0040var_007bidentity_007d_0029-135"><code>get_netsync_read_permitted (</code><var>branch</var><code>, </code><var>identity</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fnetsync_005fwrite_005fpermitted-_0028_0040var_007bidentity_007d_0029-136"><code>get_netsync_write_permitted (</code><var>identity</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fpassphrase-_0028_0040var_007bkeypair_005fid_007d_0029-129"><code>get_passphrase (</code><var>keypair_id</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fpreferred_005fmerge2_005fcommand_0028_0040var_007btbl_007d_0029-142"><code>get_preferred_merge2_command(</code><var>tbl</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fpreferred_005fmerge3_005fcommand_0028_0040var_007btbl_007d_0029-144"><code>get_preferred_merge3_command(</code><var>tbl</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005frevision_005fcert_005ftrust-_0028_0040var_007bsigners_007d_002c-_0040var_007bid_007d_002c-_0040var_007bname_007d_002c-_0040var_007bval_007d_0029-139"><code>get_revision_cert_trust (</code><var>signers</var><code>, </code><var>id</var><code>, </code><var>name</var><code>, </code><var>val</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fsystem_005flinesep-_0028_0029-147"><code>get_system_linesep ()</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-guess_005fbinary_0028_0040var_007bfilespec_007d_0029-154"><code>guess_binary(</code><var>filespec</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-ignore_005fbranch-_0028_0040var_007bbranchname_007d_0029-138"><code>ignore_branch (</code><var>branchname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-ignore_005ffile-_0028_0040var_007bfilename_007d_0029-137"><code>ignore_file (</code><var>filename</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-include_0028_0040var_007bscriptfile_007d_0029-155"><code>include(</code><var>scriptfile</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-includedir_0028_0040var_007bscriptpath_007d_0029-156"><code>includedir(</code><var>scriptpath</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-is_005fexecutable_0028_0040var_007bfilespec_007d_0029-157"><code>is_executable(</code><var>filespec</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-kill_0028_0040var_007bpid_007d-_005b_002c-_0040var_007bsignal_007d_005d_0029-158"><code>kill(</code><var>pid</var><code> [, </code><var>signal</var><code>])</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-make_005fexecutable_0028_0040var_007bfilespec_007d_0029-159"><code>make_executable(</code><var>filespec</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-merge2-_0028_0040var_007bleft_007d_002c-_0040var_007bright_007d_0029-141"><code>merge2 (</code><var>left</var><code>, </code><var>right</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-merge3-_0028_0040var_007bancestor_007d_002c-_0040var_007bleft_007d_002c-_0040var_007bright_007d_0029-143"><code>merge3 (</code><var>ancestor</var><code>, </code><var>left</var><code>, </code><var>right</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-mkstemp_0028_0040var_007btemplate_007d_0029-160"><code>mkstemp(</code><var>template</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-monotone-_002d_002dbranch_003d_0040var_007bbranchname_007d-checkout-_0040var_007bdirectory_007d-5"><code>monotone --branch=</code><var>branchname</var><code> checkout </code><var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-_002d_002dbranch_003d_0040var_007bbranchname_007d-co-_0040var_007bdirectory_007d-6"><code>monotone --branch=</code><var>branchname</var><code> co </code><var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-add-_0040var_007bpathname_002e_002e_002e_007d-15"><code>monotone add </code><var>pathname...</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-annotate-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bfile_007d-38"><code>monotone annotate --revision=</code><var>id</var> <var>file</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-annotate-_0040var_007bfile_007d-37"><code>monotone annotate </code><var>file</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-approve-_0040var_007bid_007d-72"><code>monotone approve </code><var>id</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-monotone-automate-ancestors-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-104"><code>monotone automate ancestors </code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-ancestry_005fdifference-_0040var_007bnew_007d-_005b_0040var_007bold1_007d-_005b_0040var_007bold2_007d-_005b_002e_002e_002e_005d_005d_005d-111"><code>monotone automate ancestry_difference </code><var>new</var><code> [</code><var>old1</var><code> [</code><var>old2</var><code> [...]]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-certs-_0040var_007bid_007d-115"><code>monotone automate certs </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-children-_0040var_007brev_007d-107"><code>monotone automate children </code><var>rev</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-descendents-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-106"><code>monotone automate descendents </code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-erase_005fancestors-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-109"><code>monotone automate erase_ancestors [</code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-get_005ffile-_0040var_007bid_007d-121"><code>monotone automate get_file </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-get_005fmanifest-119"><code>monotone automate get_manifest</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-get_005fmanifest-_0040var_007bid_007d-120"><code>monotone automate get_manifest </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-get_005frevision-117"><code>monotone automate get_revision</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-get_005frevision-_0040var_007bid_007d-118"><code>monotone automate get_revision </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-graph-108"><code>monotone automate graph</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-heads-_005b_0040var_007bbranch_007d_005d-103"><code>monotone automate heads [</code><var>branch</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-interface_005fversion-102"><code>monotone automate interface_version</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-inventory-114"><code>monotone automate inventory</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-leaves-112"><code>monotone automate leaves</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-parents-_0040var_007brev_007d-105"><code>monotone automate parents </code><var>rev</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-select-_0040var_007bselector_007d-113"><code>monotone automate select </code><var>selector</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-stdio-116"><code>monotone automate stdio</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-automate-toposort-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-110"><code>monotone automate toposort [</code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-monotone-cat-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpath_007d-2"><code>monotone cat --revision=</code><var>id</var> <var>path</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-cat-_0040var_007bpath_007d-1"><code>monotone cat </code><var>path</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-69"><code>monotone cert </code><var>id</var> <var>certname</var></a>: <a href="#Key-and-Cert">Key and Cert</a></li>
<li><a href="#index-monotone-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-70"><code>monotone cert </code><var>id</var> <var>certname</var> <var>certval</var></a>: <a href="#Key-and-Cert">Key and Cert</a></li>
<li><a href="#index-monotone-certs-_0040var_007bid_007d-78"><code>monotone certs </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-checkout-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-3"><code>monotone checkout --revision=</code><var>id</var> <var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-chkeypass-_0040var_007bid_007d-68"><code>monotone chkeypass </code><var>id</var></a>: <a href="#Key-and-Cert">Key and Cert</a></li>
<li><a href="#index-monotone-co-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-4"><code>monotone co --revision=</code><var>id</var> <var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-comment-_0040var_007bid_007d-73"><code>monotone comment </code><var>id</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-monotone-comment-_0040var_007bid_007d-_0040var_007bcomment_007d-74"><code>monotone comment </code><var>id</var> <var>comment</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-monotone-commit-18"><code>monotone commit</code></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-20"><code>monotone commit --message-file=</code><var>logfile</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-_0040var_007bpathname_002e_002e_002e_007d-23"><code>monotone commit --message-file=</code><var>logfile</var> <var>pathname...</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-19"><code>monotone commit --message=</code><var>logmsg</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-_0040var_007bpathname_002e_002e_002e_007d-22"><code>monotone commit --message=</code><var>logmsg</var> <var>pathname...</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-commit-_0040var_007bpathname_002e_002e_002e_007d-21"><code>monotone commit </code><var>pathname...</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-complete-_005b_002d_002dbrief_005d-key-_0040var_007bpartial_002did_007d-40"><code>monotone complete [--brief] key </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-complete-_005b_002d_002dbrief_005d-revision-_0040var_007bpartial_002did_007d-42"><code>monotone complete [--brief] revision </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-complete-file-_0040var_007bpartial_002did_007d-39"><code>monotone complete file </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-complete-manifest-_0040var_007bpartial_002did_007d-41"><code>monotone complete manifest </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-cvs_005fimport-_0040var_007bpathname_007d-123"><code>monotone cvs_import </code><var>pathname</var></a>: <a href="#RCS">RCS</a></li>
<li><a href="#index-monotone-db-check-_002d_002ddb_003d_0040var_007bdbfile_007d-97"><code>monotone db check --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-dump-_002d_002ddb_003d_0040var_007bdbfile_007d-94"><code>monotone db dump --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-execute-_0040var_007bsql_002dstatement_007d-101"><code>monotone db execute </code><var>sql-statement</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-info-_002d_002ddb_003d_0040var_007bdbfile_007d-92"><code>monotone db info --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-init-_002d_002ddb_003d_0040var_007bdbfile_007d-90"><code>monotone db init --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-kill_005fbranch_005fcerts_005flocally-_0040var_007bbranch_007d-99"><code>monotone db kill_branch_certs_locally </code><var>branch</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-kill_005frev_005flocally-_0040var_007bid_007d-98"><code>monotone db kill_rev_locally </code><var>id</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-kill_005ftag_005flocally-_0040var_007btag_007d-100"><code>monotone db kill_tag_locally </code><var>tag</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-load-_002d_002ddb_003d_0040var_007bdbfile_007d-95"><code>monotone db load --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-migrate-_002d_002ddb_003d_0040var_007bdbfile_007d-96"><code>monotone db migrate --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-rebuild-_002d_002ddb_003d_0040var_007bdbfile_007d-91"><code>monotone db rebuild --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-db-version-_002d_002ddb_003d_0040var_007bdbfile_007d-93"><code>monotone db version --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-diff-43"><code>monotone diff</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_002d_002dcontext-44"><code>monotone diff --context</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_002d_002dexternal-_005b_002d_002ddiff_002dargs_003d_0040var_007bargstring_007d_005d-45"><code>monotone diff --external [--diff-args=</code><var>argstring</var><code>]</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_002d_002drevision_003d_0040var_007bid_007d-47"><code>monotone diff --revision=</code><var>id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpathname_002e_002e_002e_007d-48"><code>monotone diff --revision=</code><var>id</var> <var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-49"><code>monotone diff --revision=</code><var>id1</var><code> --revision=</code><var>id2</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-_0040var_007bpathname_002e_002e_002e_007d-50"><code>monotone diff --revision=</code><var>id1</var><code> --revision=</code><var>id2</var> <var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-diff-_0040var_007bpathname_002e_002e_002e_007d-46"><code>monotone diff </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-disapprove-_0040var_007bid_007d-7"><code>monotone disapprove </code><var>id</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-drop-_0040var_007bpathname_002e_002e_002e_007d-16"><code>monotone drop </code><var>pathname...</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-dropkey-_0040var_007bkeyid_007d-67"><code>monotone dropkey </code><var>keyid</var></a>: <a href="#Key-and-Cert">Key and Cert</a></li>
<li><a href="#index-monotone-explicit_005fmerge-_0040var_007bid_007d-_0040var_007bid_007d-_0040var_007bancestor_007d-_0040var_007bdestbranch_007d-14"><code>monotone explicit_merge </code><var>id</var> <var>id</var> <var>ancestor</var> <var>destbranch</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-explicit_005fmerge-_0040var_007bid_007d-_0040var_007bid_007d-_0040var_007bdestbranch_007d-13"><code>monotone explicit_merge </code><var>id</var> <var>id</var> <var>destbranch</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-fdata-_0040var_007bid_007d-79"><code>monotone fdata </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-fdelta-_0040var_007bid1_007d-_0040var_007bid2_007d-82"><code>monotone fdelta </code><var>id1</var> <var>id2</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-genkey-_0040var_007bkeyid_007d-66"><code>monotone genkey </code><var>keyid</var></a>: <a href="#Key-and-Cert">Key and Cert</a></li>
<li><a href="#index-monotone-heads-_002d_002dbranch_003d_0040var_007bbranchname_007d-8"><code>monotone heads --branch=</code><var>branchname</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-list-branches-54"><code>monotone list branches</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-certs-_0040var_007bid_007d-51"><code>monotone list certs </code><var>id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-ignored-62"><code>monotone list ignored</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-ignored-_0040var_007bpathname_002e_002e_002e_007d-63"><code>monotone list ignored </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-keys-52"><code>monotone list keys</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-keys-_0040var_007bpattern_007d-53"><code>monotone list keys </code><var>pattern</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-known-58"><code>monotone list known</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-known-_0040var_007bpathname_002e_002e_002e_007d-59"><code>monotone list known </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-missing-64"><code>monotone list missing</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-missing-_0040var_007bpathname_002e_002e_002e_007d-65"><code>monotone list missing </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-tags-55"><code>monotone list tags</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-unknown-60"><code>monotone list unknown</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-unknown-_0040var_007bpathname_002e_002e_002e_007d-61"><code>monotone list unknown </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-vars-56"><code>monotone list vars</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-list-vars-_0040var_007bdomain_007d-57"><code>monotone list vars </code><var>domain</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-log-35"><code>monotone log</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-log-_005b_002d_002dlast_003d_0040var_007bn_007d_005d-_005b_002d_002drevision_003d_0040var_007bid_007d-_005b_002e_002e_002e_005d_005d-_005b_002d_002dbrief_005d-_005b_0040var_007bfile_007d-_005b_002e_002e_002e_005d_005d-36"><code>monotone log [--last=</code><var>n</var><code>] [--revision=</code><var>id</var><code> [...]] [--brief] [</code><var>file</var><code> [...]]</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-mdata-_0040var_007bid_007d-80"><code>monotone mdata </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-mdelta-_0040var_007bid1_007d-_0040var_007bid2_007d-83"><code>monotone mdelta </code><var>id1</var> <var>id2</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-merge-_002d_002dlca-_005b_002d_002dbranch_003d_0040var_007bbranchname_007d_005d-10"><code>monotone merge --lca [--branch=</code><var>branchname</var><code>]</code></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-merge-_005b_002d_002dbranch_003d_0040var_007bbranchname_007d_005d-9"><code>monotone merge [--branch=</code><var>branchname</var><code>]</code></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-privkey-_0040var_007bkeyid_007d-84"><code>monotone privkey </code><var>keyid</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-propagate-_002d_002dlca-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-12"><code>monotone propagate --lca </code><var>sourcebranch</var> <var>destbranch</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-propagate-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-11"><code>monotone propagate </code><var>sourcebranch</var> <var>destbranch</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-monotone-pubkey-_0040var_007bkeyid_007d-85"><code>monotone pubkey </code><var>keyid</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-pull-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-30"><code>monotone pull [--set-default] [</code><var>address</var><code>[:</code><var>port</var><code>] [</code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-monotone-push-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-31"><code>monotone push [--set-default] [</code><var>address</var><code>[:</code><var>port</var><code>] [</code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-monotone-rcs_005fimport-_0040var_007bfilename_002e_002e_002e_007d-122"><code>monotone rcs_import </code><var>filename...</var></a>: <a href="#RCS">RCS</a></li>
<li><a href="#index-monotone-rdata-_0040var_007bid_007d-81"><code>monotone rdata </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-read-86"><code>monotone read</code></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-read-_0040var_007bfile1_007d-_0040var_007bfile2_002e_002e_002e_007d-87"><code>monotone read </code><var>file1</var> <var>file2...</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-monotone-refresh_005finodeprints-28"><code>monotone refresh_inodeprints</code></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-rename-_0040var_007bsrc_007d-_0040var_007bdst_007d-17"><code>monotone rename </code><var>src</var> <var>dst</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-revert-24"><code>monotone revert</code></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-revert-_0040var_007bpathname_002e_002e_002e_007d-25"><code>monotone revert </code><var>pathname...</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-serve-_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d-29"><code>monotone serve </code><var>address</var><code>[:</code><var>port</var><code>] </code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-monotone-set-_0040var_007bdomain_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-88"><code>monotone set </code><var>domain</var> <var>name</var> <var>value</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-status-33"><code>monotone status</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-status-_0040var_007bpathname_002e_002e_002e_007d-34"><code>monotone status </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-monotone-sync-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007baddress_007d_005b_003a_0040var_007bport_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-32"><code>monotone sync [--set-default] [</code><var>address</var><code>[:</code><var>port</var><code>] [</code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-monotone-tag-_0040var_007bid_007d-_0040var_007btagname_007d-75"><code>monotone tag </code><var>id</var> <var>tagname</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-monotone-testresult-_0040var_007bid_007d-0-76"><code>monotone testresult </code><var>id</var><code> 0</code></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-monotone-testresult-_0040var_007bid_007d-1-77"><code>monotone testresult </code><var>id</var><code> 1</code></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-monotone-trusted-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-_0040var_007bsigners_007d-71"><code>monotone trusted </code><var>id</var> <var>certname</var> <var>certval</var> <var>signers</var></a>: <a href="#Key-and-Cert">Key and Cert</a></li>
<li><a href="#index-monotone-unset-_0040var_007bdomain_007d-_0040var_007bname_007d-89"><code>monotone unset </code><var>domain</var> <var>name</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-monotone-update-26"><code>monotone update</code></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-monotone-update-_002d_002drevision_003d_0040var_007brevision_007d-27"><code>monotone update --revision=</code><var>revision</var></a>: <a href="#Working-Copy">Working Copy</a></li>
<li><a href="#index-non_005fblocking_005frng_005fok-_0028_0029-133"><code>non_blocking_rng_ok ()</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fcommit-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-124"><code>note_commit (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005fcert_005freceived-_0028_0040var_007brev_005fid_007d_002c-_0040var_007bkey_007d_002c-126"><code>note_netsync_cert_received (</code><var>rev_id</var><code>, </code><var>key</var><code>,</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005fpubkey_005freceived-_0028_0040var_007bkeyname_007d_0029-127"><code>note_netsync_pubkey_received (</code><var>keyname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005frevision_005freceived-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-125"><code>note_netsync_revision_received (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-persist_005fphrase_005fok-_0028_0029-132"><code>persist_phrase_ok ()</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-sleep_0028_0040var_007bseconds_007d_0029-161"><code>sleep(</code><var>seconds</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-spawn_0028_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-162"><code>spawn(</code><var>executable</var><code> [, </code><var>args ...</var><code>])</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-use_005finodeprints-_0028_0029-134"><code>use_inodeprints ()</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-wait_0028_0040var_007bpid_007d_0029-163"><code>wait(</code><var>pid</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
   </ul><div class="footnote">
<hr>
<a name="texinfo-footnotes-in-document"></a><h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> We
say <span class="sc">sha1</span> values are &ldquo;unique&rdquo; here, when in fact there is a
small probability of two different versions having the same <span class="sc">sha1</span>
value. This probability is very small, so we discount it.</p>

   <p class="footnote"><small>[<a name="fn-2" href="#fnd-2">2</a>]</small> Regardless of who originally
signed the certs, after the rebuild they will be signed by you.  This
means you should be somewhat careful when rebuilding, but it is
unavoidable &mdash; if you could sign with other people's keys, that would
be a rather serious security problem!</p>

   <p><hr></div>

</body></html>

