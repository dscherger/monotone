<html lang="en">
<head><link type="text/css" rel="stylesheet" href="texinfo.css" />
<title>Hooks - monotone documentation</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="monotone documentation">
<meta name="generator" content="makeinfo 4.11">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Hook-Reference.html#Hook-Reference" title="Hook Reference">
<link rel="prev" href="Hook-Reference.html#Hook-Reference" title="Hook Reference">
<link rel="next" href="Additional-Lua-Functions.html#Additional-Lua-Functions" title="Additional Lua Functions">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="Hooks"></a>
Next:&nbsp;<a rel="next" accesskey="n" href="Additional-Lua-Functions.html#Additional-Lua-Functions">Additional Lua Functions</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Hook-Reference.html#Hook-Reference">Hook Reference</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Hook-Reference.html#Hook-Reference">Hook Reference</a>
<hr>
</div>

<h3 class="section">6.1 Hooks</h3>

<p>This section documents the existing hook functions and their default
definitions.

<h4 class="subsection">6.1.1 Event Notifications and Triggers</h4>

<p>There are a number of hooks that are called when noteworthy events
occur, such as commits or new revisions arriving over the network. These
hooks can be used to feed the events into external notification systems,
such as generating email.

   <p>By default, these hooks are undefined, so no special external actions
are taken.

     <dl>
<dt><code>note_commit (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code><a name="index-note_005fcommit-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-187"></a><dd>
Called by monotone after the version <var>new_id</var> is committed. The
second parameter, <var>revision</var> is the text of the revision, what would
be given by <samp><span class="command">mtn automate get_revision </span><var>new_id</var></samp>. The third
parameter, <var>certs</var>, is a Lua table containing the set of certificate
names and values committed along with this version. There is no default
definition for this hook.

     <p>Note that since the <var>certs</var> table does not contain cryptographic
or trust information, and only contains one entry per cert name, it is
an incomplete source of information about the committed version. This
hook is only intended as an aid for integrating monotone with informal
commit-notification systems such as mailing lists or news services. It
should not perform any security-critical operations.

     <br><dt><code>note_netsync_start (</code><var>session_id</var><code>, </code><var>my_role</var><code>, </code><var>sync_type</var><code>,</code><a name="index-note_005fnetsync_005fstart-_0028_0040var_007bsession_005fid_007d_002c-_0040var_007bmy_005frole_007d_002c-_0040var_007bsync_005ftype_007d_002c-188"></a><dd><var>remote_host</var>, <var>remote_keyname</var>, <var>includes</var>, <var>excludes</var>)

     <p>Called by monotone before any other of the netsync notification hooks
are called.  The <var>session_id</var> helps keep track of the current netsync
session in case several are happening at the same time, and is used
throughout all netsync notification hooks.

     <p>The other arguments are:

          <dl>
<dt><var>my_role</var><dd>
This will be either "client" or "server".

          <br><dt><var>sync_type</var><dd>
This will be one of "sync", "push", or "pull".

          <br><dt><var>remote_host</var><dd>
The network address of the remote host. At the client, this will be the name
it was told to connect to; at the server, this will use the numerical IP address
the connection was received from.

          <br><dt><var>remote_keyname</var><dd>
The name of the key being used by the other end of the connection. This may be
set to "-unknown-" at the server if the key used by the client is not present
at the server.

          <br><dt><var>includes</var><strong> and </strong><var>excludes</var><dd>
The include and exclude patterns used by the client.

     </dl>

     <br><dt><code>note_netsync_revision_received (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>, </code><var>session_id</var><code>)</code><a name="index-note_005fnetsync_005frevision_005freceived-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_002c-_0040var_007bsession_005fid_007d_0029-189"></a><dd>
Called by monotone after the revision <var>new_id</var> is received through
netsync. <var>revision</var> is the text of the revision, what would be given
by <samp><span class="command">mtn automate get_revision </span><var>new_id</var></samp>. <var>certs</var> is a
Lua table containing one subtable for each cert attached to the revision
<var>new_id</var>. These subtables have fields named "key", "name", and
"value", containing the signing key for the cert, the name of the cert,
and the value of the cert. There is no default definition for this hook. 
<var>session_id</var> is used together with <code>note_netsync_start</code> and
<code>note_netsync_end</code>.  If you're not interested in that type of
tracking, you can ignore that variable entirely.

     <br><dt><code>note_netsync_cert_received (</code><var>rev_id</var><code>, </code><var>key</var><code>, </code><var>name</var><code>, </code><var>value</var><code>, </code><var>session_id</var><code>)</code><a name="index-note_005fnetsync_005fcert_005freceived-_0028_0040var_007brev_005fid_007d_002c-_0040var_007bkey_007d_002c-_0040var_007bname_007d_002c-_0040var_007bvalue_007d_002c-_0040var_007bsession_005fid_007d_0029-190"></a><dd>
Called by monotone after a cert is received through netsync, if the revision
that the cert is attached to was not also received in the same netsync
operation. <var>rev_id</var> is the revision id that the cert is attached to,
<var>key</var> is the key that the cert is signed with, <var>name</var> is the name
of the cert, and <var>value</var> is the cert value. There is no default
definition for this hook. 
<var>session_id</var> is used together with <code>note_netsync_start</code> and
<code>note_netsync_end</code>.  If you're not interested in that type of
tracking, you can ignore that variable entirely.

     <br><dt><code>note_netsync_pubkey_received (</code><var>keyname</var><code>, </code><var>session_id</var><code>)</code><a name="index-note_005fnetsync_005fpubkey_005freceived-_0028_0040var_007bkeyname_007d_002c-_0040var_007bsession_005fid_007d_0029-191"></a><dd>
Called by monotone after a pubkey is received through netsync. <var>keyname</var>
is the name of the key received. There is no default definition for this hook. 
<var>session_id</var> is used together with <code>note_netsync_start</code> and
<code>note_netsync_end</code>.  If you're not interested in that type of
tracking, you can ignore that variable entirely.

     <br><dt><code>note_netsync_end (</code><var>session_id</var><code>, </code><var>status</var><code>,</code><a name="index-note_005fnetsync_005fend-_0028_0040var_007bsession_005fid_007d_002c-_0040var_007bstatus_007d_002c-192"></a><dd><var>bytes_in</var>, <var>bytes_out</var>, <var>certs_in</var>, <var>certs_out</var>,
<var>revs_in</var>, <var>revs_out</var>, <var>keys_in</var>, <var>keys_out</var>)

     <p>Called by monotone after all other the netsync notification hooks have
been called.  This hook would usually be used for post-netsync purposes,
like collecting all the data from all other netsync notification hooks,
make some nice output from them and finally send the result somewhere. 
It could also be used to prepare parallel databases with all the data
to be displayed through something like viewmtn.

     <p><var>status</var> is a three digit integer that tells whether there was an error,
and if so what kind of error it was:

          <dl>
<dt><strong>200</strong><dd>
No error, connection successful.

          <br><dt><strong>211</strong><dd>
The connection was interrupted after some data may have been transferred.

          <br><dt><strong>212</strong><dd>
The connection was interrupted before any data could be transferred.

          <br><dt><strong>412</strong><dd>
The request is not permitted.

          <br><dt><strong>422</strong><dd>
The client tried to use a key that the server doesn't know about.

          <br><dt><strong>432</strong><dd>
The client and server have different epochs for a branch.

          <br><dt><strong>512</strong><dd>
Protocol error (source/sink confusion).

          <br><dt><strong>521</strong><dd>
Protocol error (packet received at a time when it doesn't make sense).

          <br><dt><strong>532</strong><dd>
The client did not identify itself correctly. (Possible replay attack?)

     </dl>

     <p>In general, 2xx means there was no error, 4xx means there was a permissions
error, and 5xx means there was a protocol error. xx1 means some data may
have been transferred, xx2 means no data was transferred, and xx0 means all
data was transferred.

     <br><dt><code>note_mtn_startup (...)</code><a name="index-note_005fmtn_005fstartup-_0028_002e_002e_002e_0029-193"></a><dd>
Called by monotone when it is first started, this hook was added so that
usage of monotone could be monitored for user interface testing.  Note
that by default, no monitoring occurs.  The arguments to the hook
function are the arguments to monotone, without the initial
<samp><span class="command">mtn</span></samp> command.  They can be accessed through the lua <var>arg</var>
variable as in this example:

     <pre class="smallexample">          function note_mtn_startup(...)
              print("Beginning note_mtn_startup")
              for i = 1,arg.n do
                  print(arg[i])
              end
              print("Ending note_mtn_startup")
          end
</pre>
     </dl>

<h4 class="subsection">6.1.2 User Defaults</h4>

<p>These are hooks that can be used to provide smart, context-sensitive
default values for a number of parameters the user might otherwise be
prompted for.

     <dl>
<dt><code>get_branch_key (</code><var>branchname</var><code>)</code><a name="index-get_005fbranch_005fkey-_0028_0040var_007bbranchname_007d_0029-194"></a><dd>
Returns a string which is the name of an <span class="sc">rsa</span> private key used to sign
certificates in a particular branch <var>branchname</var>. There is no
default definition for this hook. The command-line option
<samp><span class="option">--key=</span><var>keyname</var></samp> overrides any value returned from this
hook function. If you have only one private key in your database, you
do not need to define this function or provide a
<samp><span class="option">--key=</span><var>keyname</var></samp> option; monotone will guess that you want
to use the unique private key.

     <br><dt><code>get_netsync_key(</code><var>server</var><code>, </code><var>include</var><code>, </code><var>exclude</var><code>)</code><a name="index-get_005fnetsync_005fkey_0028_0040var_007bserver_007d_002c-_0040var_007binclude_007d_002c-_0040var_007bexclude_007d_0029-195"></a><dd>
Returns a string which is the name of the key to use to authenticate
the given netsync connection. When called by the <samp><span class="command">serve</span></samp> command,
<var>server</var> is the address monotone is listening on, <var>include</var> is
<samp><span class="option">"*"</span></samp>, and <var>exclude</var> is <samp><span class="option">""</span></samp>.

     <p>There is no default definition of this hook. The command-line option
<samp><span class="option">--key=</span><var>keyname</var></samp> overrides any value returned from this
hook function.

     <br><dt><code>get_passphrase (</code><var>keypair_id</var><code>)</code><a name="index-get_005fpassphrase-_0028_0040var_007bkeypair_005fid_007d_0029-196"></a><dd>
Returns a string which is the passphrase used to encrypt the private
half of <var>keypair_id</var> in your database, using the <span class="sc">arc4</span> symmetric
cipher.  <var>keypair_id</var> is a Lua string containing the label that you
used when you created your key &mdash; something like
<code>"nicole@example.com"</code>.  This hook has no default definition. If
this hook is not defined or returns false, monotone will prompt you for
a passphrase each time it needs to use a private key.

     <br><dt><code>get_author (</code><var>branchname</var><code>, </code><var>keypair_id</var><code>)</code><a name="index-get_005fauthor-_0028_0040var_007bbranchname_007d_002c-_0040var_007bkeypair_005fid_007d_0029-197"></a><dd>
Returns a string which is used as a value for automatically generated
<code>author</code> certificates when you commit changes to
<var>branchname</var> with the keypair identity <var>keypair_id</var>.  Generally
this hook remains undefined, and monotone selects your signing key name
for the author certificate. You can use this hook to override that
choice, if you like.

     <p>This hook has no default definition, but a couple of possible
definitions might be:
     <pre class="smallexample">          function get_author(branchname, keypair_id)
                  -- Key pair identity ignored.
                  local user = os.getenv("USER")
                  local host = os.getenv("HOSTNAME")
                  if ((user == nil) or (host == nil)) then return nil end
                  return string.format("%s@%s", user, host)
          end
</pre>
     <pre class="smallexample">          function get_author(branchname, keypair_id)
                  -- Branch name ignored.
                  if (keypair_id == "joe@example.com") then
                          return "Joe Random &lt;joe@example.com&gt;"
                  end
                  return keypair_id
          end
</pre>
     <br><dt><code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_message</var><code>)</code><a name="index-edit_005fcomment-_0028_0040var_007bcommentary_007d_002c-_0040var_007buser_005flog_005fmessage_007d_0029-198"></a><dd>
Returns a log entry for a given set of changes, described in
<var>commentary</var>.  The commentary is identical to the output of
<samp><span class="command">mtn status</span></samp>. This hook is intended to interface with
some sort of editor, so that you can interactively document each
change you make. The result is used as the value for a
<code>changelog</code> certificate, automatically generated when you commit
changes.

     <p>The contents of <samp><span class="file">_MTN/log</span></samp> are read and passed as
<var>user_log_message</var>. This allows you to document your changes as
you proceed instead of waiting until you are ready to commit. Upon
a successful commit, the contents of <samp><span class="file">_MTN/log</span></samp> are erased setting
the system up for another edit/commit cycle.

     <p>For the default definition of this hook, see <a href="Default-hooks.html#Default-hooks">Default hooks</a>.

     <br><dt><code>persist_phrase_ok ()</code><a name="index-persist_005fphrase_005fok-_0028_0029-199"></a><dd>
Returns <code>true</code> if you want monotone to remember the passphrase of
a private key for the duration of a single command, or <code>false</code> if
you want monotone to prompt you for a passphrase for each certificate
it generates. Since monotone often generates several certificates in
quick succession, unless you are very concerned about security you
probably want this hook to return <code>true</code>.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function persist_phrase_ok()
                  return true
          end
</pre>
     <br><dt><code>use_inodeprints ()</code><a name="index-use_005finodeprints-_0028_0029-200"></a><dd>
Returns <code>true</code> if you want monotone to automatically enable
<a href="Inodeprints.html#Inodeprints">Inodeprints</a> support in all workspaces.  Only affects working
copies created after you modify the hook.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function use_inodeprints()
                  return false
          end
</pre>
     <br><dt><code>ignore_file (</code><var>filename</var><code>)</code><a name="index-ignore_005ffile-_0028_0040var_007bfilename_007d_0029-201"></a><dd>
Returns <code>true</code> if <var>filename</var> should be ignored while adding,
dropping, or moving files. Otherwise returns <code>false</code>. This is
most important when performing recursive actions on directories, which
may affect multiple files simultaneously.

     <p>The default definition of this hook recognises a number of common file
types and extensions for temporary and generated file types that users
typically don't want to track. If the file <samp><span class="file">.mtn-ignore</span></samp> exists,
this hook will read a list of regular expressions from the file, one per
line, and ignore all files matching one of these expressions. For the
default definition of this hook, see <a href="Default-hooks.html#Default-hooks">Default hooks</a>.

     <br><dt><code>ignore_branch (</code><var>branchname</var><code>)</code><a name="index-ignore_005fbranch-_0028_0040var_007bbranchname_007d_0029-202"></a><dd>
Returns <code>true</code> if <var>branchname</var> should be ignored while listing
branches. Otherwise returns <code>false</code>. This hook has no default
definition, therefore the default behavior is to list all branches.

   </dl>

<h4 class="subsection">6.1.3 Netsync Permission Hooks</h4>

<p>These hooks are used when running a netsync server, via
<samp><span class="command">mtn serve</span></samp>. They are evaluated by the server for each new
connection, based on the certificate used for authentication by the
client.  Note that a long-running server will need to be restarted in
order to reload the hook definitions if the <samp><span class="file">montonerc</span></samp> file is
changed.

     <dl>
<dt><code>get_netsync_read_permitted (</code><var>branch</var><code>, </code><var>identity</var><code>)</code><a name="index-get_005fnetsync_005fread_005fpermitted-_0028_0040var_007bbranch_007d_002c-_0040var_007bidentity_007d_0029-203"></a><dd>
Returns <code>true</code> if a peer authenticated as key <var>identity</var>
should be allowed to read from your database certs, revisions,
manifests, and files associated with <var>branch</var>; otherwise <code>false</code>. 
The default definition of this hook reads a file <samp><span class="file">read-permissions</span></samp> in
the configuration directory. This file looks like
     <pre class="smallexample">          pattern "net.example.project.{private,security}*"
          allow "joe@example.net"
          allow "jim@example.net"
          
          comment "everyone can read these branches"
          pattern "net.example.{public,project}*"
          allow "*"
</pre>
     <p>This example allows everyone access to branches <code>net.example.project</code> and
<code>net.example.public</code> and their sub-branches, except for the branches in
<code>net.example.project.security</code> and <code>net.example.project.private</code>,
which are only readable by Joe and Jim.

     <p>The file is divided into stanzas of one <code>pattern</code> line followed by any
number of <code>allow</code> and <code>deny</code> lines, and possibly a <code>continue</code>
line. Anything from the unquoted word <code>comment</code> until the next unquoted
word is ignored. A stanza is processed if the argument to
<code>pattern</code> is a glob that matches <var>branch</var>. Any keys which match an
<code>allow</code> line are given access, and any keys which match a <code>deny</code> line
are denied access. If there is a <code>continue "true"</code> line, then if the key
is not granted or denied access in this stanza the next matching stanza will be
processed. If there is not a <code>continue "true"</code> line, then any key which
has not been given access will be denied access even if it doesn't match any
<code>deny</code> lines. Thus, deny lines are redundant unless there is also a
<code>continue "true"</code> line.

     <p>If a client connects anonymously, this hook will be called with a
<var>identity</var> of <code>nil</code>.

     <p>Note that the <var>identity</var> value is a key ID (such as
&ldquo;<code>graydon@pobox.com</code>&rdquo;) but will correspond to a <em>unique</em>
key fingerprint (hash) in your database. Monotone will not permit two
keys in your database to have the same ID. Make sure you confirm the
key fingerprints of each key in your database, as key ID strings are
&ldquo;convenience names&rdquo;, not security tokens.

     <br><dt><code>get_netsync_write_permitted (</code><var>identity</var><code>)</code><a name="index-get_005fnetsync_005fwrite_005fpermitted-_0028_0040var_007bidentity_007d_0029-204"></a><dd>
Returns <code>true</code> if a peer authenticated as key <var>identity</var> should
be allowed to write into your database certs, revisions, manifests, and
files; otherwise <code>false</code>. The default definition of this hook reads a file
<samp><span class="file">write-permissions</span></samp> in the configuration directory which contains a list
of keys, one per line, which are allowed write access. The special value
<code>*</code> means to allow access to anyone whose public key we already have.

     <p>If a client connects anonymously, it will be unconditionally denied
write access; this hook will <em>not</em> be called with a <var>identity</var>
of <code>nil</code>.

     <p>Note that the <var>identity</var> value is a key ID (such as
&ldquo;<code>graydon@pobox.com</code>&rdquo;) but will correspond to a <em>unique</em>
key fingerprint (hash) in your database. Monotone will not permit two
keys in your database to have the same ID. Make sure you confirm the
key fingerprints of each key in your database, as key ID strings are
&ldquo;convenience names&rdquo;, not security tokens.

     <p>Note also that, unlike the equivalent read permission hook, the write
permission hook does not take a <var>branch</var> name as an argument.  There
is presently no way to selectively grant write access to different
branches via netsync, for a number of reasons. Contributions in the
database from different authors can be selectively trusted using the
<a href="Trust-Evaluation-Hooks.html#Trust-Evaluation-Hooks">Trust Evaluation Hooks</a> instead.

   </dl>

   <p><a name="Netsync-Transport-Hooks"></a>

<h4 class="subsection">6.1.4 Netsync Transport Hooks</h4>

<p>When a monotone client initiates a netsync connection, these hooks are
called to attempt to parse the host argument provided on the command
line. If the hooks fail or return nil, monotone will interpret the
host argument as a network name (possibly with a port number) and open
a TCP socket.

     <dl>
<dt><code>get_netsync_connect_command (</code><var>uri</var><code>, </code><var>args</var><code>)</code><a name="index-get_005fnetsync_005fconnect_005fcommand-_0028_0040var_007buri_007d_002c-_0040var_007bargs_007d_0029-205"></a><dd>
Returns a table describing a command to run to connect to the
specified host. The <var>uri</var> argument is a table containing
between 0 and 7 components:

          <ul>
<li><code>uri["scheme"]</code>, such as <code>"ssh"</code> or <code>"file"</code>
<li><code>uri["user"]</code>, the name of a remote user
<li><code>uri["host"]</code>, the name or address of a remote host
<li><code>uri["port"]</code>, a network port number
<li><code>uri["path"]</code>, a filesystem path
<li><code>uri["query"]</code>, for additional parameters
<li><code>uri["fragment"]</code>, to describe a sub-location within the remote resource
</ul>

     <p>The <var>args</var> argument is a table containing between 0 and 3
components:

          <ul>
<li><code>args["include"]</code>, the branch pattern to include
<li><code>args["exclude"]</code>, the branch pattern to exclude
<li><code>args["debug"]</code>, whether to run the connection in debug mode
</ul>

     <p>The default definition of this hook follows:

     <pre class="smallexample">          function get_netsync_connect_command(uri, args)
          
                  local argv = nil
          
                  if uri["scheme"] == "ssh"
                          and uri["host"]
                          and uri["path"] then
          
                          argv = { "ssh" }
                          if uri["user"] then
                                  table.insert(argv, "-l")
                                  table.insert(argv, uri["user"])
                          end
                          if uri["port"] then
                                  table.insert(argv, "-p")
                                  table.insert(argv, uri["port"])
                          end
          
                          table.insert(argv, uri["host"])
                  end
          
                  if uri["scheme"] == "file" and uri["path"] then
                          argv = { }
                  end
          
                  if argv then
          
                          table.insert(argv, get_mtn_command(uri["host"]))
          
                          if args["debug"] then
                                  table.insert(argv, "--debug")
                          else
                                  table.insert(argv, "--quiet")
                          end
          
                          table.insert(argv, "--db")
                          table.insert(argv, uri["path"])
                          table.insert(argv, "serve")
                          table.insert(argv, "--stdio")
                          table.insert(argv, "--no-transport-auth")
          
                          if args["include"] then
                                  table.insert(argv, args["include"])
                          end
          
                          if args["exclude"] then
                                  table.insert(argv, "--exclude")
                                  table.insert(argv, args["exclude"])
                          end
                  end
                  return argv
          end
</pre>
     <br><dt><code>use_transport_auth (</code><var>uri</var><code>)</code><a name="index-use_005ftransport_005fauth-_0028_0040var_007buri_007d_0029-206"></a><dd>
Returns a boolean indicating whether monotone should use transport
authentication mechanisms when communicating with <var>uri</var>. If this
hook fails, the return value is assumed to be <code>true</code>. The form of
the <var>uri</var> argument is a table, identical to the table provided as
an argument to <code>get_netsync_connect_command</code>.

     <p>Note that the return value of this hook must "match" the semantics of
the command returned by <code>get_netsync_connect_command</code>. In
particular, if this hook returns <code>false</code>, the <samp><span class="command">serve</span></samp>
command line arguments passed to the remote end of the connection
should include the <samp><span class="option">--no-transport-auth</span></samp> option. A mismatch
between this hook's return value and the command line returned by
<code>get_netsync_connect_command</code> will cause a communication failure,
as the local and remote monotone processes will have mismatched
authentication assumptions.

     <pre class="smallexample">          function use_transport_auth(uri)
                  if uri["scheme"] == "ssh"
                  or uri["scheme"] == "file" then
                          return false
                  else
                          return true
                  end
          end
</pre>
     <br><dt><code>get_mtn_command(</code><var>host</var><code>)</code><a name="index-get_005fmtn_005fcommand_0028_0040var_007bhost_007d_0029-207"></a><dd>
Returns a string containing the monotone command to be executed on
<var>host</var> when communicating over <samp><span class="command">ssh</span></samp>.  The <var>host</var>
argument is a string containing the name of the host to which
<samp><span class="command">ssh</span></samp> is connecting, from the server URI.  This is useful when
there are multiple monotone binaries on the remote host, or the
monotone binary is not in the default path.

     <pre class="smallexample">          function get_mtn_command(host)
              return "mtn"
          end
</pre>
     </dl>

   <p><a name="Trust-Evaluation-Hooks"></a>

<h4 class="subsection">6.1.5 Trust Evaluation Hooks</h4>

<p>Monotone makes heavy use of certs to provide descriptive information
about revisions. In many projects, not all developers should have the
same privileges, or be trusted for the same purposes (indeed, some
signers might be automated robots, with very specific purposes).

   <p>These hooks allow the user to configure which signers will be trusted to
make which kinds of assertions using certs. Monotone uses these certs when
selecting available revisions for commands such as <samp><span class="command">update</span></samp>.

   <p>Each user, or even each workspace, can have their own
implementation of these hooks, and thus a different filtered view of
valid revisions, according to their own preferences and purposes.

     <dl>
<dt><code>get_revision_cert_trust (</code><var>signers</var><code>, </code><var>id</var><code>, </code><var>name</var><code>, </code><var>val</var><code>)</code><a name="index-get_005frevision_005fcert_005ftrust-_0028_0040var_007bsigners_007d_002c-_0040var_007bid_007d_002c-_0040var_007bname_007d_002c-_0040var_007bval_007d_0029-208"></a><dd>
Returns whether or not you <em>trust</em> the assertion
<var>name</var>=<var>value</var> on a given revision <var>id</var>, given a valid
signature from all the keys in <var>signers</var>. The <var>signers</var>
parameter is a table containing all the key names which signed this
cert, the other three parameters are strings.

     <p>The default definition of this hook simply returns <code>true</code>, which
corresponds to a form of trust where every key which is defined in
your database is trusted. This is a <em>weak</em> trust setting; you
should change it to something stronger. A possible example of a
stronger trust function (along with a utility function for computing
the intersection of tables) is the following:

     <pre class="smallexample">          function intersection(a,b)
             local s={}
             local t={}
             for k,v in pairs(a) do s[v] = 1 end
             for k,v in pairs(b) do if s[v] ~= nil then table.insert(t,v) end end
             return t
          end
          
          function get_revision_cert_trust(signers, id, name, val)
             local trusted_signers = { "bob@happyplace.example.com",
                                       "friend@trustedplace.example.com",
                                       "myself@home.example.com" }
             local t = intersection(signers, trusted_signers)
          
             if t == nil then return false end
          
             if    (name ~= "branch" and table.getn(t) &gt;= 1)
                or (name == "branch" and table.getn(t) &gt;= 2)
             then
                return true
             else
                return false
             end
          end
</pre>
     <p>In this example, any revision certificate is trusted if it is signed
by at least one of three &ldquo;trusted&rdquo; keys, unless it is an
<code>branch</code> certificate, in which case it must be signed by
<em>two</em> or more trusted keys. This is one way of requiring that
the revision has been approved by an extra &ldquo;reviewer&rdquo; who used the
<samp><span class="command">approve</span></samp> command.

     <br><dt><code>accept_testresult_change (</code><var>old_results</var><code>, </code><var>new_results</var><code>)</code><a name="index-accept_005ftestresult_005fchange-_0028_0040var_007bold_005fresults_007d_002c-_0040var_007bnew_005fresults_007d_0029-209"></a><dd>
This hook is used by the update algorithm to determine whether a
change in test results between update source and update target is
acceptable. The hook is called with two tables, each of which maps a
signing key &ndash; representing a particular testsuite &ndash; to a boolean
value indicating whether or not the test run was successful. The
function should return <code>true</code> if you consider an update from the
version carrying the <var>old_results</var> to the version carrying the
<var>new_results</var> to be acceptable.

     <p>The default definition of this hook follows:

     <pre class="smallexample">          function accept_testresult_change(old_results, new_results)
             for test,res in pairs(old_results)
             do
                if res == true and new_results[test] ~= true
                then
               return false
                end
             end
             return true
          end
</pre>
     <p>This definition accepts only those updates which preserve the set of
<code>true</code> test results from update source to target. If no test
results exist, this hook has no affect; but once a <code>true</code> test
result is present, future updates will require it. If you want a more
lenient behavior you must redefine this hook.

   </dl>

<h4 class="subsection">6.1.6 External Diff Tools</h4>

<p>Differences between files can be shown in a number of ways, varying
according to user preference and file type. These hooks allow
customisation of the way file differences are shown.

     <dl>
<dt><code>get_encloser_pattern (</code><var>file_path</var><code>)</code><a name="index-get_005fencloser_005fpattern-_0028_0040var_007bfile_005fpath_007d_0029-210"></a><dd>
Called for each file when <samp><span class="command">diff</span></samp> is given the
<samp><span class="option">--show-encloser</span></samp> option (and <em>not</em> the
<samp><span class="option">--external</span></samp> option).  <var>file_path</var> is the pathname of the
file that is being diffed.  The hook should return a string constant
containing a regular expression; this regular expression will be used
to find lines that, in that file, name the &ldquo;top-level&rdquo; constructs
enclosing each &ldquo;hunk&rdquo; of changes.  The default is
<code>^[[:alnum:]$_]</code>, which is correct for many programming
languages; a few text authoring packages, like Texinfo, have special
regular expressions that match their particular syntax.  If you have a
better regular expression for some language, you can add it to this
hook; and if you send it to the monotone developers, we will likely
make it the default for that language.  See <a href="Regexps.html#Regexps">Regexps</a>, for the
regular expression syntax.

     <br><dt><code>external_diff (</code><var>file_path</var><code>, </code><var>old_data</var><code>, </code><var>new_data</var><code>, </code><var>is_binary</var><code>, </code><var>diff_args</var><code>, </code><var>old_rev</var><code>, </code><var>new_rev</var><code>)</code><a name="index-external_005fdiff-_0028_0040var_007bfile_005fpath_007d_002c-_0040var_007bold_005fdata_007d_002c-_0040var_007bnew_005fdata_007d_002c-_0040var_007bis_005fbinary_007d_002c-_0040var_007bdiff_005fargs_007d_002c-_0040var_007bold_005frev_007d_002c-_0040var_007bnew_005frev_007d_0029-211"></a><dd>
Called for each file when <samp><span class="command">diff</span></samp> is given the
<samp><span class="option">--external</span></samp> option.  <var>file_path</var> is the pathname of the
file that is being diffed.  <var>old_data</var> and <var>new_data</var> are the
data contents of the old and the new file.  If the data is binary,
<var>is_binary</var> will be true, otherwise false.  <var>old_rev</var> and
<var>new_rev</var> are the revision IDs of the old and new data.

     <p>If an extra arguments are given via <samp><span class="option">--diff-args</span></samp>, the string
will be passed in as <var>diff_args</var>.  Otherwise <var>diff_args</var> will
be nil.

     <p>The default implementation of this hook calls the program <samp><span class="command">diff</span></samp>,
and if <samp><span class="option">--diff-args</span></samp> were not passed, takes default arguments
from the Lua variable <code>external_diff_default_args</code>.  You can
override this variable in your configuration file, without overriding
the whole hook.

   </dl>

<h4 class="subsection">6.1.7 External Merge Tools</h4>

<p>Monotone often needs to merge together the work of multiple distributed
developers, and uses these hooks to help this process when the merge
does not automatically succeed.  Often these hooks will be used to invoke
an external interactive merge tool.

   <p>The <a href="Default-hooks.html#Default-hooks">Default hooks</a> include helper functions used by the hooks below
to invoke a number of external merge tools known to monotone, and you
can override or extend these hooks if you have a preferred tool, or if
you have a tool specific to certain file types.

     <dl>
<a name="merge3"></a><dt><code>merge3 (</code><var>ancestor_path</var><code>, </code><var>left_path</var><code>, </code><var>right_path</var><code>, </code><var>merged_path</var><code>, </code><var>ancestor_text</var><code>, </code><var>left_text</var><code>, </code><var>right_text</var><code>)</code><a name="index-merge3-_0028_0040var_007bancestor_005fpath_007d_002c-_0040var_007bleft_005fpath_007d_002c-_0040var_007bright_005fpath_007d_002c-_0040var_007bmerged_005fpath_007d_002c-_0040var_007bancestor_005ftext_007d_002c-_0040var_007bleft_005ftext_007d_002c-_0040var_007bright_005ftext_007d_0029-212"></a><dd>
This hook is called to resolve merges that monotone could not resolve
automatically.  The actual ancestor, left, and right contents of the
file are passed in the <var>ancestor_text</var>, <var>left_text</var>, and
<var>right_text</var> strings.  In addition, the hook is given the names
that this file had in the ancestor (<var>ancestor_path</var>), left
(<var>left_path</var>), and right (<var>right_path</var>) trees, and the name it
will end up having in the merged tree (<var>merged_path</var>).  These
paths are useful for merge tools that can display the names of files
in their GUI, since the actual path names are likely more meaningful
than the temporary file names the merge tool will actually be working
on.

     <p>Returns a string, which should be the merger of the given texts.  The
default definition of this hook delegates the actual merge to the
result of <a href="get_005fpreferred_005fmerge3_005fcommand.html#get_005fpreferred_005fmerge3_005fcommand">get_preferred_merge3_command</a>.  The default definition
of <a href="get_005fpreferred_005fmerge3_005fcommand.html#get_005fpreferred_005fmerge3_005fcommand">get_preferred_merge3_command</a> checks to see if the
<samp><span class="env">MTN_MERGE</span></samp> environment variable, or the Lua variable
<code>merger</code> are set to the name of a merge tool that it recognizes,
and if not, then simply searches for whatever is installed on the
local system.  For details, see the code in <a href="Default-hooks.html#Default-hooks">Default hooks</a>.

     <p><a name="get_005fpreferred_005fmerge3_005fcommand"></a><br><dt><code>get_preferred_merge3_command(</code><var>tbl</var><code>)</code><a name="index-get_005fpreferred_005fmerge3_005fcommand_0028_0040var_007btbl_007d_0029-213"></a><dd>
Returns the results of running an external merge on three strings. 
<var>tbl</var> wraps up the various arguments for each merge command and
is always provided by <a href="merge3.html#merge3">merge3</a>. If there is a particular editor
that you would like to use to perform merge3 operations, override
this hook to specify it.

   </dl>

<h4 class="subsection">6.1.8 Selector Expansion</h4>

<p>Monotone's selectors are a powerful mechanism used to refer to revisions
with symbolic names or groupings. Thanks to the hooks described in this
section, it is possible to use various forms of shorthand in selection
strings; these hooks are designed to recognise shorthand patterns and
expand them to their full form.

   <p>For more detail on the use of selectors, see <a href="Selectors.html#Selectors">Selectors</a>.

     <dl>
<dt><code>expand_selector (</code><var>str</var><code>)</code><a name="index-expand_005fselector-_0028_0040var_007bstr_007d_0029-214"></a><dd>
Attempts to expand <var>str</var> as a selector. Expansion generally means
providing a type prefix for the selector, such as <code>a:</code> for authors
or <code>d:</code> for dates. This hook is called once for each element of a
combined selector string (between <code>/</code> separators) prior to
evaluation of the selector. For the default definition of this hook, see
<a href="Default-hooks.html#Default-hooks">Default hooks</a>.

     <br><dt><code>expand_date (</code><var>str</var><code>)</code><a name="index-expand_005fdate-_0028_0040var_007bstr_007d_0029-215"></a><dd>
Attempts to expand <var>str</var> as a date expression. Expansion means
recognizing and interpreting special words such as <code>yesterday</code> or
<code>6 months ago</code> and converting them into well formed date
expressions. For the default definition of this hook, see <a href="Default-hooks.html#Default-hooks">Default hooks</a>.

   </dl>

<h4 class="subsection">6.1.9 Attribute Handling</h4>

<p>Some files in a project are special; they may require different handling
(such as binary or structured files that should always be manually
merged &ndash; see <a href="Merging.html#Merging">Merging</a>), or they may represent executable scripts
or programs.

   <p>Monotone allows each file (or directory) in a repository to carry
arbitrary <a href="File-Attributes.html#File-Attributes">File Attributes</a>.  Persistent attributes are stored
each revision's manifest. The hooks in this section allow files to be
automatically recognised as having certain attributes at the time
they're added, and for custom triggers to be invoked on each file
according to its attributes when the workspace is changed.

     <dl>
<dt><code>attr_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>, </code><var>value</var><code>)</code><a name="index-attr_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_002c-_0040var_007bvalue_007d_0029-216"></a><dd>
This is not a hook function, but a <em>table</em> of hook
functions. Each entry in the table <code>attr_functions</code>, at table
entry <var>attribute</var>, is a function taking a file name <var>filename</var>
and a attribute value <var>value</var>. The function should &ldquo;apply&rdquo; the
attribute to the file, possibly in a platform-specific way.

     <p>Hook functions from this table are called for each existing attr,
after any command which modifies the workspace. This facility can
be used to extend monotone's understanding of files with
platform-specific attributes, such as permission bits, access control
lists, or special file types.

     <p>By default, there is only one entry in this table, for the <code>mtn:execute</code>
attribute. Its definition is:

     <pre class="smallexample">          attr_functions["mtn:execute"] =
            function(filename, value)
                  if (value == "true") then
                   make_executable(filename)
                end
             end
</pre>
     <br><dt><code>attr_init_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>)</code><a name="index-attr_005finit_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_0029-217"></a><dd>
This is not a hook function, but a <em>table</em> of hook
functions. Each entry in the table <code>attr_init_functions</code>, at
table entry <var>attribute</var>, is a function taking a file (or
directory) name <var>filename</var>. Each function defines the attributes
that should be set on the file named <var>filename</var>. This table of
hook functions is called once for each file during an <dfn>add</dfn>.

     <p>By default, there are only two entries in this table, for the
<code>mtn:execute</code> and <code>mtn:manual_merge</code> attributes. Their
definition is:

     <pre class="smallexample">          attr_init_functions["mtn:execute"] =
             function(filename)
                if (is_executable(filename)) then
                  return "true"
                else
                  return nil
                end
             end
          attr_init_functions["mtn:manual_merge"] =
             function(filename)
                if (binary_file(filename)) then
                  return "true" -- binary files must be merged manually
                else
                  return nil
                end
             end
</pre>
     <p>The <code>binary_file</code> function is also defined as a Lua hook. See
<a href="Default-hooks.html#Default-hooks">Default hooks</a>.

   </dl>

<h4 class="subsection">6.1.10 Validation Hooks</h4>

<p>If there is a policy decision to make, Monotone defines certain hooks to
allow a client to validate or reject certain behaviors.

     <dl>
<dt><code>validate_commit_message (</code><var>message</var><code>, </code><var>revision_text</var><code>, </code><var>branchname</var><code>)</code><a name="index-validate_005fcommit_005fmessage-_0028_0040var_007bmessage_007d_002c-_0040var_007brevision_005ftext_007d_002c-_0040var_007bbranchname_007d_0029-218"></a><dd>
This hook is called after the user has entered his/her commit message. 
<var>message</var> is the commit message that the user has entered and
<var>revision_text</var> is the full text of the changes for this revision,
which can be parsed with the parse_basic_io function. The <var>branchname</var> on
which the new revision will be committed if all goes well is passed in as the third
parameter. 
If the hook finds the commit message satisfactory, it can return <code>true,
""</code>. If it finds fault, then it can return <code>false, reason</code> where
<var>reason</var> is the reason the message was rejected. By default, this hook
rejects empty log messages.

   </dl>

   </body></html>

