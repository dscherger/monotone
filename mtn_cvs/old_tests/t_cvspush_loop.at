#  -*- Autoconf -*-

AT_SETUP([CVS push with fork and merge])

MTN_SETUP

AT_DATA(d_a, [A
])
AT_DATA(d_b, [B
])
AT_DATA(d_c, [C
])

# build the cvs repository

CVSROOT=`pwd`/cvs-repository
AT_CHECK(cvs -q -d $CVSROOT init)
AT_CHECK(test -e $CVSROOT)
AT_CHECK(test -e $CVSROOT/CVSROOT)
AT_CHECK(test -e $CVSROOT/CVSROOT/history)

# import a test project

AT_CHECK(mkdir cvstemp)
AT_CHECK(cp d_a cvstemp/A)
AT_CHECK(cp d_b cvstemp/B)
AT_CHECK([cd cvstemp ; cvs -q -d $CVSROOT import -m 'initial import' test vendor_tag initial_import], [], [ignore], [ignore])

# change the repository in various ways

AT_CHECK([cvs -q -d $CVSROOT co test], [], [ignore], [ignore])
AT_CHECK([cd test;MTN --root . --branch testbranch cvs_takeover test], [0], [ignore], [ignore])
AT_CHECK([cp -r test test2])

AT_CHECK([cd test;MTN drop A;MTN ci -m "a dropped"], [0], [ignore], [ignore])
LEFT=`MTN automate heads`

AT_CHECK([cp d_c test2/C])
AT_CHECK([cd test2;MTN add C;MTN ci -m "c added"], [0], [ignore], [ignore])

AT_CHECK(MTN merge, [0], [ignore], [ignore])
AT_CHECK(MTN --branch testbranch cvs_push, [0], [ignore], [ignore])

# no change yet
AT_CHECK([test -e $CVSROOT/test/A,v])
AT_CHECK([test ! -e $CVSROOT/test/C,v])

AT_CHECK(MTN --revision $LEFT --branch testbranch cvs_push, [0], [ignore], [ignore])
AT_CHECK([test -e $CVSROOT/test/Attic/A,v])
AT_CHECK([test -e $CVSROOT/test/C,v])

# I refrain to test file contents

AT_CLEANUP
