#  -*- Autoconf -*-

# this script uses the 'qmail' mail server and the 'tcpserver' network package 
# from ucspi-tcp. if you do not have them installed, it will fail.

AT_SETUP([communicating with a mail server])

MONOTONE_SETUP
AT_CHECK(cp test.db test2.db)

AT_DATA(smtp.lua, [
function get_post_targets(groupname)
	return { "mailto:test@127.0.0.1:8025" } 
end

function get_fetch_sources(groupname)
	return { "mailto:test@127.0.0.1:8025" } 
end

function get_mail_hostname(url)
	return "self"
end

function get_mail_sender(url)
	return "tester@test.net"
end
])

AT_DATA(testfile, [version 0 of test file
])
AT_CHECK(MONOTONE add testfile, [], [ignore], [ignore])
AT_CHECK(MONOTONE --branch=testbranch --rcfile=smtp.lua commit blah-blah, [], [ignore], [ignore])
VER0=`SHA1(MT/manifest)`

AT_DATA(testfile, [version 1 of test file
])
AT_CHECK(MONOTONE --rcfile=smtp.lua commit blah-blah, [], [ignore], [ignore])
VER1=`SHA1(MT/manifest)`

QMAILROOT=`pwd`/qmailroot
PORT=8025
HOST=127.0.0.1
GROUP=monotone.test.packets

export PATH=$QMAILROOT:/usr/local/sbin:$PATH
TCPSERVER=`which tcpserver`
SMTPD=`which qmail-smtpd`

# if no tcpserver or smtpd, skip the test
if test -z "$TCPSERVER" || test -z "$SMTPD"; then
  exit 77
fi

# /var/qmail/control/me must be set. crazy.
AT_CHECK(test -e /var/qmail/control/me) 
AT_CHECK(test -x $TCPSERVER)
AT_CHECK(test -x $SMTPD)
AT_CHECK(mkdir -p $QMAILROOT)

# write a fake "qmail-queue" program
QQ=$QMAILROOT/qmail-queue
AT_DATA($QQ, [#!/bin/sh
cat >QROOT/received-mail
exit 0
])
AT_CHECK(perl -i -pe "s@QROOT@$QMAILROOT@" $QQ)
AT_CHECK(chmod 0755 $QQ)

# autotest knows no way of doing background processes

AT_CHECK(cp $TCPSERVER ./smtp-test-tcpserver)
AT_CHECK(chmod 0755 ./smtp-test-tcpserver)
killall -q -TERM smtp-test-tcpserver
killall -q -KILL qmail-smtpd
./smtp-test-tcpserver -H -R -P -l 0 $HOST $PORT env QMAILQUEUE=$QQ qmail-smtpd & >/dev/null 2>&1
sleep 2

AT_CHECK(MONOTONE --rcfile=smtp.lua --verbose post, [], [ignore], [ignore])
AT_CHECK(grep mdata $QMAILROOT/received-mail, [], [stdout])
AT_CHECK(grep $VER0 $QMAILROOT/received-mail, [], [ignore])

killall -q -TERM smtp-test-tcpserver
killall -q -KILL qmail-smtpd

AT_CLEANUP
