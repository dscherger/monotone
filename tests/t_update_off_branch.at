AT_SETUP([update to off-branch rev])
MTN_SETUP

ADD_FILE(testfile, [blah blah
])
COMMIT(testbranch)
TR=`BASE_REVISION`

SET_FILE(testfile, [other other
])
COMMIT(otherbranch)
OR=`BASE_REVISION`

SET_FILE(testfile, [third third
])
COMMIT(somebranch)
SR=`BASE_REVISION`
AT_CHECK(MTN cert $SR branch otherbranch, [], [ignore], [ignore])

SET_FILE(testfile, [double double
])
COMMIT(nobranch)
NR=`BASE_REVISION`
AT_CHECK(MTN db kill_branch_certs_locally nobranch)

AT_CHECK(MTN checkout --branch=testbranch --revision=$TR codir, [], [ignore], [ignore])
AT_CHECK(grep '^ *branch "testbranch"' codir/_MTN/options, [], [ignore], [ignore])
# make sure that updating to a rev in one other branch puts us in that branch
AT_CHECK(cd codir && MTN update --revision=$OR, [], [ignore], [ignore])
AT_CHECK(grep '^ *branch "otherbranch"' codir/_MTN/options, [], [ignore], [ignore])

# updating to a rev in multiple branches, including current branch, leaves branch alone
AT_CHECK(cd codir && MTN update -r $SR, [], [ignore], [ignore])
AT_CHECK(grep '^ *branch "otherbranch"' codir/_MTN/options, [], [ignore], [ignore])

# but updating to a rev in multiple branches that _don't_ include the current one, fails
# first go back out to TR
AT_CHECK(cd codir && MTN update -r $TR, [], [ignore], [ignore])
AT_CHECK(grep '^ *branch "testbranch"' codir/_MTN/options, [], [ignore], [ignore])
# and now jumping to SR directly should fail
AT_CHECK(cd codir && MTN update -r $SR, [1], [ignore], [ignore])
AT_CHECK(grep '^ *branch "testbranch"' codir/_MTN/options, [], [ignore], [ignore])

# updating to a rev in no branches at all succeeds, and leaves current branch alone
AT_CHECK(cd codir && MTN update -r $NR, [], [ignore], [ignore])
AT_CHECK(grep '^ *branch "testbranch"' codir/_MTN/options, [], [ignore], [ignore])

AT_CLEANUP
