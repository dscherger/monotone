#  -*- Autoconf -*-

AT_SETUP([database check for normalization])

# the included database is valid except for all paths being "./" prefixed,
# hence the database doesn't have correctly normalised manifests
# nor revisions.

# for future reference, it was created with a modified monotone binary,
# manifest.cc, and transforms.cc were the modified files.

MONOTONE_SETUP
NEED_UNGZB64

AT_DATA(bad.db.gz.b64,[
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
AAA=
])
UNGZB64(bad.db.gz.b64, bad.db)

AT_CHECK(MONOTONE db migrate -d bad.db)

AT_CHECK(MONOTONE db check -d bad.db, [1], [ignore], [stderr])

AT_CHECK(grep 'revisions not parseable' stderr, [], [ignore], [ignore])
AT_CHECK(grep 'manifests not parseable' stderr, [], [ignore], [ignore])

AT_CLEANUP
