AT_SETUP([pid file and log handles open failures])
MTN_SETUP

# --log should fail if it can't open the file.
AT_CHECK(touch inaccessible.log)
AT_CHECK(chmod 000 inaccessible.log)
AT_CHECK(MTN --log=inaccessible.log status, [1], [ignore], [ignore])

# and it should fail if the specified file is read only.
AT_CHECK(touch ro.log)
AT_CHECK(chmod 400 ro.log)
AT_CHECK(MTN --log=ro.log status, [1], [ignore], [ignore])

# it should also fail if the a parent directory of the file is not
# accessible.
AT_CHECK(mkdir noaccess)
AT_CHECK(chmod 100 noaccess)
AT_CHECK(MTN --log=noaccess/my.log status, [1], [ignore], [ignore])

NETSYNC_SETUP

# --pid-file checks that the file doesn't exist.  check that we fail if we
# can't create the specified file.
AT_CHECK(MTN serve --pid-file=noaccess/my.pid --bind=127.0.0.1:$_PORT testbranch, [1], [ignore], [ignore])

# no need to kill the server--if the test succeeded the server must have
# failed to start.

AT_CHECK(chmod 600 inaccessible.log ro.log noaccess)
AT_CHECK(rm -f inaccessible.log ro.log)
AT_CHECK(rmdir noaccess)

AT_CLEANUP
