AT_SETUP([automate keys])
MTN_SETUP

ADD_FILE(testfile, [foo bar
])
AT_CHECK(MTN ci -m foobar, [], [ignore], [ignore])
AT_CHECK((echo foo@bar.com; echo foo@bar.com) | MTN genkey foo@bar.com, [], [ignore], [ignore])
AT_CHECK((echo foo@baz.com; echo foo@baz.com) | MTN genkey foo@baz.com, [], [ignore], [ignore])
AT_CHECK(MTN pubkey foo@baz.com > baz)
AT_CHECK(MTN dropkey foo@baz.com, [], [ignore], [ignore])
AT_CHECK(MTN read < baz, [], [ignore], [ignore])

# we now have foo@bar.com in the keystore, tester@test.net in both keystore
# and database, and foo@baz.com in only the database
AT_CHECK(MTN automate keys, [], [stdout], [ignore])
AT_CHECK(cp stdout output)

AT_CHECK([sed -ne '/foo@bar.com/,/^$/p' output > foobar])
AT_CHECK([sed -ne '/foo@baz.com/,/^$/p' output > foobaz])
AT_CHECK([sed -ne '/tester@test.net/,/^$/p' output > tester])

AT_CHECK(QGREP database foobar, [1])
AT_CHECK(QGREP private foobaz, [1])
AT_CHECK(grep keystore tester | QGREP database)
AT_CHECK(grep keystore tester | QGREP -v database)
AT_CHECK(QGREP private tester)
AT_CHECK(QGREP public foobar)
AT_CHECK(QGREP public foobaz)
AT_CHECK(QGREP public tester)

AT_CLEANUP
