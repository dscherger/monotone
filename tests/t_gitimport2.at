#  -*- Autoconf -*-

AT_SETUP([importing more interesting GIT archive])

MONOTONE_SETUP

AT_DATA(importme.0, [version 0 of test file
])

AT_DATA(importme.1, [version 1 of test file
])

AT_DATA(importme.2, [version 2 of test file
])

AT_DATA(importme.3, [version 3 of test file
])

AT_DATA(taglist, [commit/c2 d049f5c92cab90d58306449aff93b6b6cf73c728 tester@test.net
commit1 748f08f9c8d2588213205431273da20c1042f07e tester@test.net
])

TSHA0=`SHA1(importme.0)`
TSHA1=`SHA1(importme.1)`
TSHA2=`SHA1(importme.2)`
TSHA3=`SHA1(importme.3)`

# build the git repository

AT_CHECK(git-init-db, [], [ignore], [ignore])
AT_CHECK(test -e .git)
AT_CHECK(test -e .git/refs)
AT_CHECK(test -e .git/refs/heads)
AT_CHECK(test -e .git/refs/tags)

# check out the working copy and make some commits

AT_CHECK(cp importme.0 importme)
AT_CHECK(git-update-cache --add importme, [], [ignore], [ignore])
AT_CHECK(echo 'commit 0' | git-commit-tree $(git-write-tree) >.git/HEAD, [], [ignore], [ignore])
AT_CHECK(cp importme.1 importme)
AT_CHECK(git-update-cache importme, [], [ignore], [ignore])
AT_CHECK(echo 'commit 1' | git-commit-tree $(git-write-tree) -p $(cat .git/HEAD) >.git/HEAD, [], [ignore], [ignore])
AT_CHECK(cat .git/HEAD >.git/refs/tags/commit1)
AT_CHECK(cp importme.2 importme)
AT_CHECK(git-update-cache importme, [], [ignore], [ignore])
AT_CHECK(echo 'commit 2' | git-commit-tree $(git-write-tree) -p $(cat .git/HEAD) >.git/HEAD, [], [ignore], [ignore])
AT_CHECK(mkdir .git/refs/tags/commit)
AT_CHECK(cat .git/HEAD >.git/refs/tags/commit/c2)
AT_CHECK(cp importme.3 importme)
AT_CHECK(git-update-cache importme, [], [ignore], [ignore])
AT_CHECK(echo 'commit 3' | git-commit-tree $(git-write-tree) -p $(cat .git/HEAD) >.git/refs/heads/alt, [], [ignore], [ignore])

# import into monotone and check presence of files

AT_CHECK(MONOTONE --branch=testbranch git_import .git, [], [ignore], [ignore])
AT_CHECK(MONOTONE cat file $TSHA0, [], [ignore])
AT_CHECK(MONOTONE cat file $TSHA1, [], [ignore])
AT_CHECK(MONOTONE cat file $TSHA2, [], [ignore])
AT_CHECK(MONOTONE cat file $TSHA3, [], [ignore])

# also check that history is okay -- has a unique head, and it's the
# right one.

AT_CHECK(MONOTONE list tags >taglist.t)
AT_CHECK(cmp taglist taglist.t)

AT_CHECK(MONOTONE checkout --branch=testbranch mtcodir, [], [ignore], [ignore])
AT_CHECK(cmp importme.2 mtcodir/importme)
AT_CHECK(rm -rf mtcodir)
AT_CHECK(MONOTONE checkout --branch=testbranch.alt mtcodir, [], [ignore], [ignore])
AT_CHECK(cmp importme.3 mtcodir/importme)

AT_CLEANUP
