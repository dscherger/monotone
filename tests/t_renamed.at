#  -*- Autoconf -*-

AT_SETUP([renaming a directory])

MONOTONE_SETUP

AT_CHECK(mkdir foo)

AT_DATA(foo/foo, [foo file
])
AT_DATA(bleh, [bleh file
])

# produce root
AT_CHECK(MONOTONE add foo, [], [ignore], [ignore])
AT_CHECK(MONOTONE --branch=testbranch commit blah-blah, [], [ignore], [ignore])
ROOT_M_SHA=`SHA1(MT/manifest)`
ROOT_F_SHA=`SHA1(foo/foo)`

# produce move edge
AT_CHECK(MONOTONE rename foo bar, [], [ignore], [ignore])
AT_CHECK(cp -ar foo bar)
AT_CHECK(MONOTONE commit blah-blah, [], [ignore], [ignore])

# revert to root
PROBE_NODE(foo/foo, $ROOT_M_SHA, $ROOT_F_SHA)
AT_CHECK(rm -Rf bar)

# make an add *into the directory*
AT_DATA(foo/bar, [bar file
])
AT_CHECK(MONOTONE add foo/bar, [], [ignore], [ignore])
AT_CHECK(MONOTONE commit blah-blah, [], [ignore], [ignore])

# merge the add and the rename
AT_CHECK(MONOTONE merge, [], [ignore], [ignore])
AT_CHECK(MONOTONE update, [], [ignore], [ignore])
AT_CHECK(grep bar/bar MT/manifest, [0], [ignore], [ignore])
AT_CHECK(grep bar/foo MT/manifest, [0], [ignore], [ignore])
AT_CHECK(grep foo/bar MT/manifest, [1], [ignore], [ignore])
AT_CHECK(grep foo/foo MT/manifest, [1], [ignore], [ignore])
AT_CHECK(test -e bar/bar)
AT_CHECK(test -e bar/foo)

AT_CLEANUP


