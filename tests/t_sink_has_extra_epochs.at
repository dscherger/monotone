AT_SETUP([one-way netsync where the sink has more epochs])
MTN_SETUP
NETSYNC_SETUP

# If the sink has more epochs than the source (say, on branches that are
# included in the include glob, but only exist on the sink), then the epoch
# refiner on the source will say we have items to receive. But since we're in
# source-only mode, we won't actually be receiving any items. So our epoch
# refiner will forever say we have items to receive, and we don't want to hang
# forever waiting for them.

# FIXME: This test will HANG on failure. (And then, of course, it will report
# "ok" if stopped with ^C, since the stuff to check that the push worked
# doesn't actually get run... :-/ )

ADD_FILE(foo, [foo
])
COMMIT(testbranch)
AT_CHECK(MTN db set_epoch testbranch 1234567890123456789009876543210987654321)
AT_CHECK(rm -r _MTN/)
AT_CHECK(MTN2 setup -b otherbranch ., [], [ignore], [ignore])
AT_DATA(bar, [bar
])
AT_CHECK(MTN2 add bar, [], [ignore], [ignore])
AT_CHECK(MTN2 commit -m blah-blah, [], [ignore], [ignore])

NETSYNC_SERVE_START(*branch)
NETSYNC_CLIENT_N_RUN(2, push, *branch, 0)
NETSYNC_SERVE_STOP

AT_CHECK(MTN ls branches, [], [stdout], [ignore])
AT_CHECK(QGREP testbranch stdout, [], [ignore], [ignore])
AT_CHECK(QGREP otherbranch stdout, [], [ignore], [ignore])

AT_CLEANUP
