AT_SETUP([use restrictions with --exclude])
MTN_SETUP

AT_CHECK(mkdir foo)
AT_DATA(file1, [x
])
AT_DATA(foo/bar, [y
])

AT_CHECK(MTN add file1, [], [ignore], [ignore])
AT_CHECK(MTN add foo/bar, [], [ignore], [ignore])

AT_CHECK(MTN ci --exclude . -m 'x', [1], [ignore], [ignore])

# this is dumb. excluding the whole tree and including file1 is
# equivalent to just including file1. except that at this point 
# the root dir has not been created and excluding the whole tree
# excludes this creation. this causes the commit to fail because
# file1 has no parent.
#
# AT_CHECK(MTN ci --exclude . file1 -m 'x', [], [ignore], [ignore])
# AT_CHECK(MTN status --brief | grep "foo/bar", [], [ignore], [ignore])
# AT_CHECK(MTN status --brief | grep "file1", [1], [ignore], [ignore])
# AT_CHECK(echo a >>file1)

AT_CHECK(MTN ci --exclude foo -m 'x', [], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "foo/bar", [], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "file1", [1], [ignore], [ignore])
AT_CHECK(echo a >>file1)

AT_CHECK(MTN ci . --exclude file1 -m 'x', [], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "foo/bar", [1], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "file1", [], [ignore], [ignore])
AT_CHECK(echo b >>foo/bar)

AT_CHECK(MTN ci . --exclude foo foo/bar -m 'x', [], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "foo/bar", [1], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "file1", [1], [ignore], [ignore])
AT_CHECK(echo a >>file1)
AT_CHECK(echo b >>foo/bar)

AT_CHECK(MTN ci --exclude foo foo/bar -m 'x', [], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "foo/bar", [1], [ignore], [ignore])
AT_CHECK(MTN status --brief | grep "file1", [], [ignore], [ignore])

AT_CLEANUP
