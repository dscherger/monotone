AT_SETUP([merge --lca])
MTN_SETUP

# --lca is a temporary workaround for 3-way merge suckiness.  So this
# test should go away eventually.

# arguably the issue is now fixed with mark-merge. I've changed 
# the test to do a successful merge of E and F, since, well,
# extra merge cases never hurt. 

#    A
#   / \
#  B   C
#  |\ /|
#  D X |
#  |/ \|
#  E   F

ADD_FILE(testfile, [foo bar
])
COMMIT(testbranch)
A=`BASE_REVISION`

ADD_FILE(otherfile1, [blah blah
])
COMMIT(testbranch)
B=`BASE_REVISION`

REVERT_TO($A)

SET_FILE(testfile, [new stuff
])
COMMIT(testbranch)
C=`BASE_REVISION`

AT_CHECK(MTN merge, [], [ignore], [ignore])
AT_CHECK(MTN update, [], [ignore], [ignore])
F=`BASE_REVISION`

REVERT_TO($B)

ADD_FILE(otherfile2, [blah blah
])
COMMIT(testbranch)
D=`BASE_REVISION`

AT_CHECK(MTN explicit_merge $D $C testbranch, [], [ignore], [ignore])
AT_CHECK(MTN update, [], [ignore], [ignore])
E=`BASE_REVISION`

AT_CHECK(MTN merge --lca, [], [ignore], [stderr])
AT_CHECK(QGREP($A stderr), [1])
AT_CHECK(QGREP($E stderr), [])
AT_CHECK(QGREP($F stderr), [])

AT_CLEANUP
