#  -*- Autoconf -*-

AT_SETUP([netsync permissions])

MTN_SETUP

# generate a new key

OTHER=other@test.net
AT_CHECK((echo $OTHER; echo $OTHER) | MTN genkey $OTHER, [], [ignore], [ignore])

NETSYNC_SETUP

# test with open security settings
AT_CHECK(mkdir open)
AT_DATA(open/read-permissions, [
pattern "*"
allow "*"
])
AT_DATA(open/write-permissions, [
*
])

ADD_FILE(badfile, [badfile
])
AT_CHECK(MTN --branch=badbranch commit --message badfile, [], [ignore], [ignore])

AT_CHECK(cp test.db clean.db)
AT_CHECK(cp -r keys/ clean_keys)

ADD_FILE(testfile, [testfile
])
AT_CHECK(MTN --branch=testbranch commit --message testfile, [], [ignore], [ignore])
BASE=`BASE_REVISION`

MINHOOKS_NETSYNC_SERVE_START(testbranch --confdir open)

# anonymous pull 

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull --key="", testbranch)
AT_CHECK(MTN2 automate get_revision $BASE, [0], [stdout], [stderr])

# pull with default key

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull, testbranch)
AT_CHECK(MTN2 automate get_revision $BASE, [0], [stdout], [stderr])

# pull with other key

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull --key=$OTHER, testbranch)
AT_CHECK(MTN2 automate get_revision $BASE, [0], [stdout], [stderr])

# pull with unknown key fails

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
UNKNOWN=unknown@test.net
AT_CHECK((echo $UNKNOWN; echo $UNKNOWN) | MTN2 genkey $UNKNOWN, [], [ignore], [ignore])
NETSYNC_CLIENT_RUN(pull --key=$UNKNOWN, testbranch, [1])
AT_CHECK(MTN2 automate get_revision $BASE, [1], [stdout], [stderr])

# push with default key

AT_CHECK(cp test.db test2.db)
AT_CHECK(rm -r keys2 && cp -r keys/ keys2)
REVERT_N_TO(2, $BASE)
ADD_N_FILE(2, default, [default
])
AT_CHECK(MTN2 commit --message default, [], [ignore], [ignore])
DEFAULT_REV=`BASE_REVISION`
NETSYNC_CLIENT_RUN(push, testbranch)

# push with other key

REVERT_N_TO(2, $BASE)
ADD_N_FILE(2, other, [other
])
AT_CHECK(MTN2 commit --message other, [], [ignore], [ignore])
OTHER_REV=`BASE_REVISION`
NETSYNC_CLIENT_RUN(push --key=$OTHER , testbranch)

# push with unknown key fails

REVERT_N_TO(2, $BASE)
ADD_N_FILE(2, unknown, [unknown
])
AT_CHECK(MTN2 commit --message unknown, [], [ignore], [ignore])
UNKNOWN_REV=`BASE_REVISION`
AT_CHECK((echo $UNKNOWN; echo $UNKNOWN) | MTN2 genkey $UNKNOWN, [], [ignore], [ignore])
NETSYNC_CLIENT_RUN(push --key=$UNKNOWN, testbranch, [1])

NETSYNC_SERVE_STOP

AT_CHECK(MTN automate get_revision $DEFAULT_REV, [0], [stdout], [stderr])
AT_CHECK(MTN automate get_revision $OTHER_REV, [0], [stdout], [stderr])
AT_CHECK(MTN automate get_revision $UNKNOWN_REV, [1], [stdout], [stderr])


# test with closed security settings
AT_CHECK(mkdir closed)
AT_DATA(closed/read-permissions, [
pattern "*"
allow "tester@test.net"
])
AT_DATA(closed/write-permissions, [
tester@test.net
])

AT_CHECK(cp clean.db test.db)
AT_CHECK(rm -r keys && cp -r clean_keys/ keys)
AT_DATA(_MTN/revision [])

ADD_N_FILE(2, testfile, [testfile
])
AT_CHECK(MTN --branch=testbranch commit --message testfile, [], [ignore], [ignore])
BASE=`BASE_REVISION`

MINHOOKS_NETSYNC_SERVE_START(testbranch --confdir closed)

# anonymous pull fails

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull --key="", testbranch, [1])
AT_CHECK(MTN2 automate get_revision $BASE, [1], [stdout], [stderr])

# pull with default key

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull, testbranch)
AT_CHECK(MTN2 automate get_revision $BASE, [0], [stdout], [stderr])

# pull with bad branch fails

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull, badbranch, 1)
AT_CHECK(MTN2 automate get_revision $BASE, [1], [stdout], [stderr])

# pull with other key fails

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
NETSYNC_CLIENT_RUN(pull --key=$OTHER, testbranch, [1])
AT_CHECK(MTN2 automate get_revision $BASE, [1], [stdout], [stderr])

# pull with unknown key fails

AT_CHECK(cp clean.db test2.db)
AT_CHECK(rm -r keys2 && cp -r clean_keys/ keys2)
UNKNOWN=unknown@test.net
AT_CHECK((echo $UNKNOWN; echo $UNKNOWN) | MTN2 genkey $UNKNOWN, [], [ignore], [ignore])
NETSYNC_CLIENT_RUN(pull --key=$UNKNOWN, testbranch, [1])
AT_CHECK(MTN2 automate get_revision $BASE, [1], [stdout], [stderr])

# push with default key

AT_CHECK(cp test.db test2.db)
AT_CHECK(rm -r keys2 && cp -r keys/ keys2)
REVERT_N_TO(2, $BASE)
ADD_N_FILE(2, default, [default
])
AT_CHECK(MTN2 commit --message default, [], [ignore], [ignore])
DEFAULT_REV=`BASE_REVISION`
NETSYNC_CLIENT_RUN(push, testbranch)

# push with other key

REVERT_N_TO(2, $BASE)
ADD_N_FILE(2, other, [other
])
AT_CHECK(MTN2 commit --message other, [], [ignore], [ignore])
OTHER_REV=`BASE_REVISION`
NETSYNC_CLIENT_RUN(push --key=$OTHER, testbranch, [1])

# push with unknown key fails

REVERT_N_TO(2, $BASE)
ADD_N_FILE(2, unknown, [unknown
])
AT_CHECK(MTN2 commit --message unknown, [], [ignore], [ignore])
UNKNOWN_REV=`BASE_REVISION`
AT_CHECK((echo $UNKNOWN; echo $UNKNOWN) | MTN2 genkey $UNKNOWN, [], [ignore], [ignore])
NETSYNC_CLIENT_RUN(push --key=$UNKNOWN, testbranch, [1])

NETSYNC_SERVE_STOP

AT_CHECK(MTN automate get_revision $DEFAULT_REV, [0], [stdout], [stderr])
AT_CHECK(MTN automate get_revision $OTHER_REV, [1], [stdout], [stderr])
AT_CHECK(MTN automate get_revision $UNKNOWN_REV, [1], [stdout], [stderr])

AT_CLEANUP
