#  -*- Autoconf -*-

AT_SETUP([CVS push with fork and merge])

MONOTONE_SETUP

AT_DATA(d_a, [A
])
AT_DATA(d_b, [B
])
AT_DATA(d_c, [C
])

# build the cvs repository

CVSROOT=`pwd`/cvs-repository
AT_CHECK(cvs -q -d $CVSROOT init)
AT_CHECK(test -e $CVSROOT)
AT_CHECK(test -e $CVSROOT/CVSROOT)
AT_CHECK(test -e $CVSROOT/CVSROOT/history)

# import a test project

AT_CHECK(mkdir cvstemp)
AT_CHECK(cp d_a cvstemp/A)
AT_CHECK(cp d_b cvstemp/B)
AT_CHECK([cd cvstemp ; cvs -q -d $CVSROOT import -m 'initial import' test vendor_tag initial_import], [], [ignore], [ignore])

# change the repository in various ways

AT_CHECK([cvs -q -d $CVSROOT co test], [], [ignore], [ignore])
AT_CHECK([cd test;MONOTONE --root . --branch testbranch cvs_takeover test], [0], [ignore], [ignore])
AT_CHECK([cp -r test test2])

AT_CHECK([cd test;MONOTONE drop A;MONOTONE ci -m "a dropped"], [0], [ignore], [ignore])
LEFT=`MONOTONE automate heads`

AT_CHECK([cp d_c test2/C])
AT_CHECK([cd test2;MONOTONE add C;MONOTONE ci -m "c added"], [0], [ignore], [ignore])

AT_CHECK(MONOTONE merge, [0], [ignore], [ignore])
AT_CHECK(MONOTONE --branch testbranch cvs_push, [0], [ignore], [ignore])

# no change yet
AT_CHECK(test -e $CVSROOT/test/A)
AT_CHECK(test ! -e $CVSROOT/test/C)

AT_CHECK(MONOTONE --revision $LEFT --branch testbranch cvs_push, [0], [ignore], [ignore])
AT_CHECK(test -e $CVSROOT/test/Attic/A)
AT_CHECK(test -e $CVSROOT/test/C)

# I refrain to test file contents

AT_CLEANUP
