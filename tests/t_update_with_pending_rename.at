#  -*- Autoconf -*-

AT_SETUP([update with pending rename])

MTN_SETUP

ADD_FILE(file, [test1
])

COMMIT(testbranch)

AT_CHECK(MTN --branch testbranch co codir, [], [ignore], [ignore])

AT_CHECK(mv file file2, [], [ignore], [ignore])
AT_CHECK(MTN rename file file2, [], [ignore], [ignore])

COMMIT(testbranch)

REV=`BASE_REVISION`

AT_CHECK(mv codir/file codir/file2, [], [ignore], [ignore])
AT_CHECK(cd codir && MTN rename file file2, [], [ignore], [ignore])
AT_CHECK(cd codir && MTN update, [], [ignore], [ignore])

AT_CHECK(cd codir && MTN automate get_revision $REV, [], [ignore], [ignore])

# make sure there are no changes in the workspace

AT_CHECK(test ! -e codir/_MTN/work, [], [ignore], [ignore])
AT_CHECK(cd codir && MTN diff, [], [stdout], [ignore])
AT_CHECK(grep 'no changes' stdout, [], [ignore], [ignore])

AT_CLEANUP
