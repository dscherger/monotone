AT_SETUP([db check and non-serious errors])
MONOTONE_SETUP

# Make sure that db check detects minor problems, but doesn't complain
# about them too loudly (and doesn't exit with error status).

AT_DATA(fileX, [blah blah
])
AT_DATA(fileY, [stuff stuff
])

ADD_FILE(testfile, [more stuff
])
COMMIT(testbranch)
REV=`BASE_REVISION`

AT_CHECK(MONOTONE cert $REV author extra_author, [], [ignore], [ignore])

# if we drop the file, we'll have a roster that doesn't
# reference its own revision. 
# we can then remove the revision to end up with a clean unreferenced roster.
AT_CHECK(MONOTONE drop testfile, [], [ignore], [ignore])
AT_CHECK(MONOTONE commit -m "goingaway", [], [ignore], [ignore])
DEL_REV=`BASE_REVISION`
AT_CHECK(MONOTONE db execute "delete from revisions where id = '$DEL_REV'", [], [ignore], [ignore])
AT_CHECK(MONOTONE db execute "delete from revision_certs where id = '$DEL_REV'", [], [ignore], [ignore])
AT_CHECK(MONOTONE db execute "delete from revision_ancestry where child = '$DEL_REV'", [], [ignore], [ignore])

# and also a few unused files shall float about
AT_CHECK(MONOTONE fload < fileX, [], [ignore], [ignore])
AT_CHECK(MONOTONE fload < fileY, [], [ignore], [ignore])

AT_CHECK(MONOTONE db check, [], [ignore], [stderr])

AT_CHECK(QGREP('problems detected: 5' stderr))
AT_CHECK(QGREP('0 serious' stderr))
AT_CHECK(QGREP('minor problems detected' stderr))

AT_CLEANUP
