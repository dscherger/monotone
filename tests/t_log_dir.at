AT_SETUP([log dir])
MTN_SETUP

# This test is a bug report
# log dir -R should only list revisions which change the things in or below dir
# log dir should only list revisions which change dir (note that this does not
# include things that change "ls dir", but only add/drop/rename/attr set on
# the dir itself)

ADD_FILE(foo, [foo
])
ADD_FILE(bar, [bar
])

COMMIT(testbranch)
REV1=`BASE_REVISION`

AT_CHECK(mkdir dir1 dir2)
ADD_FILE(dir1/file1, [dir1/file1
])

COMMIT(testbranch)
REV2=`BASE_REVISION`

ADD_FILE(dir2/file2, [dir2/file2
])

COMMIT(testbranch)
REV3=`BASE_REVISION`

AT_DATA(foo, [foofoo
])
AT_DATA(bar, [barbar
])
AT_DATA(dir1/file1, [dir1/file1 asdf
])
AT_DATA(dir2/file2, [dir2/file2 asdf
])

COMMIT(testbranch)
REV4=`BASE_REVISION`

AT_DATA(dir1/file1, [dir1/file1 asdf asdf
])

COMMIT(testbranch)
REV5=`BASE_REVISION`

AT_DATA(dir2/file2, [dir2/file2 asdf asdf
])

COMMIT(testbranch)
REV6=`BASE_REVISION`

AT_CHECK(MTN attr set dir2/ myattr myval, [], [ignore], [ignore])
COMMIT(testbranch)
REV7=`BASE_REVISION`

# commented out tests below currently fail but they *should* pass (I think)

AT_CHECK(MTN log, [], [stdout], [ignore])

AT_CHECK(grep "^Revision: $REV1" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV2" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV3" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV4" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV5" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV6" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV7" stdout, [0], [ignore], [ignore])

AT_CHECK(MTN log ., [], [stdout], [ignore])

AT_CHECK(grep "^Revision: $REV1" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV2" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV3" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV4" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV5" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV6" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV7" stdout, [1], [ignore], [ignore])

AT_CHECK(MTN log . -R, [], [stdout], [ignore])

AT_CHECK(grep "^Revision: $REV1" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV2" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV3" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV4" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV5" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV6" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV7" stdout, [0], [ignore], [ignore])

AT_CHECK(MTN log dir1 -R, [], [stdout], [ignore])

AT_CHECK(grep "^Revision: $REV1" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV2" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV3" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV4" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV5" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV6" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV7" stdout, [1], [ignore], [ignore])

AT_CHECK(MTN log dir2 -R, [], [stdout], [ignore])

AT_CHECK(grep "^Revision: $REV1" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV2" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV3" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV4" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV5" stdout, [1], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV6" stdout, [0], [ignore], [ignore])
AT_CHECK(grep "^Revision: $REV7" stdout, [0], [ignore], [ignore])

AT_CLEANUP
