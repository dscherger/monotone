#  -*- Autoconf -*-

AT_SETUP([exchanging work via netsync, with notes])
AT_KEYWORDS([netsync])

MTN_SETUP
NETSYNC_SETUP_WITH_NOTES

# Checking the effect of a new revisions
AT_DATA(testfile, [version 0 of test file
])
AT_CHECK(MTN add testfile, [], [ignore], [ignore])
AT_CHECK(MTN --branch=testbranch commit --message blah-blah, [], [ignore], [ignore])
F_VER0=`SHA1(testfile)`
VER0=`BASE_REVISION`
MAN0=`BASE_MANIFEST`
DATE0=`CERTVALUE([$VER0],[date])`

AT_DATA(testfile, [version 1 of test file
])
AT_CHECK(MTN commit --message blah-blah, [], [ignore], [ignore])
F_VER1=`SHA1(testfile)`
VER1=`BASE_REVISION`
MAN1=`BASE_MANIFEST`
DATE1=`CERTVALUE([$VER1],[date])`

RUN_NETSYNC(pull, testbranch)

DATA(testnotes.test,
[start ---------------------------------------------------
revision: new_id    = $VER0
revision: revision  = format_version "1"

new_manifest m4_dquote($MAN0)

old_revision m4_dquote([])

add_dir ""

add_file "testfile"
 content m4_dquote($F_VER0)

revision: cert.name  = branch
revision: cert.value = testbranch
revision: cert.key   = tester@test.net
revision: cert.name  = changelog
revision: cert.value = blah-blah
revision: cert.key   = tester@test.net
revision: cert.name  = date
revision: cert.value = $DATE0
revision: cert.key   = tester@test.net
revision: cert.name  = author
revision: cert.value = tester@test.net
revision: cert.key   = tester@test.net
revision: new_id    = $VER1
revision: revision  = format_version "1"

new_manifest m4_dquote($MAN1)

old_revision m4_dquote($VER0)

patch "testfile"
 from m4_dquote($F_VER0)
   to m4_dquote($F_VER1)

revision: cert.name  = branch
revision: cert.value = testbranch
revision: cert.key   = tester@test.net
revision: cert.name  = changelog
revision: cert.value = blah-blah
revision: cert.key   = tester@test.net
revision: cert.name  = date
revision: cert.value = $DATE1
revision: cert.key   = tester@test.net
revision: cert.name  = author
revision: cert.value = tester@test.net
revision: cert.key   = tester@test.net
end -----------------------------------------------------
])
CANONICALISE(testnotes.log)
AT_CHECK(cmp testnotes.log testnotes.test, [0], [ignore], [ignore])

# Checking the effect of a simple cert change
AT_CHECK(MTN tag $VER0 testtag, [], [ignore], [ignore])

RUN_NETSYNC(pull, testbranch)

DATA(testnotes.test,
[start ---------------------------------------------------
cert: rev_id = $VER0
cert: name   = tag
cert: value  = testtag
cert: key    = tester@test.net
end -----------------------------------------------------
])
CANONICALISE(testnotes.log)
AT_CHECK(cmp testnotes.log testnotes.test, [0], [ignore], [ignore])

# Checking that a netsyn with nothing new will not trigger the
# note_netsync hooks
AT_CHECK(rm testnotes.log testnotes.test)
RUN_NETSYNC(pull, testbranch)

AT_CHECK([test -f testnotes.log], [1])

AT_CLEANUP
