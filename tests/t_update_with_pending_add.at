#  -*- Autoconf -*-

AT_SETUP([update with pending add])

MONOTONE_SETUP

# this test is a bug report. the problem seems to be that update with a pending
# add doesn't remove the pending add from MT/work if the file is also added
# in the selected revision.
#
# as a side note, for some reason cat revision doesn't seem to work with an
# abbreviated revision id. this seems like it might be a problem with autotest
# or something, or possibly even (gasp) pilot error! ;)

AT_XFAIL_IF(true)

ADD_FILE(file, [file
])

COMMIT(testbranch)

AT_CHECK(MONOTONE --branch testbranch co codir, [], [ignore], [ignore])

ADD_FILE(file2, [file2
])

COMMIT(testbranch)

AT_DATA(codir/file2, [file2
])

AT_CHECK(cd codir && MONOTONE add file2, [], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE update, [], [ignore], [ignore])

# why doesn't an abbreviated revision id work
AT_CHECK(cd codir && MONOTONE cat revision b482, [1], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE cat revision b482c907f27f160f7ff9259d353d5d5399fb9fc4, [], [ignore], [ignore])

AT_CHECK(cd codir && MONOTONE cat manifest 1ff6, [], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE cat manifest 3eff, [], [ignore], [ignore])

AT_CHECK(cat codir/MT/work, [], [ignore], [ignore])
AT_CHECK(cat codir/MT/revision, [], [ignore], [ignore])

# the working copy is now in a somewhat bad state. the revision it is based on
# has file2 in the manifest, but MT/work still contains add_file
# "file2". pending rearrangements, need to be resolved by update

AT_CHECK(cd codir && MONOTONE cat revision, [3], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE cat manifest, [3], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE status, [3], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE ls unknown, [3], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE ls ignored, [3], [ignore], [ignore])
AT_CHECK(cd codir && MONOTONE ls missing, [3], [ignore], [ignore])

AT_CHECK(false)

AT_CLEANUP
