#  -*- Autoconf -*-

AT_SETUP([revert file to base version])

MONOTONE_SETUP

AT_DATA(testfile0, [version 0 of first test file
])

AT_CHECK(MONOTONE add testfile0, [], [ignore])
V1=`SHA1(testfile0)`
AT_CHECK(MONOTONE --branch=testbranch commit 'blah blah', [], [ignore])

# check reverting a single file by name

AT_DATA(testfile0, [squirrils monkeys dingos
])

AT_CHECK(grep squirrils testfile0, [0], [ignore])
AT_CHECK(MONOTONE revert testfile0, [], [ignore])
AT_CHECK(grep squirrils testfile0, [1], [ignore])
V2=`SHA1(testfile0)`
AT_CHECK(test $V1 == $V2)


# check reverting the whole tree

AT_DATA(testfile0, [squirrils monkeys dingos
])
AT_CHECK(MONOTONE status, [], [stdout])
AT_CHECK(grep testfile0 stdout, [0], [ignore])
AT_CHECK(MONOTONE revert, [], [ignore])
AT_CHECK(test ! -e MT/work, [], [ignore])
AT_CHECK(MONOTONE status, [], [stdout])
AT_CHECK(grep testfile0 stdout, [1], [ignore])


# check reverting a delete

AT_CHECK(MONOTONE drop testfile0, [0], [ignore])
AT_CHECK(grep testfile0 MT/work, [0], [ignore])
AT_CHECK(MONOTONE status, [], [stdout])
AT_CHECK(grep testfile0 stdout, [0], [ignore])
AT_CHECK(MONOTONE revert, [], [ignore])
AT_CHECK(test ! -e MT/work, [], [ignore])
AT_CHECK(MONOTONE status, [], [stdout])
AT_CHECK(grep testfile0 stdout, [1], [ignore])


# check reverting an add

AT_DATA(testfile1, [squirrils monkeys dingos
])
AT_CHECK(MONOTONE add testfile1, [0], [ignore])
AT_CHECK(grep testfile1 MT/work, [0], [ignore])
AT_CHECK(MONOTONE status, [], [stdout])
AT_CHECK(grep testfile1 stdout, [0], [ignore])
AT_CHECK(MONOTONE revert, [], [ignore])
AT_CHECK(test ! -e MT/work, [], [ignore])
AT_CHECK(MONOTONE status, [], [stdout])
AT_CHECK(grep testfile1 stdout, [1], [ignore])


AT_CLEANUP
