#  -*- Autoconf -*-

AT_SETUP([creating a fork])

MONOTONE_SETUP


AT_DATA(testfile, [version 0 of test file
])

AT_CHECK(MONOTONE add testfile, [], [ignore])
AT_CHECK(MONOTONE --branch=testbranch commit blah-blah, [], [ignore])
ROOT_M_SHA=`SHA1(MT/manifest)`
ROOT_F_SHA=`SHA1(testfile)`

AT_DATA(testfile, [left version of fork
])
AT_CHECK(MONOTONE add testfile, [], [ignore])
AT_CHECK(MONOTONE commit blah-blah, [], [ignore])
LEFT_M_SHA=`SHA1(MT/manifest)`
LEFT_F_SHA=`SHA1(testfile)`
AT_CHECK(test $LEFT_M_SHA != $ROOT_M_SHA)
AT_CHECK(test $LEFT_F_SHA != $ROOT_F_SHA)

AT_CHECK(MONOTONE --branch=testbranch heads, [], [stdout])
AT_CHECK(grep empty stdout, [1], [ignore])

PROBE_NODE(testfile, $ROOT_M_SHA, $ROOT_F_SHA)

AT_DATA(testfile, [right version of fork
])
AT_CHECK(MONOTONE add testfile, [], [ignore])
AT_CHECK(MONOTONE commit blah-blah, [], [ignore])
RIGHT_M_SHA=`SHA1(MT/manifest)`
RIGHT_F_SHA=`SHA1(testfile)`
AT_CHECK(test $RIGHT_M_SHA != $ROOT_M_SHA)
AT_CHECK(test $RIGHT_F_SHA != $ROOT_F_SHA)
AT_CHECK(test $RIGHT_M_SHA != $LEFT_M_SHA)
AT_CHECK(test $RIGHT_F_SHA != $LEFT_F_SHA)

# fork committed ok. now check to make sure
# all 3 nodes are reconstructable

PROBE_NODE(testfile, $ROOT_M_SHA, $ROOT_F_SHA)
PROBE_NODE(testfile, $LEFT_M_SHA, $LEFT_F_SHA)
PROBE_NODE(testfile, $RIGHT_M_SHA, $RIGHT_F_SHA)

AT_CLEANUP
