#  -*- Autoconf -*-

AT_SETUP([automate get_manifest_of])
NEED_UNB64
MTN_SETUP

AT_DATA(expected, [format_version "1"

dir ""

   file "foo"
content @<:@4cbd040533a2f43fc6691d773d510cda70f4126a@:>@
])

AT_DATA(expected2, [format_version "1"

dir ""

   file "foo"
content @<:@9fd2be4badf713d640ae46bf4547d1549654dfe5@:>@
])

AT_DATA(empty, [])

ADD_FILE(foo, [blah
])
AT_CHECK(MTN commit --date=2005-05-21T12:30:51 --branch=testbranch --message=blah-blah, [], [ignore], [ignore])
BASE_R=`BASE_REVISION`

# check that a correct usage produces correctly formatted output
AT_CHECK(MTN automate get_manifest_of $BASE_R, [], [stdout], [ignore])
AT_CHECK(CANONICALISE(stdout))
AT_CHECK(cmp expected stdout)

# should work even if we don't specify the manifest ID
AT_CHECK(MTN automate get_manifest_of, [], [stdout], [ignore])
AT_CHECK(CANONICALISE(stdout))
AT_CHECK(cmp expected stdout)

# ensure that missing revisions fail
NOSUCHREV=0000000000000000000000000000000000000000
AT_CHECK(MTN automate get_manifest_of $NOSUCHREV, [1], [stdout], [ignore])
AT_CHECK(CANONICALISE(stdout))
AT_CHECK(cmp empty stdout)

# ensure that revisions are not being completed
# (the above commit will have created rev 3cf83369cfadbf5ba4ea3a50796fba18ec245489)
TRUNCATEDREV=3cf83369cfadbf5ba4ea3a50796fba18ec2454
AT_CHECK(MTN automate get_revision $TRUNCATEDREV, [1], [stdout], [ignore])
AT_CHECK(CANONICALISE(stdout))
AT_CHECK(cmp empty stdout)

# check that modified working copy manifest is correct
AT_DATA(foo, [bla bla
])        
AT_CHECK(MONOTONE automate get_manifest_of, [], [stdout], [ignore])
AT_CHECK(CANONICALISE(stdout))
AT_CHECK(cmp expected2 stdout)

AT_CLEANUP
