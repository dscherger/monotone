#  -*- Autoconf -*-

AT_SETUP([multiple version committing])

MONOTONE_SETUP

AT_DATA(testfile, [version 0 of the file
])
AT_CHECK(MONOTONE add testfile, [], [ignore], [ignore])
AT_CHECK(MONOTONE --branch=testbranch commit blah-blah, [], [ignore], [ignore])

for i in 1 2 3 4 5 6
do
  AT_CHECK(echo "version $i of the file", [], [stdout])
  AT_CHECK(mv stdout testfile)
  AT_CHECK(MONOTONE --branch=testbranch commit blah-blah, [], [ignore], [ignore])
  AT_CHECK(SHA1(testfile), [], [stdout])
  AT_CHECK(mv stdout fsha-$i, [], [ignore])
  AT_CHECK(SHA1(MT/manifest), [], [stdout])
  AT_CHECK(mv stdout msha-$i, [], [ignore])
done

for i in 1 2 3 4 5 6
do
  AT_CHECK(echo "version $i of the file", [], [stdout])
  AT_CHECK(mv stdout testfile)

  MSHA=`cat msha-$i`
  FSHA=`cat fsha-$i`

  AT_CHECK(MONOTONE cat file $FSHA, [], [stdout])
  AT_CHECK(cmp stdout testfile, [], [ignore])

  AT_CHECK(MONOTONE checkout $MSHA ., [], [stdout])
  AT_CHECK(SHA1(testfile), [], [stdout])
  AT_CHECK(cmp stdout fsha-$i, [], [ignore])  

done

AT_CLEANUP
