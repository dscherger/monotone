AT_SETUP([repeatedly exchanging work via netsync])
AT_KEYWORDS([netsync])

MTN_SETUP
NETSYNC_SETUP

ADD_FILE(testfile, [version 0 data
])
COMMIT(testbranch)
VER0=`BASE_REVISION`

RUN_NETSYNC(pull, testbranch)

ADD_FILE(testfile2, [some data
])
COMMIT(testbranch)
VER1=`BASE_REVISION`

REVERT_TO($VER0)

SET_FILE(testfile, [version 1 data
])
COMMIT(testbranch)
VER2=`BASE_REVISION`

AT_CHECK(MTN --branch=testbranch merge, [], [ignore], [ignore])
AT_CHECK(MTN update, [], [ignore], [ignore])
VER3=`BASE_REVISION`

RUN_NETSYNC(pull, testbranch)

CHECK_SAME_STDOUT(MTN automate graph, MTN2 automate graph)

CHECK_SAME_STDOUT(MTN ls certs $VER1, MTN2 ls certs $VER1)
CHECK_SAME_STDOUT(MTN ls certs $VER2, MTN2 ls certs $VER2)
CHECK_SAME_STDOUT(MTN ls certs $VER3, MTN2 ls certs $VER3)

AT_CLEANUP
