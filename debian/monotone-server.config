#! /bin/sh
# vim: set ft=sh sw=4 et:
# postinst script for monotone-server
#
# see: dh_installdeb(1)

set -e

# source debconf stuff
. /usr/share/debconf/confmodule

# we only want to change these values on the initial configuration

gen_pass ()
    {
    # this algorithm was taken from the advanced bash scripting howto
    MATRIX="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"

    LENGTH="$1"
    if [ -z "$LENGTH" ]; then
        LENGTH=8
    fi
    
    PASS=""
    n=1
    while [ "$n" -le "$LENGTH" ]; do
        PASS="$PASS${MATRIX:$(($RANDOM%${#MATRIX})):1}"
        let n+=1
    done
    }

case "$1" in
    configure)
        # set the default monotone keyname
        db_set monotone-server/key `hostname --fqdn`

        db_input medium monotone-server/manage-db || true
        db_go || true

        # make sure we should manage things
        db_get monotone_server/manage
        if [ "$RET" = false ]; then
            exit 0
        fi

        db_input medium monotone-server/purge-db || true
        db_go || true

        db_input low monotone-server/key || true
        db_input medium monotone-server/passphrase || true
        db_go || true

        # no passphrase was entered, generate one
        # make sure this is the initial configuration
        db_get monotone-server/passphrase
        if [ -z "$RET" ] && [ -z "$2" ]; then
            gen_pass
            db_set monotone-server/passphrase "$PASS"
        fi
    ;;
    reconfigure)
    ;;
    *)
        echo "config called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

